<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Calculadora Cidadão com Extrator PDF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .btn-voltar {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1030;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f6f9;
        }

        .container {
            max-width: 900px;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        /* Estilo dos Cards */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            font-weight: 700;
            color: #2c3e50;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
        }

        /* Área de Upload */
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.3s ease;
        }

        .upload-area:hover,
        .upload-area.hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        #pdf-upload {
            display: none;
        }

        /* Lista de Empréstimos Encontrados */
        .loan-item {
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            background: white;
        }

        .loan-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            border-color: #3498db;
        }

        .loan-bank {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .loan-values {
            color: #27ae60;
            font-weight: 600;
        }

        .loan-badge {
            font-size: 0.8em;
            background-color: #eef2f7;
            color: #555;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Calculadora */
        .calc-input-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
        }

        .form-control {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
        }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        /* Campo Calculado (Resultado) */
        .calculated-field {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: bold;
        }

        .btn-calcular {
            background-color: #27ae60;
            border: none;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-calcular:hover {
            background-color: #219150;
        }

        /* Resultado Texto (Estilo do Print) */
        #resultadoTexto {
            font-size: 1.1em;
            color: #333;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #27ae60;
            margin-top: 20px;
            display: none;
        }

        /* Estilo das Abas */
        .nav-tabs .nav-link {
            color: #495057;
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }

        li {
            list-style-type: none;
        }
    </style>
</head>

<body>
    <a href="/index.html" class="btn btn-secondary btn-voltar">← Voltar</a>
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastBody"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="text-center mb-4" style="color: #2c3e50;">Calculadora do Cidadão Integrada</h2>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>1. Importar Dados</span>
                <span class="badge bg-secondary" id="convenio-badge">Aguardando Arquivo</span>
            </div>
            <div class="card-body">

                <ul class="nav nav-tabs mb-3" id="importTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf-tab-pane"
                            type="button" role="tab">Carregar Extrato PDF</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sobre-tab" data-bs-toggle="tab" data-bs-target="#sobre-tab-pane"
                            type="button" role="tab">Sobre a Ferramenta</button>
                    </li>
                </ul>

                <div class="tab-content" id="importTabContent">

                    <div class="tab-pane fade show active" id="pdf-tab-pane" role="tabpanel">
                        <input type="file" id="pdf-upload" accept=".pdf">
                        <label for="pdf-upload" class="upload-area w-100" id="upload-label">
                            <div id="upload-text">
                                <h5 class="mb-2">Clique ou arraste o PDF aqui</h5>
                                <p class="text-muted small mb-0">Suporta Extratos do: <li>Exercito</li>
                                    <li>SIAPE</li> (Texto ou OCR)
                                </p>
                            </div>
                            <div id="loading" class="d-none align-items-center justify-content-center">
                                <div class="spinner-border text-primary" role="status"
                                    style="width: 2rem; height: 2rem;"></div>
                                <strong class="ms-3 fs-5" id="loading-text">Processando...</strong>
                            </div>
                        </label>

                        <div id="listaEmprestimos" class="mt-4"></div>
                    </div>

                    <div class="tab-pane fade p-3" id="sobre-tab-pane" role="tabpanel">
                        <h5 class="text-primary">Como funciona?</h5>
                        <p>Esta ferramenta combina duas tecnologias poderosas:</p>
                        <ol>
                            <li><strong>Leitura Inteligente de PDF:</strong> Utiliza algoritmos avançados (Regex e OCR
                                Tesseract) para ler extratos do <strong>SIAPE</strong> e <strong>Exército
                                    (eConsig)</strong>, identificando automaticamente bancos, parcelas e saldos
                                aproximados.</li>
                            <li><strong>Matemática Financeira Oficial:</strong> Aplica a mesma lógica da <em>Calculadora
                                    do Cidadão</em> do Banco Central (Sistema Price) para calcular taxas de juros reais,
                                prazos remanescentes ou valores financiados.</li>
                        </ol>
                        <div class="alert alert-light border">
                            <strong>Dica:</strong> Clique em qualquer contrato identificado na lista para preencher
                            automaticamente a calculadora abaixo e conferir se a taxa de juros cobrada está correta.
                        </div>
                        <small class="text-muted">Os dados são processados localmente no seu navegador. Nenhum arquivo é
                            enviado para servidores externos.</small>
                    </div>

                </div>

                <select id="convenioSelect" style="display:none;">
                    <option value="exercito">Exército</option>
                    <option value="siape">SIAPE</option>
                </select>
                <select id="operacaoSelect" style="display:none;">
                    <option value="padrao">Padrão</option>
                </select>
            </div>
        </div>

        <form id="calcForm">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    2. Calculadora do Cidadão (Prestações Fixas)
                </div>
                <div class="card-body">
                    <div class="alert alert-info py-2 mb-4">
                        <small><i class="bi bi-info-circle"></i> Preencha 3 campos e deixe <strong>1 vazio</strong> para
                            descobrir o valor dele. Se você clicou em um empréstimo acima, o prazo e a prestação já
                            foram preenchidos.</small>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6 calc-input-group">
                            <label for="meses">Nº de meses (n)</label>
                            <input type="number" class="form-control" id="meses" placeholder="Ex: 96">
                        </div>
                        <div class="col-md-6 calc-input-group">
                            <label for="taxa">Taxa de juros mensal % (i)</label>
                            <input type="text" class="form-control" id="taxa" placeholder="Ex: 1,50">
                        </div>
                        <div class="col-md-6 calc-input-group">
                            <label for="prestacao">Valor da prestação (PMT)</label>
                            <input type="text" class="form-control" id="prestacao" placeholder="R$ 0,00">
                        </div>
                        <div class="col-md-6 calc-input-group">
                            <label for="valorFinanciado">Valor financiado / Saldo Devedor (PV)</label>
                            <input type="text" class="form-control" id="valorFinanciado" placeholder="R$ 0,00">
                        </div>
                    </div>

                    <div id="resultadoTexto" class="text-center fw-bold"></div>
                </div>
                <div class="card-footer d-flex justify-content-between bg-white">
                    <button type="button" class="btn btn-outline-secondary"
                        onclick="limparCalculadora()">Limpar</button>
                    <button type="submit" class="btn btn-success btn-calcular">Calcular</button>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js'></script>
    <script>
        // Configuração do Worker do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // --- 1. DADOS INTELIGENTES (NOVIDADE QUE VOCÊ GOSTOU) ---
        const TAXAS_HISTORICAS = {
            2026: 1.72,
            2025: 1.76,
            2024: 1.68,
            2023: 1.91,
            2022: 2.14, // Ouro
            2021: 1.80,
            2020: 1.80,
            'padrao': 1.80
        };

        // --- 2. UTILITÁRIOS ---
        const moedaParaFloat = (v) => parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        const formatarMoeda = (v) => (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const formatarDecimal = (v) => (v || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function showToast(msg, type = 'primary') {
            const toastEl = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastBody');
            toastEl.className = `toast align-items-center text-white bg-${type === 'danger' ? 'danger' : (type === 'warning' ? 'warning' : 'success')} border-0`;
            toastBody.textContent = msg;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // --- 3. LÓGICA DE EXTRAÇÃO (RESTAURADA A VERSÃO ROBUSTA) ---

        // Função auxiliar para criar o HTML do card (Adaptada para a nova calculadora)
        function criarCardEmprestimo(banco, valor, restantes, total, id) {
            const pagas = total - restantes; // Calcula pagas
            return `
            <div class="loan-item d-flex justify-content-between align-items-center" 
                 onclick="preencherCalculadora(${restantes}, ${valor}, ${pagas}, ${total})">
                <div>
                    <div class="loan-bank">${banco}</div>
                    <div class="loan-values">Parcela: ${formatarMoeda(valor)}</div>
                </div>
                <div class="text-end">
                    <span class="loan-badge mb-1 d-inline-block bg-primary text-white">Restam: ${restantes}x</span><br>
                    <small class="text-muted">Pagas: ${pagas}/${total}</small>
                </div>
            </div>`;
        }

        async function parsearPdf(event) {
            const file = event.target.files[0]; if (!file) return;

            // UI Loading
            const loadingDiv = document.getElementById("loading");
            const loadingText = document.getElementById("loading-text");
            loadingText.textContent = 'Analisando PDF...';
            loadingDiv.classList.remove('d-none'); loadingDiv.classList.add('d-flex');
            document.getElementById('upload-text').style.display = 'none';
            document.getElementById('listaEmprestimos').innerHTML = '';

            const fileReader = new FileReader();
            fileReader.onload = async function () {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let extractedText = '';
                    let textFound = false;

                    // Tenta ler texto selecionável (Rápido)
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        if (textContent.items.length > 0) textFound = true;
                        extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n';
                    }

                    // Validação: Se não achou texto útil, ativa OCR
                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNATÁRIA') ||
                        extractedText.toUpperCase().includes('EMPRÉSTIMO') ||
                        extractedText.toUpperCase().includes('CPF');

                    if (!textFound || (extractedText.trim().length > 0 && !hasRealData)) {
                        console.log("Texto não reconhecido. Iniciando OCR...");
                        loadingText.textContent = 'Lendo Imagem (OCR)... Isso pode demorar.';
                        extractedText = '';

                        // Inicialização Segura do Tesseract
                        if (typeof Tesseract !== 'undefined') {
                            const worker = await Tesseract.createWorker('por');
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 2.0 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height; canvas.width = viewport.width;
                                await page.render({ canvasContext: context, viewport: viewport }).promise;

                                const { data: { text } } = await worker.recognize(canvas);
                                extractedText += text + '\n\n';
                            }
                            await worker.terminate();
                        } else {
                            throw new Error("Biblioteca OCR não carregada.");
                        }
                    }

                    // Limpeza básica do texto
                    let cleanText = extractedText.replace(/--- FIM DA PÁGINA \d+ ---/g, '');

                    // Detecção de Convênio
                    if (cleanText.includes("SIAPE") || cleanText.includes("Rubrica") || cleanText.includes("Vigentes")) {
                        document.getElementById('convenio-badge').innerText = "SIAPE";
                        document.getElementById('convenio-badge').className = "badge bg-info";
                        processarPdfSiape(cleanText);
                    } else {
                        document.getElementById('convenio-badge').innerText = "EXÉRCITO";
                        document.getElementById('convenio-badge').className = "badge bg-success";
                        processarPdfExercicio(cleanText);
                    }

                    showToast("Leitura concluída!", "success");

                } catch (error) {
                    console.error(error);
                    showToast(`Erro ao ler PDF: ${error.message}`, "danger");
                } finally {
                    loadingDiv.classList.add('d-none');
                    loadingDiv.classList.remove('d-flex');
                    document.getElementById('upload-text').style.display = 'block';
                }
            };
            fileReader.readAsArrayBuffer(file);
        }

        function processarPdfSiape(text) {
            const listaDiv = document.getElementById("listaEmprestimos");
            let html = '';
            let loansFound = 0;

            // 1. Quebra o texto em linhas limpas (remove espaços vazios)
            const linhas = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // Regex para identificar o prazo (Ex: 03/93 ou 10/96)
            // Aceita formato d/dd, dd/dd, dd/ddd
            const regexPrazo = /^(\d{1,3})\/(\d{2,3})$/;

            // 2. Itera linha por linha
            for (let i = 0; i < linhas.length; i++) {
                const linhaAtual = linhas[i];
                
                // A "Âncora" é o Prazo (geralmente a última informação do bloco)
                const matchPrazo = linhaAtual.match(regexPrazo);

                if (matchPrazo) {
                    const pagas = parseInt(matchPrazo[1]);
                    const total = parseInt(matchPrazo[2]);

                    // Validação básica para não pegar datas (01/2025) confundidas com prazos
                    // Prazos geralmente o total é < 120 (10 anos) ou < 960 (se for muito longo) 
                    // e pagas <= total
                    if (total > 0 && total < 999 && pagas <= total) {
                        
                        // --- BUSCA O VALOR (R$) ---
                        // Olha para as 1 ou 2 linhas IMEDIATAMENTE ANTERIORES
                        let valor = 0;
                        let linhaValorIndex = -1;

                        // Tenta linha i-1 (imediatamente acima) e i-2
                        for (let j = 1; j <= 2; j++) {
                            if (linhas[i-j] && linhas[i-j].includes('R$')) {
                                valor = moedaParaFloat(linhas[i-j]);
                                linhaValorIndex = i - j;
                                break;
                            }
                        }

                        // --- BUSCA O NOME DO BANCO ---
                        // Se achou valor, procura o banco nas 10 linhas acima do valor
                        let nomeBanco = "SIAPE (Banco não detectado)";
                        
                        if (valor > 0) {
                            for (let k = 1; k <= 12; k++) { // Olha até 12 linhas pra cima
                                const linhaCandidata = linhas[linhaValorIndex - k];
                                if (!linhaCandidata) continue;

                                const texto = linhaCandidata.toUpperCase();

                                // Sinais de que é uma linha de Banco/Rubrica
                                // Ex: "34113 - EMPREST BCO OFICIAL - CEF"
                                if (
                                    (texto.includes("EMPREST") || texto.includes("CONSIG") || texto.includes("BCO") || texto.includes("BANCO")) &&
                                    !texto.includes("DATA/HORA") // Evita cabeçalhos
                                ) {
                                    nomeBanco = limparNomeBancoSiape(linhaCandidata);
                                    break;
                                }
                                // Lista de bancos conhecidos (caso não tenha a palavra EMPREST)
                                if (["BRADESCO", "ITAU", "SANTANDER", "CAIXA", "CEF", "BRASIL", "SAFRA", "PAN", "C6", "DAYCOVAL", "FACTA"].some(b => texto.includes(b))) {
                                    nomeBanco = limparNomeBancoSiape(linhaCandidata);
                                    break;
                                }
                            }

                            // --- GERA O CARD ---
                            loansFound++;
                            const restantes = total - pagas;
                            html += criarCardEmprestimo(nomeBanco, valor, restantes, total, loansFound);
                        }
                    }
                }
            }

            if (loansFound === 0) html = '<div class="alert alert-warning">Nenhum contrato encontrado. Verifique se o PDF é um extrato válido do SIAPE.</div>';
            listaDiv.innerHTML = `<h6 class="mb-3 border-bottom pb-2">Contratos SIAPE Encontrados (${loansFound}):</h6>` + html;
        }

        // Função auxiliar para deixar o nome do banco bonito
        function limparNomeBancoSiape(textoCru) {
            // Remove números do início (código da rubrica) ex: "34113 - "
            let limpo = textoCru.replace(/^\d+\s*[-–]\s*/, '');
            
            // Remove palavras comuns inúteis
            limpo = limpo.replace("EMPREST", "").replace("CONSIG", "").replace("BCO", "BANCO").replace("FOLHA", "").trim();
            
            // Mapeia siglas comuns
            if (limpo.includes("CEF")) return "CAIXA ECONÔMICA";
            if (limpo.includes("BB")) return "BANCO DO BRASIL";
            
            // Se ficou muito curto ou vazio, retorna o original
            return limpo.length > 2 ? limpo : textoCru;
        }

        function processarPdfExercicio(text) {
            const listaDiv = document.getElementById("listaEmprestimos");
            let html = '';
            let loansFound = 0;

            // Estratégia Exército: Busca por blocos "Em Andamento"
            const lines = text.split('\n');
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if ((line.includes('Em Andamento') || line.includes('Normal')) && !line.includes('Total')) {
                    // Olha para as linhas próximas para achar valores e prazos
                    const bloco = lines.slice(Math.max(0, i - 5), i + 5).join(' ');

                    // Regex para valor
                    const valorMatch = bloco.match(/R\$\s*([\d.,]+)/);
                    // Regex para prazo "X de Y" ou "X/Y"
                    const prazoMatch = bloco.match(/(\d{1,3})\s*(?:de|\/)\s*(\d{1,3})/);

                    if (valorMatch && prazoMatch) {
                        const valor = moedaParaFloat(valorMatch[1]);
                        const num1 = parseInt(prazoMatch[1]);
                        const num2 = parseInt(prazoMatch[2]);

                        // Lógica para saber qual é pagas e qual é total (Exército as vezes inverte visualmente)
                        let pagas = Math.min(num1, num2); // Geralmente o menor é pagas, a menos que esteja acabando
                        let total = Math.max(num1, num2);

                        // Se no texto diz "restantes", ajusta
                        if (bloco.toLowerCase().includes('restant')) {
                            pagas = total - num1;
                        }

                        const restantes = total - pagas;

                        // Tenta achar nome do banco na linha ou acima
                        let nomeBanco = "Empréstimo Exército";
                        if (lines[i - 3] && lines[i - 3].length > 3) nomeBanco = lines[i - 3].trim();
                        else if (lines[i - 2]) nomeBanco = lines[i - 2].trim();

                        if (valor > 0 && restantes >= 0) {
                            loansFound++;
                            html += criarCardEmprestimo(nomeBanco, valor, restantes, total, loansFound);
                        }
                    }
                }
            }
            if (loansFound === 0) html = '<div class="alert alert-warning">Nenhum contrato legível encontrado.</div>';
            listaDiv.innerHTML = `<h6 class="mb-3 border-bottom pb-2">Contratos Encontrados:</h6>` + html;
        }

        // --- 4. LÓGICA DE CÁLCULO E INTELIGÊNCIA (NOVIDADE MANTIDA) ---

        function estimarTaxaPorData(parcelasPagas) {
            const hoje = new Date();
            const dataInicio = new Date(hoje.setMonth(hoje.getMonth() - parcelasPagas));
            const anoInicio = dataInicio.getFullYear();
            const taxaEstimada = TAXAS_HISTORICAS[anoInicio] || TAXAS_HISTORICAS['padrao'];
            return { ano: anoInicio, taxa: taxaEstimada };
        }

        function preencherCalculadora(restantes, valorParcela, pagas, total) {
            // Preenche campos visuais
            document.getElementById('meses').value = restantes;
            document.getElementById('prestacao').value = formatarMoeda(valorParcela);

            // Inteligência: Define taxa baseada no histórico
            const estimativa = estimarTaxaPorData(pagas);
            document.getElementById('taxa').value = formatarDecimal(estimativa.taxa);

            // Limpa o PV para forçar cálculo de Saldo Devedor
            document.getElementById('valorFinanciado').value = '';

            // Roda o cálculo
            calcularAutomaticamente();

            // Feedback Visual
            const msg = `Contrato iniciado em <strong>${estimativa.ano}</strong> (${pagas} pagas).<br>Taxa Histórica aplicada: <strong>${estimativa.taxa}%</strong>`;
            document.getElementById('resultadoTexto').innerHTML =
                `<div class="text-success"><i class="bi bi-magic"></i> ${msg}</div>`;
            document.getElementById('resultadoTexto').style.display = 'block';

            document.getElementById('calcForm').scrollIntoView({ behavior: 'smooth' });
        }

        function calcularAutomaticamente() {
            document.getElementById('calcForm').dispatchEvent(new Event('submit'));
        }

        // --- 5. MOTOR DE CÁLCULO (PRICE) E UTILITÁRIOS ---

        // Função para limpar (agora funciona corretamente)
        function limparCalculadora() {
            // Lista de IDs dos campos
            const campos = ['meses', 'taxa', 'prestacao', 'valorFinanciado'];

            campos.forEach(id => {
                const element = document.getElementById(id);
                element.value = ''; // Zera o valor
                element.classList.remove('calculated-field', 'is-invalid'); // Remove cores
            });

            // Limpa e esconde o resultado em texto
            const divResultado = document.getElementById('resultadoTexto');
            divResultado.style.display = 'none';
            divResultado.innerHTML = '';

            // Coloca o foco no primeiro campo
            document.getElementById('meses').focus();
        }

        // Listener do Formulário (O Cérebro da Calculadora)
        document.getElementById('calcForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Impede a página de recarregar

            // 1. Limpeza visual antes de começar
            document.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('calculated-field', 'is-invalid');
            });
            document.getElementById('resultadoTexto').style.display = 'none';

            // 2. Coleta e tratamento dos valores
            // Função auxiliar interna para pegar valor limpo
            const getVal = (id) => {
                const val = document.getElementById(id).value;
                if (!val) return null;
                // Se for taxa, aceita vírgula. Se for moeda, limpa R$
                if (id === 'taxa') return parseFloat(val.replace(',', '.'));
                return moedaParaFloat(val);
            };

            const n = document.getElementById('meses').value ? parseInt(document.getElementById('meses').value) : null;
            const i_val = getVal('taxa');
            const pmt = getVal('prestacao');
            const pv = getVal('valorFinanciado');

            // 3. Lógica de decisão: Quem devemos calcular?
            // Contamos quantos campos estão preenchidos
            let preenchidos = 0;
            if (n !== null) preenchidos++;
            if (i_val !== null) preenchidos++;
            if (pmt !== null && pmt !== 0) preenchidos++;
            if (pv !== null && pv !== 0) preenchidos++;

            // Regras de validação
            if (preenchidos === 4) {
                showToast("Atenção: Limpe o campo que você deseja descobrir (deixe vazio).", "warning");
                return;
            }
            if (preenchidos < 3) {
                showToast("Preencha pelo menos 3 campos para calcular o que falta.", "warning");
                return;
            }

            // Identifica o alvo (o campo que está null ou zero)
            let target = '';
            if (n === null) target = 'meses';
            else if (i_val === null) target = 'taxa';
            else if (pmt === null || pmt === 0) target = 'prestacao';
            else if (pv === null || pv === 0) target = 'valorFinanciado';

            let resultado = 0;

            try {
                // --- CÁLCULOS MATEMÁTICOS (SISTEMA PRICE) ---

                // CASO 1: Calcular SALDO DEVEDOR (PV)
                if (target === 'valorFinanciado') {
                    const i = i_val / 100;
                    resultado = pmt * ((1 - Math.pow(1 + i, -n)) / i);
                }

                // CASO 2: Calcular PRESTAÇÃO (PMT)
                else if (target === 'prestacao') {
                    const i = i_val / 100;
                    resultado = pv * (i / (1 - Math.pow(1 + i, -n)));
                }

                // CASO 3: Calcular TAXA (i) - O mais complexo
                else if (target === 'taxa') {
                    // TRAVA DE SEGURANÇA 1: Valor Financiado inválido
                    if (pv <= 0) {
                        showToast("Para calcular a taxa, o Valor Financiado deve ser maior que zero.", "danger");
                        document.getElementById('valorFinanciado').focus();
                        return;
                    }

                    // TRAVA DE SEGURANÇA 2: Juro Zero
                    const totalPago = pmt * n;
                    // Se o total pago for muito próximo do valor financiado (diferença de centavos)
                    if (Math.abs(totalPago - pv) < 1.00) {
                        resultado = 0;
                    } else {
                        // Algoritmo de Newton-Raphson para encontrar a taxa
                        let chute = 0.01; // Começa chutando 1%
                        let erro = 1.0;
                        let iteracoes = 0;

                        while (Math.abs(erro) > 0.000001 && iteracoes < 100) {
                            // Função Price
                            let f = (pmt * (1 - Math.pow(1 + chute, -n)) / chute) - pv;
                            // Derivada da Função Price
                            let df = pmt * ((1 - Math.pow(1 + chute, -n)) / (-chute * chute) + (n * Math.pow(1 + chute, -n - 1)) / chute);

                            let novoChute = chute - (f / df);
                            erro = novoChute - chute;
                            chute = novoChute;
                            iteracoes++;
                        }
                        resultado = chute * 100; // Converte para porcentagem
                    }
                }

                // CASO 4: Calcular PRAZO (n)
                else if (target === 'meses') {
                    const i = i_val / 100;
                    // Fórmula Logarítmica para achar N
                    // n = -ln(1 - (PV * i / PMT)) / ln(1 + i)
                    const argumentoLog = 1 - (pv * i) / pmt;

                    if (argumentoLog <= 0) {
                        showToast("Cálculo impossível com estes valores (parcela muito baixa para pagar os juros).", "danger");
                        return;
                    }
                    resultado = -Math.log(argumentoLog) / Math.log(1 + i);
                }

                // --- EXIBIÇÃO DOS RESULTADOS ---

                const campoInput = document.getElementById(target);
                campoInput.classList.add('calculated-field');

                // Formatação específica para cada tipo
                if (target === 'taxa') {
                    campoInput.value = formatarDecimal(resultado);
                } else if (target === 'meses') {
                    campoInput.value = Math.round(resultado); // Meses são inteiros
                } else {
                    campoInput.value = formatarMoeda(resultado);
                }

                // Monta o texto bonito abaixo
                const divTexto = document.getElementById('resultadoTexto');
                divTexto.style.display = 'block';

                let htmlMsg = '';
                if (target === 'taxa') htmlMsg = `Taxa Real Encontrada: <span class="text-primary fs-5">${formatarDecimal(resultado)}% a.m.</span>`;
                if (target === 'valorFinanciado') htmlMsg = `Saldo Devedor (Quitação): <span class="text-success fs-5">${formatarMoeda(resultado)}</span>`;
                if (target === 'prestacao') htmlMsg = `Valor da Parcela: <span class="text-danger fs-5">${formatarMoeda(resultado)}</span>`;
                if (target === 'meses') htmlMsg = `Prazo Restante: <span class="text-dark fs-5">${Math.round(resultado)} meses</span>`;

                divTexto.innerHTML = htmlMsg;

            } catch (err) {
                console.error(err);
                showToast("Erro matemático. Verifique se os valores fazem sentido.", "danger");
            }
        });

        // Utilitário para formatar decimais (caso não tenha no seu código acima)
        // Se já tiver lá em cima, pode apagar esta linha
        // const formatarDecimal = (v) => (v || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Eventos Drag & Drop
        const uploadArea = document.getElementById('upload-label');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); document.getElementById('pdf-upload').files = e.dataTransfer.files; document.getElementById('pdf-upload').dispatchEvent(new Event('change')); });
        document.getElementById("pdf-upload").addEventListener("change", parsearPdf);

    </script>
</body>

</html>