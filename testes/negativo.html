<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Cliente Negativado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/images/icone.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        .btn-voltar { position: fixed; top: 15px; left: 15px; z-index: 1030; }
        .container { max-width: 700px; margin: 20px auto; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #0d6efd; padding: 30px; text-align: center; cursor: pointer; background-color: #f8f9fa; transition: background-color 0.2s, border-color 0.2s; }
        .upload-area.hover { background-color: #e9ecef; border-color: #0b5ed7; }
        #pdf-upload { display: none; }
        #loading-spinner { width: 1.5rem; height: 1.5rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1090; }
        .toast { width: 350px; max-width: 100%; }
    </style>
</head>
<body>
    <a href="testes.html" class="btn btn-secondary btn-voltar">← Voltar</a>
    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <div class="text-center mb-4">
            <img src="/images/logoheader.png" class="mx-auto" style="max-width:200px;" alt="Logo da Empresa">
            <h1 class="h3 mt-2">Calculadora de Cliente Negativado</h1>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">1. Dados do Cliente e Contratos</h2>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf-tab-pane" type="button" role="tab">Carregar Extrato PDF</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-tab-pane" type="button" role="tab">Inserir Manualmente</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="pdf-tab-pane" role="tabpanel" tabindex="0">
                        <div class="p-3">
                            <input type="file" id="pdf-upload" accept=".pdf">
                            <label for="pdf-upload" class="upload-area" id="upload-label">
                                <span id="upload-text">Clique ou arraste o extrato PDF aqui</span>
                                <div id="loading" class="d-none align-items-center justify-content-center mt-2">
                                    <div class="spinner-border text-primary" role="status" id="loading-spinner"></div>
                                    <strong class="ms-2">Analisando...</strong>
                                </div>
                            </label>
                            <div class="resultado mt-3" id="listaEmprestimos" style="display:none;"></div>
                            <div class="form-check my-2" id="selecionar-todos-container" style="display:none;">
                                <input class="form-check-input" type="checkbox" id="selecionarTodos">
                                <label class="form-check-label" for="selecionarTodos">Selecionar Todas as Parcelas</label>
                            </div>
                            <div id="unificar-container-pdf" class="text-center" style="display:none; margin: 15px auto;">
                                <button id="unificarBtnPdf" class="btn btn-info w-100">Usar Parcelas Selecionadas no Cálculo</button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="manual-tab-pane" role="tabpanel" tabindex="0">
                         <div class="p-3">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-2">
                                    <label for="clienteNomeManual" class="form-label">Nome do Cliente</label>
                                    <input type="text" id="clienteNomeManual" class="form-control">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="clienteCpfManual" class="form-label">CPF do Cliente</label>
                                    <input type="text" id="clienteCpfManual" class="form-control" placeholder="000.000.000-00">
                                </div>
                            </div>
                            <div id="manual-loan-entry" class="p-3 mb-3" style="border: 1px solid #ccc; border-radius: 8px;">
                                <h3 class="fs-5 text-center mb-3">Adicionar Contratos</h3>
                                <div class="row g-2">
                                    <div class="col-md-7 mb-2"><label for="manualBanco" class="form-label">Banco</label><input type="text" id="manualBanco" class="form-control" placeholder="Nome do Banco"></div>
                                    <div class="col-md-5 mb-2"><label for="manualParcela" class="form-label">Valor da Parcela</label><input type="text" id="manualParcela" class="form-control" placeholder="Ex: 291,54"></div>
                                    <div class="col-6 col-md-4 mb-2"><label for="manualTotalParcelas" class="form-label">Total</label><input type="number" id="manualTotalParcelas" class="form-control" placeholder="Ex: 84" value="96"></div>
                                    <div class="col-6 col-md-4 mb-2"><label for="manualParcelasPagas" class="form-label">Pagas</label><input type="number" id="manualParcelasPagas" class="form-control" placeholder="Ex: 20"></div>
                                    <div class="col-12 col-md-4 d-flex align-items-end mb-2"><button type="button" id="addManualLoanBtn" class="btn btn-secondary w-100">Adicionar</button></div>
                                </div>
                                <div id="manual-loans-list" class="mt-3"></div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">2. Cálculo</h2>
            </div>
            <div class="card-body">
                <form id="Negativado">
                    <div class="mb-3">
                        <label class="form-label">Soma das parcelas:</label>
                        <h4 id="totalParcelasDisplay" class="fw-bold text-primary">R$ 0,00</h4>
                    </div>
                    <div class="mb-3">
                        <label for="negativo" class="form-label">Valor Negativo do Cliente</label>
                        <input type="text" id="negativo" class="form-control" required placeholder="Ex: 1000,00">
                    </div>
                    <button class="btn btn-success w-100 mt-3" type="submit">Calcular Nova Parcela</button>
                </form>
            </div>
        </div>

        <div id="resultado-container" class="mt-4" style="display:none;">
            <div class="card bg-light">
                <div class="card-header">
                    <h3 class="h5 mb-0">3. Resultado da Análise</h3>
                </div>
                <div class="card-body" id="resultado"></div>
                <div class="card-footer text-center" id="redirect-buttons-container">
                    <p class="mb-2">Avançar para a simulação de:</p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button class="btn btn-primary" id="goToPortabilidadeBtn">Portabilidade (SIAPE)</button>
                        <button class="btn btn-secondary" id="goToCompraBtn">Compra de Dívida (SIAPE)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
        let totalSaldoDevedorPDF = 0, totalParcelaPDF = 0, resultadoCalculo = {};
        let clienteNomePDF = '', clienteCpfPDF = '';
        let parcelasManuais = [];

        const moedaParaFloat = (v) => parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        const formatarMoeda = (v) => (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'danger' ? 'bg-danger' : 'bg-success';
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        };

        const uploadArea = document.getElementById('upload-label');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
        uploadArea.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.remove('hover'); 
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('pdf-upload').files = files;
                document.getElementById('pdf-upload').dispatchEvent(new Event('change'));
            }
        });

        document.getElementById("pdf-upload").addEventListener("change", async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('loading').classList.remove('d-none');
            document.getElementById('loading').classList.add('d-flex');
            document.getElementById('upload-text').style.display = 'none';

            const fileReader = new FileReader();
            fileReader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        text += (await (await pdf.getPage(i)).getTextContent()).items.map(item => item.str).join('\n');
                    }
                    
                    // Lógica para extrair dados (mesma do seu código original)
                    const headerRegex = /Órgão\nCPF\nMatrícula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
                    const headerMatch = text.match(headerRegex);
                    if (headerMatch) {
                        clienteCpfPDF = headerMatch[1].trim();
                        clienteNomePDF = headerMatch[2].trim();
                    }
                    
                    const listaDiv = document.getElementById("listaEmprestimos");
                    listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div>`;
                    
                    const rgxEmprestimos = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g;
                    let matches = [...text.matchAll(rgxEmprestimos)];
                    matches.forEach((match, index) => {
                         const [_, nomeBanco, valor, parcelasStr] = match;
                        const cleanNomeBanco = nomeBanco.replace(/^\d{5}\s*-\s*/, '').trim();
                        const [pagas, total] = parcelasStr.split('/');
                        const valorParcelaNum = moedaParaFloat(valor);
                        const saldoAproximado = valorParcelaNum * (parseInt(total, 10) - parseInt(pagas, 10)) * 0.70;
                        const itemHtml = `<div class="form-check border-bottom py-2"><input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${cleanNomeBanco}</strong><br><small>Parcela: ${formatarMoeda(valorParcelaNum)} | Saldo Aprox.: ${formatarMoeda(saldoAproximado)}</small></label></div>`;
                        listaDiv.innerHTML += itemHtml;
                    });
                    
                    listaDiv.style.display = "block";
                    document.getElementById('selecionar-todos-container').style.display = 'block';
                    document.getElementById('unificar-container-pdf').style.display = 'block';
                    showToast("Extrato PDF analisado com sucesso!");

                } catch (error) {
                    console.error("Erro ao processar PDF:", error);
                    showToast("Erro ao ler o arquivo PDF. Verifique o formato.", 'danger');
                } finally {
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('loading').classList.remove('d-flex');
                    document.getElementById('upload-text').style.display = 'block';
                }
            };
            fileReader.readAsArrayBuffer(file);
        });

        if (document.getElementById("selecionarTodos")) {
            document.getElementById("selecionarTodos").addEventListener("change", (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
        }

        if (document.getElementById("unificarBtnPdf")) {
            document.getElementById("unificarBtnPdf").addEventListener("click", function() {
                const checkboxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkboxes.length === 0) {
                    showToast("Selecione pelo menos um contrato.", 'danger');
                    return;
                }
                
                totalParcelaPDF = 0;
                totalSaldoDevedorPDF = 0;
                checkboxes.forEach(cb => {
                    totalParcelaPDF += parseFloat(cb.dataset.parcela);
                    totalSaldoDevedorPDF += parseFloat(cb.dataset.saldo);
                });
                document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcelaPDF);
                showToast("Valores unificados! Preencha o valor negativo para calcular.");
            });
        }
        
        const renderizarListaManual = () => {
            const listaDiv = document.getElementById('manual-loans-list');
            let totalParcelasManuais = 0;
            listaDiv.innerHTML = '';
            if (parcelasManuais.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';
                parcelasManuais.forEach((p, index) => {
                    totalParcelasManuais += p.parcela;
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><strong>${p.banco}</strong> - ${formatarMoeda(p.parcela)}<br><small class="text-muted">${p.parcelasPagas} de ${p.totalParcelas}</small></div><button type="button" class="btn btn-outline-danger btn-sm" onclick="removerParcelaManual(${index})">X</button>`;
                    ul.appendChild(li);
                });
                listaDiv.appendChild(ul);
            }
            document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcelasManuais);
        };

        window.removerParcelaManual = (index) => {
            parcelasManuais.splice(index, 1);
            renderizarListaManual();
        };

        document.getElementById('addManualLoanBtn').addEventListener('click', () => {
            const banco = document.getElementById('manualBanco').value || 'Não informado';
            const parcelaValor = moedaParaFloat(document.getElementById('manualParcela').value);
            const totalParcelas = parseInt(document.getElementById('manualTotalParcelas').value, 10);
            const parcelasPagas = parseInt(document.getElementById('manualParcelasPagas').value, 10);

            if (!parcelaValor || !totalParcelas || isNaN(parcelasPagas)) {
                showToast("Preencha valor e parcelas corretamente.", 'danger');
                return;
            }
            if (parcelasPagas > totalParcelas) {
                showToast("Parcelas pagas não pode ser maior que o total.", 'danger');
                return;
            }
            
            parcelasManuais.push({ banco, parcela: parcelaValor, totalParcelas, parcelasPagas });
            ['manualBanco', 'manualParcela', 'manualParcelasPagas'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('manualTotalParcelas').value = '96';
            renderizarListaManual();
            showToast("Contrato adicionado com sucesso!");
        });
        
        document.getElementById("Negativado").addEventListener("submit", function(e) {
            e.preventDefault();
            
            let totalParcelas = 0, saldoFinal = 0;
            const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');

            if (isManualTabActive) {
                let saldoManual = 0;
                parcelasManuais.forEach(p => {
                    totalParcelas += p.parcela;
                    const restantes = p.totalParcelas - p.parcelasPagas;
                    if (restantes > 0) {
                       saldoManual += p.parcela * restantes * 0.70;
                    }
                });
                saldoFinal = saldoManual;
            } else {
                totalParcelas = totalParcelaPDF;
                saldoFinal = totalSaldoDevedorPDF;
            }

            if (totalParcelas === 0) {
                showToast("Adicione pelo menos um contrato para calcular.", 'danger');
                return;
            }
            
            const negativo = moedaParaFloat(document.getElementById("negativo").value);
            if(negativo <= 0) {
                showToast("Insira um valor negativo válido.", 'danger');
                return;
            }

            const novaParcela = totalParcelas - negativo;
            const nomeFinal = document.getElementById('clienteNomeManual').value.trim() || clienteNomePDF;
            const cpfFinal = document.getElementById('clienteCpfManual').value.trim() || clienteCpfPDF;

            resultadoCalculo = { totalParcelas, negativo, novaParcela, saldoDevedor: saldoFinal, nome: nomeFinal, cpf: cpfFinal };

            document.getElementById("resultado-container").style.display = "block";
            document.getElementById("resultado").innerHTML = `
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>Total Parcelas Originais:</span> <strong>${formatarMoeda(totalParcelas)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Valor Negativo:</span> <strong class="text-danger">- ${formatarMoeda(negativo)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Saldo Devedor Aprox.:</span> <strong>${formatarMoeda(saldoFinal)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between bg-success-subtle"><h4>Nova Parcela p/ Cálculo:</h4> <h4 class="fw-bold">${formatarMoeda(novaParcela)}</h4></li>
                </ul>`;
            
            document.getElementById("resultado-container").scrollIntoView({ behavior: 'smooth' });
        });

        document.getElementById("goToPortabilidadeBtn").addEventListener("click", function() {
            sessionStorage.setItem('calculoNegativadoData', JSON.stringify(resultadoCalculo));
            window.location.href = 'port-auto.html';
        });

        document.getElementById("goToCompraBtn").addEventListener("click", function() {
            sessionStorage.setItem('calculoNegativadoData', JSON.stringify(resultadoCalculo));
            window.location.href = 'compra.html';
        });
    </script>
</body>
</html>