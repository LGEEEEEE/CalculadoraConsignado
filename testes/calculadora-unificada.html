<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Calculadora Unificada - Consignado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../icone.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
        }

        .btn-voltar {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1030;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 2px dashed #0d6efd;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .upload-area.hover {
            background-color: #e9ecef;
            border-color: #0b5ed7;
        }

        #pdf-upload {
            display: none;
        }

        #loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }

        .toast {
            width: 350px;
            max-width: 100%;
        }

        .resultado-final-valor {
            font-size: 1.75rem;
            font-weight: bold;
        }

        .logos {
            display: none;
        }
    </style>
</head>

<body>
    <a href="/index.html" class="btn btn-secondary btn-voltar">‚Üê Voltar</a>
    <div class="toast-container" id="toast-container"></div>

    <div class="logos">
        <img src="../images/logoheader.png" id="logo-alianca">
        <img src="../images/polo-promotora.png" id="logo-polo">
        <img src="../images/estilo-promotora.png" id="logo-estilo">
        <img src="../images/exercito.png" id="convenio-logo-exercito">
        <img src="../images/siape.png" id="convenio-logo-siape">
    </div>

    <div class="container" id="page-container">
        <h1 class="text-center h3 mb-4" id="pageTitle">Calculadora Consignado</h1>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Sele√ß√£o da Opera√ß√£o</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="convenioSelect" class="form-label">1. Conv√™nio</label>
                        <select id="convenioSelect" class="form-select">
                            <option value="exercito" selected>Ex√©rcito (eConsig)</option>
                            <option value="siape">SIAPE</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="operacaoSelect" class="form-label">2. Tipo de Opera√ß√£o</label>
                        <select id="operacaoSelect" class="form-select"></select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Empresa Respons√°vel</h2>
            </div>
            <div class="card-body">
                <div class="mb-0"> <label for="empresaSelect" class="form-label">Empresa Respons√°vel pela
                        Simula√ß√£o</label>
                    <select id="empresaSelect" class="form-select">
                        <option value="alianca" selected>Alian√ßa Consig</option>
                        <option value="polo">Polo Promotora</option>
                        <option value="estilo">Estilo Promotora</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="infoNegativado" class="alert alert-warning" style="display:none;"></div>

        <form id="calcForm">
            <div class="card mb-4" id="clienteCard">
                <div class="card-header">
                    <h2 class="h5 mb-0">1. Dados do Cliente e Contratos</h2>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="entryTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="pdf-tab"
                                data-bs-toggle="tab" data-bs-target="#pdf-tab-pane" type="button" role="tab">Carregar
                                Extrato</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="manual-tab"
                                data-bs-toggle="tab" data-bs-target="#manual-tab-pane" type="button" role="tab">Inserir
                                Manualmente</button></li>
                    </ul>
                    <div class="tab-content" id="entryTabContent">
                        <div class="tab-pane fade show active p-3" id="pdf-tab-pane" role="tabpanel">
                            <input type="file" id="pdf-upload" accept=".pdf"><label for="pdf-upload" class="upload-area"
                                id="upload-label"><span id="upload-text">Clique ou arraste o extrato PDF</span>
                                <div id="loading" class="d-none align-items-center justify-content-center mt-2">
                                    <div class="spinner-border text-primary" id="loading-spinner" role="status"></div>
                                    <strong class="ms-2" id="loading-text">Analisando...</strong>
                                </div>
                            </label>
                            <div id="listaEmprestimos" class="mt-3" style="display:none;"></div>
                            <button type="button" id="unificarBtnPdf" class="btn btn-info w-100 mt-3"
                                style="display:none;">Usar Contratos Selecionados</button>
                        </div>
                        <div class="tab-pane fade p-3" id="manual-tab-pane" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-2"><label for="clienteNome" class="form-label">Nome do
                                        Cliente</label><input type="text" id="clienteNome" class="form-control"></div>
                                <div class="col-md-6 mb-2"><label for="clienteCpf" class="form-label">CPF do
                                        Cliente</label><input type="text" id="clienteCpf" class="form-control"
                                        placeholder="000.000.000-00"></div>
                            </div>
                            <div class="p-3 mb-3 border rounded">
                                <h3 class="fs-5 text-center mb-3">Adicionar Contratos</h3>
                                <div class="row g-2">
                                    <div class="col-md-7 mb-2"><label for="manualBanco"
                                            class="form-label">Banco</label><input type="text" id="manualBanco"
                                            class="form-control"></div>
                                    <div class="col-md-5 mb-2"><label for="manualParcela" class="form-label">Valor
                                            Parcela</label><input type="text" id="manualParcela" class="form-control">
                                    </div>
                                    <div class="col-6 col-md-4 mb-2"><label for="manualTotalParcelas"
                                            class="form-label">Total</label><input type="number"
                                            id="manualTotalParcelas" class="form-control" value="96"></div>
                                    <div class="col-6 col-md-4 mb-2"><label for="manualParcelasPagas"
                                            class="form-label">Pagas</label><input type="number"
                                            id="manualParcelasPagas" class="form-control"></div>
                                    <div class="col-12 col-md-4 d-flex align-items-end mb-2"><button type="button"
                                            id="addManualBtn" class="btn btn-secondary w-100">Adicionar</button></div>
                                </div>
                                <div id="manual-loans-list" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="simulacaoCard">
                <div class="card-header">
                    <h2 class="h5 mb-0" id="simulacaoTitle">2. Dados da Simula√ß√£o</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div id="negativado-fields" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Soma das parcelas:</label>
                                <h4 id="totalParcelasDisplay" class="fw-bold text-primary">R$ 0,00</h4>
                            </div>
                            <div class="mb-3">
                                <label for="negativo" class="form-label">Valor Negativo do Cliente</label>
                                <input type="text" id="negativo" class="form-control" placeholder="Ex: 1000,00"
                                    required>
                            </div>
                        </div>

                        <div id="simulacao-fields" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="parcela" class="form-label">Valor Total da
                                        Parcela</label><input type="text" id="parcela" class="form-control" required
                                        placeholder="Unificado do passo anterior"></div>
                                <div class="col-md-6 mb-3"><label for="saldodevedor" class="form-label">Saldo Devedor
                                        Aprox. Total</label><input type="text" id="saldodevedor" class="form-control"
                                        required placeholder="Unificado do passo anterior"></div>
                            </div>

                            <div class="p-3 mb-3 border rounded">
                                <h5 class="fs-6 text-primary mb-3">Dados do Novo Contrato</h5>
                                <div class="row">
                                    <div class="col-md-8 mb-2">
                                        <label for="novoBanco" class="form-label">Banco Destino</label>
                                        <input type="text" id="novoBanco" class="form-control" value="Bradesco">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label for="novoPrazo" class="form-label">Prazo (meses)</label>
                                        <input type="number" id="novoPrazo" class="form-control" value="96">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3"><label for="desconto" class="form-label">Produto
                                        (Opcional)</label><input type="text" id="desconto" class="form-control"
                                        placeholder="Ex: 1.000,00"></div>
                            </div>

                            <div id="port-refin-fields" style="display:none;">
                                <div class="col-md-12 mb-3"><label class="form-label">Houve quita√ß√£o de algum
                                        valor?</label>
                                    <div>
                                        <div class="form-check form-check-inline"><input class="form-check-input"
                                                type="radio" name="quitacao" id="quitacaoNao" value="nao" checked><label
                                                class="form-check-label" for="quitacaoNao">N√£o</label></div>
                                        <div class="form-check form-check-inline"><input class="form-check-input"
                                                type="radio" name="quitacao" id="quitacaoSim" value="sim"><label
                                                class="form-check-label" for="quitacaoSim">Sim</label></div>
                                    </div>
                                </div>
                                <div id="quitadoContainer" style="display:none;" class="col-md-12 mb-3"><label
                                        for="valorQuitado" class="form-label">Valor a ser quitado</label><input
                                        type="text" id="valorQuitado" class="form-control" placeholder="Ex: 5.000,00">
                                </div>
                            </div>

                            <div id="compra-fields" style="display:none;">
                                <div class="col-md-12 mb-3"><label for="tipoCompra" class="form-label">Tipo de
                                        Compra</label><select id="tipoCompra" class="form-select">
                                        <option value="bradesco" selected>Bradesco (Inv. 10%)</option>
                                        <option value="cef">Caixa (CEF) (Inv. 8%)</option>
                                    </select></div>
                            </div>

                            <hr class="my-3">
                            <div class="row">
                                <div class="col-md-4 mb-3"><label for="coeficiente"
                                        class="form-label">Coeficiente</label><input type="text" id="coeficiente"
                                        class="form-control" value="0.02" required></div>
                                <div class="col-md-4 mb-3"><label for="comissaoGerente" class="form-label">Comiss√£o
                                        Gerente (%)</label><input type="text" id="comissaoGerente" class="form-control"
                                        value="15" required></div>
                                <div class="col-md-4 mb-3"><label for="comissaoesc" class="form-label">Comiss√£o
                                        Escrit√≥rio</label><input type="text" id="comissaoesc" class="form-control"
                                        required value="100"></div>
                            </div>
                        </div>

                        <div id="margem-nova-fields" style="display:none;">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-2">
                                    <label for="mn-clienteNome" class="form-label">Nome do Cliente</label>
                                    <input type="text" id="mn-clienteNome" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="mn-clienteCpf" class="form-label">CPF do Cliente</label>
                                    <input type="text" id="mn-clienteCpf" class="form-control"
                                        placeholder="000.000.000-00" required>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="mn-banco" class="form-label">Banco Destino</label>
                                    <input type="text" id="mn-banco" class="form-control" value="Bradesco" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="mn-parcela" class="form-label">Valor da Parcela (Margem)</label>
                                    <input type="text" id="mn-parcela" class="form-control" required
                                        placeholder="Ex: 350,00">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="mn-coeficiente" class="form-label">Coeficiente</label>
                                    <input type="text" id="mn-coeficiente" class="form-control" required value="0.023">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="mn-prazo" class="form-label">Prazo (meses)</label>
                                    <input type="number" id="mn-prazo" class="form-control" required value="96">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer"><button class="btn btn-primary w-100" type="submit"
                        id="submitBtn">Calcular</button></div>
            </div>
        </form>

        <div id="resultadoFinal" class="mt-4" style="display:none;"></div>

        <div id="resultadoNegativadoContainer" class="mt-4" style="display:none;">
            <div class="card bg-light">
                <div class="card-header">
                    <h3 class="h5 mb-0">3. Resultado da An√°lise</h3>
                </div>
                <div class="card-body" id="resultadoNegativadoBody"></div>
                <div class="card-footer text-center">
                    <p class="mb-2">Avan√ßar para a simula√ß√£o de:</p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button class="btn btn-primary" id="goToPortabilidadeBtn" type="button">Portabilidade</button>
                        <button class="btn btn-secondary" id="goToCompraBtn" type="button">Compra de D√≠vida</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@latest/dist/tesseract.min.js'></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        let clienteNomePDF = '', clienteCpfPDF = '', parcelasSelecionadasPDF = [], calculoDetalhado = {};
        let parcelasManuais = [], dadosNegativado = null;

        const operacoes = {
            exercito: [
                { value: 'portabilidade_exercito', text: 'Portabilidade', coef: '0.01930' },
                { value: 'compra_exercito', text: 'Compra de D√≠vida', coef: '0.02' },
                { value: 'margem_refin_exercito', text: 'Margem + Refin Bradesco', coef: '0.02' },
                { value: 'margem_nova_exercito', text: 'Margem Nova', coef: '0.023' },
                { value: 'negativado_exercito', text: 'An√°lise de Negativado', coef: '' }
            ],
            siape: [
                { value: 'portabilidade_siape', text: 'Portabilidade', coef: '0.01930' },
                { value: 'compra_siape', text: 'Compra de D√≠vida', coef: '0.02' },
                { value: 'margem_nova_siape', text: 'Margem Nova', coef: '0.023' },
                { value: 'negativado_siape', text: 'An√°lise de Negativado', coef: '' }
            ]
        };

        const moedaParaFloat = (v) => parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        const formatarMoeda = (v) => (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const formatarInputMoeda = (v) => (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\s/g, '');

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'danger' ? 'bg-danger' : (type === 'warning' ? 'bg-warning text-dark' : 'bg-success');
            const toastHtml = `<div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 4000 });
            toast.show();
            const toastEl = document.getElementById(toastId);
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        };

        function atualizarOperacoes() {
            const convenio = document.getElementById('convenioSelect').value;
            const operacaoSelect = document.getElementById('operacaoSelect');
            operacaoSelect.innerHTML = '';

            let opcaoPadrao = null;

            operacoes[convenio].forEach((op, index) => {
                const option = new Option(op.text, op.value);
                operacaoSelect.add(option);

                // L√≥gica para definir 'Compra de D√≠vida' como padr√£o
                if (op.value.includes('compra')) {
                    opcaoPadrao = op.value;
                }
            });

            // Se encontrou uma op√ß√£o de compra, seleciona ela. 
            // Sen√£o, mant√©m a primeira (padr√£o do HTML)
            if (opcaoPadrao) {
                operacaoSelect.value = opcaoPadrao;
            }

            atualizarVisibilidadeUI();
        }

        function atualizarVisibilidadeUI() {
            const convenio = document.getElementById('convenioSelect').value;
            const operacaoValue = document.getElementById('operacaoSelect').value;
            const operacao = (operacoes[convenio] || []).find(op => op.value === operacaoValue) || {};

            document.getElementById('resultadoFinal').style.display = 'none';
            document.getElementById('resultadoNegativadoContainer').style.display = 'none';

            const clienteCard = document.getElementById('clienteCard');
            const simulacaoCard = document.getElementById('simulacaoCard');
            const negativadoFields = document.getElementById('negativado-fields');
            const simulacaoFields = document.getElementById('simulacao-fields');
            const margemNovaFields = document.getElementById('margem-nova-fields'); // Pega o novo DIV
            const portRefinFields = document.getElementById('port-refin-fields');
            const compraFields = document.getElementById('compra-fields');
            const submitBtn = document.getElementById('submitBtn');

            // Inputs 'negativado'
            const negativoInput = document.getElementById('negativo');
            // Inputs 'simulacao'
            const parcelaInput = document.getElementById('parcela');
            const saldoInput = document.getElementById('saldodevedor');
            const coefInput = document.getElementById('coeficiente');
            const comGerenteInput = document.getElementById('comissaoGerente');
            const comEscInput = document.getElementById('comissaoesc');
            // Inputs 'margem nova'
            const mnNome = document.getElementById('mn-clienteNome');
            const mnCpf = document.getElementById('mn-clienteCpf');
            const mnBanco = document.getElementById('mn-banco'); // NOVO CAMPO
            const mnParcela = document.getElementById('mn-parcela');
            const mnCoef = document.getElementById('mn-coeficiente');
            const mnPrazo = document.getElementById('mn-prazo');


            document.getElementById('pageTitle').textContent = operacao.text ? `Calculadora ${operacao.text} (${convenio.toUpperCase()})` : 'Calculadora Consignado';

            // Reseta todos os 'required' para false antes de aplicar as regras
            [negativoInput, parcelaInput, saldoInput, coefInput, comGerenteInput, comEscInput, mnNome, mnCpf, mnBanco, mnParcela, mnCoef, mnPrazo].forEach(el => el.required = false);

            if (operacaoValue.includes('margem_nova')) {
                clienteCard.style.display = 'none'; // Esconde o card de upload/manual
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'none';
                simulacaoFields.style.display = 'none';
                margemNovaFields.style.display = 'block'; // Mostra os campos de margem nova

                document.getElementById('simulacaoTitle').textContent = "2. Dados da Margem Nova";
                submitBtn.textContent = 'Calcular Margem Nova';
                if (operacao.coef) document.getElementById('mn-coeficiente').value = operacao.coef;

                // Seta 'required' para os campos de margem nova
                mnNome.required = true;
                mnCpf.required = true;
                mnBanco.required = true; // NOVO CAMPO
                mnParcela.required = true;
                mnCoef.required = true;
                mnPrazo.required = true;

            } else if (operacaoValue.includes('negativado')) {
                clienteCard.style.display = 'block';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'block';
                simulacaoFields.style.display = 'none';
                margemNovaFields.style.display = 'none';
                document.getElementById('simulacaoTitle').textContent = "2. C√°lculo";
                submitBtn.textContent = 'Calcular Nova Parcela';

                negativoInput.required = true;

            } else { // Portabilidade, Compra, Refin
                clienteCard.style.display = 'block';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'none';
                simulacaoFields.style.display = 'block';
                margemNovaFields.style.display = 'none';
                document.getElementById('simulacaoTitle').textContent = "2. Dados da Simula√ß√£o";
                submitBtn.textContent = 'Calcular Simula√ß√£o Completa';

                if (operacao.coef) document.getElementById('coeficiente').value = operacao.coef;

                if (operacaoValue.includes('compra')) {
                    portRefinFields.style.display = 'none';
                    compraFields.style.display = 'block';
                } else if (operacaoValue.includes('portabilidade') || operacaoValue.includes('refin')) {
                    portRefinFields.style.display = 'block';
                    compraFields.style.display = 'none';
                } else {
                    portRefinFields.style.display = 'none';
                    compraFields.style.display = 'none';
                }

                // Seta 'required' para os campos de simula√ß√£o padr√£o
                parcelaInput.required = true;
                saldoInput.required = true;
                coefInput.required = true;
                comGerenteInput.required = true;
                comEscInput.required = true;
            }
        }

        function verificarDadosNegativado() {
            const data = sessionStorage.getItem('calculoNegativadoData');
            if (data) {
                try {
                    dadosNegativado = JSON.parse(data);
                    clienteNomePDF = dadosNegativado.nome || '';
                    clienteCpfPDF = dadosNegativado.cpf || '';
                    document.getElementById('parcela').value = formatarInputMoeda(dadosNegativado.novaParcela);
                    if (dadosNegativado.saldoDevedor > 0) document.getElementById('saldodevedor').value = formatarInputMoeda(dadosNegativado.saldoDevedor);

                    const infoDiv = document.getElementById('infoNegativado');
                    infoDiv.innerHTML = `<h5 class="alert-heading">Dados da An√°lise de Negativado</h5><p class="mb-1">Os campos de parcela e saldo foram preenchidos com base no c√°lculo anterior.</p><hr><p class="mb-0"><strong>Nova Parcela para c√°lculo:</strong> ${formatarMoeda(dadosNegativado.novaParcela)}</p>`;
                    infoDiv.style.display = 'block';
                } catch (e) {
                    console.error("Erro ao processar dados de negativado:", e);
                    dadosNegativado = null;
                } finally {
                    sessionStorage.removeItem('calculoNegativadoData');
                }
            } else {
                document.getElementById('infoNegativado').style.display = 'none';
                dadosNegativado = null;
            }
        }

        async function processarPdfExercicio(text) {
            // Limpa o texto, removendo cabe√ßalhos de p√°gina e rodap√©s
            let cleanText = text.replace(/--- FIM DA P√ÅGINA \d+ ---/g, '')
                .replace(/Consignat√°ria\n\s*‚ñ¥\s*‚ñæ[\s\S]+?Situa√ß√£o\n\s*‚ñ¥\s*‚ñæ/g, '') // Remove header de tabela limpa
                .replace(/Consignat√°ria N¬∫ Servi√ßo Inclus√£o Vir.prest. Virfolha N¬∫ Pagas Situa√ß√£o/g, ''); // Remove header de tabela OCR

            const listaDiv = document.getElementById("listaEmprestimos");
            listaDiv.innerHTML = ''; // Limpa a lista anterior
            let loansFound = 0;

            // --- DETEC√á√ÉO AUTOM√ÅTICA DO TIPO DE TEXTO ---
            const isOcrText = cleanText.includes('O74-SABEMI-') || cleanText.includes('R$834/12') || cleanText.includes('R$74046');

            if (isOcrText) {
                // --- L√ìGICA B: PARSER TOLERANTE PARA OCR (Tesseract) ---
                console.log("Detectado texto de OCR (Ex√©rcito). Usando parser tolerante.");

                const cpfMatch = text.match(/(\d{3}\.\d{3}\.\d{3}-\d{2})/);
                const nomeMatch = text.match(/(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-Z√Ä-√ö ]+)(?:\n([A-Z√Ä-√ö ]+))?/);

                if (cpfMatch) {
                    clienteCpfPDF = cpfMatch[0];
                } else if (nomeMatch) {
                    clienteCpfPDF = nomeMatch[2].trim();
                }

                if (nomeMatch) {
                    clienteNomePDF = nomeMatch[3].trim() + (nomeMatch[4] ? ' ' + nomeMatch[4].trim() : '');
                }

                listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF || 'N√£o lido (OCR)'}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF || 'N√£o lido (OCR)'}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;

                const blocos = cleanText.split(/Andamento/gi);

                blocos.forEach((bloco, index) => {
                    if (!bloco.toUpperCase().includes('EMPR√âSTIMO') && !bloco.toUpperCase().includes('DEDUT')) return;

                    let nomeBanco = 'Banco (N√£o lido)';
                    if (bloco.includes('SABEMI')) nomeBanco = 'SABEMI - PRIVADA';

                    const valorMatches = bloco.match(/R\$\s*([\d.,\/]+)/g);
                    if (!valorMatches) return;

                    let valorStr = valorMatches[valorMatches.length - 1];
                    valorStr = valorStr.replace('/', ',').replace(/[\[|]/g, '');

                    if (!valorStr.includes(',')) {
                        let digits = valorStr.replace(/R\$\s*/, '').trim();
                        if (digits.length > 2) {
                            valorStr = "R$ " + digits.slice(0, -2) + ',' + digits.slice(-2);
                        }
                    }

                    const valorParcelaNum = moedaParaFloat(valorStr);
                    if (valorParcelaNum === 0) return;

                    const parcelasMatch = bloco.match(/\s*([\w\.|]+)\s+([\w\d]+)\s+Em/s);

                    if (!parcelasMatch) {
                        console.warn('Contrato pulado (OCR n√£o leu as parcelas):', bloco);
                        return;
                    }

                    let total = parcelasMatch[1].replace(/[\[|TP]/g, '').trim();
                    let pagas = parcelasMatch[2].replace(/[x|xi|nm]/g, '0');

                    if (isNaN(parseInt(pagas, 10)) || (total.toUpperCase() !== 'INDET.' && isNaN(parseInt(total, 10)))) {
                        console.warn('Contrato pulado (OCR leu lixo nas parcelas):', bloco);
                        return;
                    }

                    if (total.toUpperCase() === 'INDET.') {
                        loansFound++;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'form-check border-bottom py-2';
                        itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="0" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Saldo Aprox.: ${formatarMoeda(0)} | Parcela: ${formatarMoeda(valorParcelaNum)} | Status: ${pagas} de ${total}</small></label>`;
                        listaDiv.appendChild(itemDiv);
                        return;
                    }

                    const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10);
                    if (parcelasRestantes < 0) return;

                    loansFound++;
                    const saldoAproximado = valorParcelaNum * parcelasRestantes * 0.70;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'form-check border-bottom py-2';
                    itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Saldo Aprox.: ${formatarMoeda(saldoAproximado)} | Parcela: ${formatarMoeda(valorParcelaNum)} | Status: ${pagas} de ${total}</small></label>`;
                    listaDiv.appendChild(itemDiv);
                });

            } else {
                // --- L√ìGICA A: PARSER ORIGINAL (Para PDF limpo) ---
                console.log("Detectado texto limpo (Ex√©rcito). Usando parser padr√£o.");

                const infoRegex = /(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-Z√Ä-√ö ]+)(?:\n([A-Z√Ä-√ö ]+))?/;
                const infoMatch = text.match(infoRegex);

                if (infoMatch) {
                    clienteCpfPDF = infoMatch[2].trim();
                    clienteNomePDF = infoMatch[3].trim();
                    if (infoMatch[4]) {
                        clienteNomePDF += ` ${infoMatch[4].trim()}`;
                    }
                } else {
                    clienteCpfPDF = '';
                    clienteNomePDF = '';
                    console.warn("Regex de Nome/CPF falhou no parser limpo (Ex√©rcito).");
                }

                listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;

                const blocos = cleanText.split(/\n(?=\d{3}\s*-\s*)/);

                blocos.forEach((bloco, index) => {
                    if (bloco.toUpperCase().includes('EMPR√âSTIMO') && /Em\s+Andamento/.test(bloco)) {
                        const bancoMatch = bloco.match(/^([\s\S]+?)\n(\d{7})\n/);
                        const valorMatch = bloco.match(/R\$\s*[\d.,]+/);
                        const parcelasMatch = /([\w\.]+)\s*\n\s*(\d+)\s+Em\s+Andamento/;
                        const parcelasResult = bloco.match(parcelasMatch);

                        if (bancoMatch && valorMatch && parcelasResult) {
                            const nomeBanco = bancoMatch[1].replace(/\n/g, ' ').trim();
                            const valor = valorMatch[0];
                            const total = parcelasResult[1];
                            const pagas = parcelasResult[2];

                            if (total.toUpperCase() === 'INDET.') return;

                            loansFound++;
                            const valorParcelaNum = moedaParaFloat(valor);
                            const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10);
                            if (parcelasRestantes < 0) return;

                            const saldoAproximado = valorParcelaNum * parcelasRestantes * 0.70;
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'form-check border-bottom py-2';
                            itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Saldo Aprox.: ${formatarMoeda(saldoAproximado)} | Parcela: ${formatarMoeda(valorParcelaNum)} | Status: ${pagas} de ${total}</small></label>`;
                            listaDiv.appendChild(itemDiv);
                        }
                    }
                });
            }

            if (loansFound === 0) showToast("AVISO: Nenhum contrato 'Em Andamento' foi encontrado no formato esperado.", 'warning');

            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
            listaDiv.style.display = "block";
            document.getElementById("unificarBtnPdf").style.display = "block";
        }

        // ######################################################################
        // FUN√á√ÉO SIAPE ATUALIZADA - COM C√ÅLCULO DE NEGATIVO (DEPURADO)
        // ######################################################################
        async function processarPdfSiape(text) {
            console.log("Iniciando processamento SIAPE (UX Aprimorada)...");

            // 1. Extra√ß√£o de Nome e CPF
            const infoRegexNovo = /CPF\nMatr√≠cula\nNome\n([^\n]+)\n(?:[^\n]*\n)?([^\n]+)/;
            const headerRegexAntigo = /√ìrg√£o\nCPF\nMatr√≠cula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;

            let infoMatchNovo = text.match(infoRegexNovo);
            let headerMatchAntigo = text.match(headerRegexAntigo);
            let cpfExtraido = 'N√£o lido', nomeExtraido = 'N√£o lido';

            if (infoMatchNovo && (/\d{3}\.\d{3}\.\d{3}-\d{2}/.test(infoMatchNovo[1].trim()) || /\d{11}/.test(infoMatchNovo[1].replace(/[.-]/g, '')))) {
                cpfExtraido = infoMatchNovo[1].trim();
                nomeExtraido = infoMatchNovo[2].trim();
            } else if (headerMatchAntigo) {
                cpfExtraido = headerMatchAntigo[1].trim();
                nomeExtraido = headerMatchAntigo[2].trim();
            } else {
                const cpfSimples = text.match(/\d{3}\.\d{3}\.\d{3}-\d{2}/);
                if (cpfSimples) cpfExtraido = cpfSimples[0];
            }

            clienteCpfPDF = cpfExtraido;
            clienteNomePDF = nomeExtraido;

            // ------------------------------------------------------------------
            // 2. C√ÅLCULO DE NEGATIVO & AUTO-SWITCH DE OPERA√á√ÉO
            // ------------------------------------------------------------------
            const blocoValoresRegex = /Total\s+Cart√£o([\s\S]+?)(?:Extrato\s+de\s+Consigna√ß√µes|Demonstrativo\s+de\s+uso)/i;
            const matchBloco = text.match(blocoValoresRegex);

            let valBrutaFacultativa = 0;
            let valTotalFacultativas = 0;
            let margemDisponivel = 0;
            let calculoRealizado = false;

            // Elementos de UI
            const infoDiv = document.getElementById("infoNegativado");
            const negativoInput = document.getElementById("negativo");
            const operacaoSelect = document.getElementById("operacaoSelect"); // Para o auto-switch

            if (matchBloco) {
                const valoresEncontrados = matchBloco[1].match(/R\$\s*([\d.,]+)/g);
                if (valoresEncontrados && valoresEncontrados.length >= 7) {
                    valBrutaFacultativa = moedaParaFloat(valoresEncontrados[2]);
                    valTotalFacultativas = moedaParaFloat(valoresEncontrados[6]);
                    margemDisponivel = valBrutaFacultativa - valTotalFacultativas;
                    calculoRealizado = true;
                }
            }

            if (calculoRealizado) {
                
                // 1. PREPARA√á√ÉO DO LINK DIRETO
                // Usamos o CPF formatado (com pontos e tra√ßos) pois sua imagem mostrou que a URL usa esse formato.
                // Se der erro, tente trocar por 'cpfLimpo' (apenas n√∫meros).
                const cpfParaLink = clienteCpfPDF || ''; 
                const cpfLimpo = cpfParaLink.replace(/\D/g, ''); // Para a c√≥pia do clipboard
                
                // Monta a URL exata que voc√™ testou e funcionou
                const urlPolloDireta = `https://sistema.gconsig.com/admin/consultor/${cpfParaLink}/procurarcliente.html?tipo=cpf`;

                let htmlAnalise = `<h5 class="alert-heading">An√°lise de Margem (SIAPE)</h5>
                           <div class="row">
                               <div class="col-6"><strong>Bruta Facultativa:</strong><br>${formatarMoeda(valBrutaFacultativa)}</div>
                               <div class="col-6"><strong>Total Utilizado:</strong><br>${formatarMoeda(valTotalFacultativas)}</div>
                           </div>
                           <hr class="my-2">`;
                
                // Bot√£o atualizado com o Link Direto
                const botaoLinkPollo = (classeCor) => `
                    <div class="mt-3">
                        <a href="${urlPolloDireta}" target="_blank" class="btn btn-sm ${classeCor} w-100"
                           onclick="navigator.clipboard.writeText('${cpfLimpo}'); showToast('Abrindo sistema... CPF copiado por seguran√ßa!', 'info');">
                            <strong>üîó Abrir Cliente no Pollo</strong>
                        </a>
                        <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                            (Vai direto para o cadastro. Se falhar, o CPF j√° foi copiado)
                        </small>
                    </div>`;

                if (margemDisponivel < -0.01) {
                    // --- CLIENTE NEGATIVO ---
                    const valorNegativo = Math.abs(margemDisponivel);
                    htmlAnalise += `<div class="alert alert-danger mb-0 text-center">
                                <strong>‚ö†Ô∏è CLIENTE NEGATIVO</strong><br>
                                Valor Excedente: <strong>${formatarMoeda(valorNegativo)}</strong>
                                
                                ${botaoLinkPollo('btn-outline-dark')}

                                <p class="mt-2 mb-0"><small>Ou consulte no <a href="https://c6.c6consig.com.br/WebAutorizador/Login" target="_blank">Banco C6</a></small></p>
                                </div>`;

                    negativoInput.value = formatarInputMoeda(valorNegativo);

                    if (operacaoSelect.value !== 'negativado_siape') {
                        operacaoSelect.value = 'negativado_siape';
                        atualizarVisibilidadeUI();
                        showToast(`Modo 'An√°lise de Negativado' ativado automaticamente!`, "warning");
                    }

                } else {
                    // --- MARGEM POSITIVA ---
                    htmlAnalise += `<div class="alert alert-success mb-0 text-center">
                                <strong>‚úÖ MARGEM DISPON√çVEL</strong><br>
                                Livre: <strong>${formatarMoeda(margemDisponivel)}</strong>
                                
                                ${botaoLinkPollo('btn-outline-success')}
                                
                                <p class="mt-2 mb-0"><small>Ou consulte no <a href="https://c6.c6consig.com.br/WebAutorizador/Login" target="_blank">Banco C6</a></small></p>
                            </div>`;
                    negativoInput.value = '';
                }

                infoDiv.innerHTML = htmlAnalise;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }


            // ------------------------------------------------------------------
            // 3. LISTAGEM DE CONTRATOS (COM ORDENA√á√ÉO MAIOR -> MENOR)
            // ------------------------------------------------------------------
            const listaDiv = document.getElementById("listaEmprestimos");
            listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;

            const rgxEmprestimos = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g;
            let matches = [...text.matchAll(rgxEmprestimos)];

            // Array para armazenar os contratos antes de exibir
            let contratosEncontrados = [];

            matches.forEach((match, index) => {
                const [_, nomeBanco, valor, parcelasStr] = match;
                let cleanNomeBanco = nomeBanco.replace(/^\d+\s*-\s*/, '').trim()
                    .replace('EMPREST BCO PRIVADOS - ', '')
                    .replace('EMPREST BCO OFICIAL - ', '');

                const [pagas, total] = parcelasStr.split('/');
                const valorParcelaNum = moedaParaFloat(valor);

                if (parseInt(total, 10) > 900) return;

                const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10);
                const saldoAproximado = (parcelasRestantes >= 0) ? valorParcelaNum * parcelasRestantes * 0.70 : 0;

                // Adiciona ao array em vez de criar o HTML direto
                contratosEncontrados.push({
                    id: index,
                    banco: cleanNomeBanco,
                    valorParcela: valorParcelaNum,
                    saldo: saldoAproximado,
                    pagas: pagas,
                    total: total
                });
            });

            // *** ORDENA√á√ÉO (SORT) ***
            // Ordena do Maior Valor de Parcela para o Menor
            contratosEncontrados.sort((a, b) => b.valorParcela - a.valorParcela);

            if (contratosEncontrados.length === 0) {
                showToast("AVISO: Nenhum contrato de empr√©stimo v√°lido foi encontrado.", 'warning');
            } else {
                // Renderiza os contratos j√° ordenados
                contratosEncontrados.forEach((c, i) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'form-check border-bottom py-2';
                    // Note que usamos 'i' para o ID √∫nico no HTML agora, pois a ordem mudou
                    itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${c.saldo}" data-parcela="${c.valorParcela}" data-banco="${c.banco}" data-status="${c.pagas} de ${c.total}" id="loan-sorted-${i}"><label class="form-check-label" for="loan-sorted-${i}"><strong>${c.banco}</strong><br><small>Saldo Aprox.: ${formatarMoeda(c.saldo)} | Parcela: ${formatarMoeda(c.valorParcela)} | Status: ${c.pagas} de ${c.total}</small></label>`;
                    listaDiv.appendChild(itemDiv);
                });
            }

            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
            listaDiv.style.display = "block";
            document.getElementById("unificarBtnPdf").style.display = "block";
        }


        // ######################################################################
        // FUN√á√ÉO DE PARSE COM DETEC√á√ÉO AUTOM√ÅTICA
        // ######################################################################
        async function parsearPdf(event) {
            const file = event.target.files[0];
            if (!file) return;
            clienteNomePDF = ''; clienteCpfPDF = '';

            const loadingDiv = document.getElementById("loading");
            const loadingText = document.getElementById("loading-text"); // Certifique-se que este ID existe no seu HTML

            loadingText.textContent = 'Analisando...';
            loadingDiv.classList.remove('d-none');
            loadingDiv.classList.add('d-flex');
            document.getElementById('upload-text').style.display = 'none';
            // Limpa a lista de empr√©stimos anterior ao carregar novo PDF
            document.getElementById('listaEmprestimos').innerHTML = '';
            document.getElementById('listaEmprestimos').style.display = 'none';
            document.getElementById('unificarBtnPdf').style.display = 'none';


            const fileReader = new FileReader();
            fileReader.onload = async function () {
                let extractedText = ''; // Renomeado para evitar conflito de escopo
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let textFound = false;

                    // --- PLANO A: TENTATIVA DE LEITURA R√ÅPIDA ---
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();

                        if (textContent.items.length > 0) {
                            textFound = true;
                        }

                        extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n';
                    }

                    // --- GATILHO ---
                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNAT√ÅRIA') || extractedText.toUpperCase().includes('EMPR√âSTIMO') || extractedText.toUpperCase().includes('CPF') || extractedText.toUpperCase().includes('RUBRICA');

                    if (extractedText.trim().length < 50 || !hasRealData) {
                        textFound = false; // For√ßa o Plano B
                        console.log("Texto 'limpo' n√£o parece v√°lido. For√ßando OCR (Plano B).");
                    }


                    // --- PLANO B: FALLBACK PARA OCR (TESSERACT) ---
                    if (!textFound) {
                        console.warn("PDF parece ser uma imagem ou sem texto real. Iniciando OCR...");
                        extractedText = ''; // Reseta o texto

                        // Verifica se Tesseract est√° carregado antes de usar
                        if (typeof Tesseract === 'undefined') {
                            throw new Error("Tesseract.js n√£o foi carregado. Verifique a inclus√£o do script.");
                        }

                        // Cria o worker aqui para garantir que esteja definido
                        const worker = await Tesseract.createWorker('por'); // 'por' = Portugu√™s

                        for (let i = 1; i <= pdf.numPages; i++) {
                            loadingText.textContent = `Lendo imagem: P√°gina ${i} de ${pdf.numPages}...`;
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });

                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            await page.render({ canvasContext: context, viewport: viewport }).promise;

                            const { data: { text: ocrText } } = await worker.recognize(canvas);
                            extractedText += ocrText + '\n\n';
                        }

                        await worker.terminate(); // Libera recursos do worker
                        console.log("OCR Conclu√≠do.");
                    }
                    // --- FIM DO PLANO B ---

                    // **** IN√çCIO DA DETEC√á√ÉO AUTOM√ÅTICA ****
                    let convenioDetectado = 'exercito'; // Valor padr√£o
                    const convenioSelect = document.getElementById('convenioSelect');

                    // Verifica palavras-chave para SIAPE (mais espec√≠ficas primeiro)
                    if (extractedText.includes("Extrato de Consigna√ß√µes Vigentes") || extractedText.includes("Rubrica\nSequ√™ncia")) {
                        convenioDetectado = 'siape';
                        console.log("Conv√™nio detectado: SIAPE");
                    }
                    // Verifica palavras-chave para Ex√©rcito
                    else if (extractedText.includes("eConsig") || extractedText.includes("MARGEM CONSIGNACAO") || extractedText.includes("Consignat√°ria")) {
                        convenioDetectado = 'exercito';
                        console.log("Conv√™nio detectado: Ex√©rcito (eConsig)");
                    }
                    // Se nenhuma chave espec√≠fica for encontrada
                    else {
                        console.warn("N√£o foi poss√≠vel detectar o conv√™nio automaticamente com alta confian√ßa, usando padr√£o 'Ex√©rcito'.");
                        showToast("N√£o foi poss√≠vel detectar o conv√™nio. Verifique a sele√ß√£o.", "warning");
                        // Mant√©m 'exercito' como padr√£o
                    }

                    // Atualiza o select e a UI relacionada ao conv√™nio
                    convenioSelect.value = convenioDetectado;
                    atualizarOperacoes(); // Isso tamb√©m atualiza as opera√ß√µes e a visibilidade da UI

                    // Chama a fun√ß√£o de processamento correta com o texto extra√≠do
                    if (convenioDetectado === 'exercito') {
                        await processarPdfExercicio(extractedText);
                    } else { // Se for 'siape'
                        await processarPdfSiape(extractedText);
                    }
                    // **** FIM DA DETEC√á√ÉO AUTOM√ÅTICA ****


                    showToast("Extrato lido e conv√™nio detectado com sucesso!", "success");

                } catch (error) {
                    console.error("Erro ao processar o PDF:", error);
                    // Adiciona a mensagem de erro espec√≠fica ao Toast para melhor depura√ß√£o
                    showToast(`Ocorreu um erro ao ler o PDF: ${error.message}`, "danger");
                } finally {
                    loadingDiv.classList.add('d-none');
                    loadingDiv.classList.remove('d-flex');
                    document.getElementById('upload-text').style.display = 'block';
                    loadingText.textContent = 'Analisando...'; // Reseta o texto do loading
                }
            };
            fileReader.readAsArrayBuffer(file);
        }


        function unificarContratos(isManual) {
            let totalSaldo = 0, totalParcela = 0;
            parcelasSelecionadasPDF = [];

            if (isManual) {
                parcelasManuais.forEach(p => {
                    totalParcela += p.parcela;
                    const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0);
                    if (parcelasRestantes > 0) totalSaldo += p.parcela * parcelasRestantes * 0.70;
                });
            } else {
                const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkedBoxes.length === 0) return showToast("Selecione ao menos um contrato.", "warning");

                checkedBoxes.forEach(cb => {
                    totalSaldo += parseFloat(cb.dataset.saldo);
                    totalParcela += parseFloat(cb.dataset.parcela);
                    parcelasSelecionadasPDF.push({ banco: cb.dataset.banco, parcela: formatarMoeda(parseFloat(cb.dataset.parcela)), saldo: formatarMoeda(parseFloat(cb.dataset.saldo)), status: cb.dataset.status });
                });
            }

            const operacao = document.getElementById('operacaoSelect').value;
            if (operacao.includes('negativado')) {
                document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcela);
            } else {
                document.getElementById("parcela").value = formatarInputMoeda(totalParcela);
                document.getElementById("saldodevedor").value = formatarInputMoeda(totalSaldo);
            }

            if (!isManual) showToast("Valores unificados e preenchidos no formul√°rio.");
        }

        function renderizarListaManual() {
            const listaDiv = document.getElementById('manual-loans-list');
            listaDiv.innerHTML = '';
            if (parcelasManuais.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';
                parcelasManuais.forEach((p, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><strong>${p.banco}</strong> - ${formatarMoeda(p.parcela)}<br><small class="text-muted">${p.parcelasPagas} de ${p.totalParcelas}</small></div><button type="button" class="btn btn-outline-danger btn-sm" onclick="removerParcelaManual(${index})">X</button>`;
                    ul.appendChild(li);
                });
                listaDiv.appendChild(ul);
            }
            unificarContratos(true);
        }

        window.removerParcelaManual = (index) => { parcelasManuais.splice(index, 1); renderizarListaManual(); }

        function adicionarContratoManual() {
            const banco = document.getElementById('manualBanco').value || 'N√£o informado';
            const parcelaValor = moedaParaFloat(document.getElementById('manualParcela').value);
            const totalParcelas = parseInt(document.getElementById('manualTotalParcelas').value, 10);
            const parcelasPagas = parseInt(document.getElementById('manualParcelasPagas').value, 10);

            if (!parcelaValor || !totalParcelas || isNaN(parcelasPagas)) return showToast("Preencha valor e parcelas corretamente.", 'danger');
            if (parcelasPagas < 0 || totalParcelas <= 0 || parcelaValor <= 0) return showToast("Valores num√©ricos devem ser positivos.", 'danger');
            if (parcelasPagas > totalParcelas) return showToast("Pagas n√£o pode ser maior que o total.", 'danger');


            parcelasManuais.push({ banco, parcela: parcelaValor, totalParcelas, parcelasPagas });
            ['manualBanco', 'manualParcela', 'manualParcelasPagas'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('manualTotalParcelas').value = '96'; // Reset default
            renderizarListaManual();
            showToast("Contrato adicionado.");
        }


        function calcularNegativado() {
            let totalParcelas = 0, saldoFinal = 0;
            const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');

            if (isManualTabActive) {
                let saldoManual = 0;
                parcelasManuais.forEach(p => {
                    totalParcelas += p.parcela;
                    const restantes = p.totalParcelas - p.parcelasPagas;
                    if (restantes > 0) saldoManual += p.parcela * restantes * 0.70;
                });
                saldoFinal = saldoManual;
            } else {
                const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkedBoxes.length === 0) return showToast("Selecione ao menos um contrato do extrato PDF.", 'danger');
                checkedBoxes.forEach(cb => {
                    totalParcelas += parseFloat(cb.dataset.parcela);
                    saldoFinal += parseFloat(cb.dataset.saldo);
                });
            }

            if (totalParcelas === 0) return showToast("Nenhum contrato selecionado ou adicionado para calcular.", 'danger');

            const negativo = moedaParaFloat(document.getElementById("negativo").value);
            if (negativo <= 0) return showToast("Insira um valor negativo v√°lido (maior que zero).", 'danger');

            const novaParcela = totalParcelas - negativo;
            if (novaParcela < 0) {
                showToast("A nova parcela calculada √© negativa. Verifique os valores.", "warning");
                // Voc√™ pode optar por parar aqui ou continuar mostrando o resultado negativo
            }

            const nomeFinal = document.getElementById('clienteNome').value.trim() || clienteNomePDF;
            const cpfFinal = document.getElementById('clienteCpf').value.trim() || clienteCpfPDF;

            const operacao = document.getElementById('operacaoSelect').value;
            calculoDetalhado = { tipo: operacao, totalParcelas, negativo, novaParcela, saldoDevedor: saldoFinal, nome: nomeFinal, cpf: cpfFinal };

            document.getElementById("resultadoNegativadoContainer").style.display = "block";
            document.getElementById("resultadoNegativadoBody").innerHTML = `
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>Total Parcelas Originais:</span> <strong>${formatarMoeda(totalParcelas)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Valor Negativo:</span> <strong class="text-danger">- ${formatarMoeda(negativo)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Saldo Devedor Aprox.:</span> <strong>${formatarMoeda(saldoFinal)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between ${novaParcela < 0 ? 'bg-danger-subtle' : 'bg-success-subtle'}"><h4>Nova Parcela p/ C√°lculo:</h4> <h4 class="fw-bold">${formatarMoeda(novaParcela)}</h4></li>
                </ul>`;

            document.getElementById("resultadoNegativadoContainer").scrollIntoView({ behavior: 'smooth' });
        }


        // ##### NOVA FUN√á√ÉO PARA CALCULAR MARGEM NOVA #####
        function calcularMargemNova() {
            const operacao = document.getElementById('operacaoSelect').value;

            const nome = document.getElementById('mn-clienteNome').value;
            const cpf = document.getElementById('mn-clienteCpf').value;
            const banco = document.getElementById('mn-banco').value; // NOVO CAMPO
            const parcela = moedaParaFloat(document.getElementById('mn-parcela').value);
            const coeficiente = parseFloat(document.getElementById('mn-coeficiente').value.replace(",", ".")) || 0;
            const prazo = parseInt(document.getElementById('mn-prazo').value, 10) || 0;

            // Valida√ß√µes
            if (!nome || !cpf) return showToast('Preencha o Nome e CPF do cliente.', 'danger');
            if (!banco) return showToast('Preencha o Banco Destino.', 'danger'); // NOVO CAMPO
            if (!parcela || parcela <= 0) return showToast('Preencha um Valor de Parcela v√°lido.', 'danger');
            if (!coeficiente || coeficiente <= 0) return showToast('Preencha um Coeficiente v√°lido.', 'danger');
            if (!prazo || prazo <= 0) return showToast('Preencha um Prazo v√°lido.', 'danger');

            const valorLiberado = parcela / coeficiente;
            const valorTotalContrato = parcela * prazo;

            // Salva no objeto global para os PDFs
            calculoDetalhado = {
                tipo: operacao,
                nome: nome,
                cpf: cpf,
                novoBanco: banco, // NOVO CAMPO
                novaParcelaValor: parcela,
                coef: coeficiente,
                novoPrazo: prazo,
                valorLiberado: valorLiberado,
                valorTotalContrato: valorTotalContrato
            };

            // Exibe o resultado na tela
            const resultadoDiv = document.getElementById("resultadoFinal");
            resultadoDiv.innerHTML = `
                <div class="card">
                    <div class="card-header bg-primary text-white"><h3 class="h5 mb-0">Resultado da Simula√ß√£o de Margem Nova</h3></div>
                    <div class="card-body">
                        <div class="text-center mb-4 border-bottom pb-3">
                            <h4 class="text-muted">Valor Liberado (Estimado)</h4>
                            <p class="resultado-final-valor text-success">${formatarMoeda(valorLiberado)}</p>
                        </div>
                        <h5>Detalhamento:</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between"><span>Valor da Parcela:</span> <strong>${formatarMoeda(parcela)}</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>Prazo:</span> <strong>${prazo} meses</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>Coeficiente Usado:</span> <strong>${coeficiente.toFixed(8)}</strong></li>
                            <li class="list-group-item d-flex justify-content-between bg-light-subtle">
                                <strong>Valor Total do Contrato (Parcela x Prazo):</strong> 
                                <strong class="text-primary">${formatarMoeda(valorTotalContrato)}</strong>
                             </li>
                        </ul>
                    </div>
                    <div class="card-footer d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button id="baixarPdfClienteBtn" class="btn btn-success" type="button">Baixar PDF (Cliente)</button>
                        <button id="baixarPdfEscritorioBtn" class="btn btn-secondary" type="button">Baixar PDF (Escrit√≥rio)</button>
                    </div>
                </div>`;

            resultadoDiv.style.display = 'block';
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
            // Adiciona os listeners aos novos bot√µes
            document.getElementById("baixarPdfClienteBtn").addEventListener("click", gerarPDFCliente);
            document.getElementById("baixarPdfEscritorioBtn").addEventListener("click", gerarPDFEscritorio);
        }


        function calcularSimulacaoCompleta() {
            const operacao = document.getElementById('operacaoSelect').value;
            calculoDetalhado = { tipo: operacao };

            const p = moedaParaFloat(document.getElementById("parcela").value);
            const s = moedaParaFloat(document.getElementById("saldodevedor").value);
            const d = moedaParaFloat(document.getElementById("desconto").value); // Pode ser 0
            const coef = parseFloat(document.getElementById("coeficiente").value.replace(",", ".")) || 0;
            const comissaoG = parseFloat(document.getElementById("comissaoGerente").value.replace(",", ".")) || 0;
            const comissaoEsc = moedaParaFloat(document.getElementById("comissaoesc").value);

            const novoBanco = document.getElementById("novoBanco").value || 'Bradesco';
            const novoPrazo = parseInt(document.getElementById("novoPrazo").value, 10) || 96;

            // Valida√ß√µes Essenciais
            if (!p || p <= 0) return showToast('Preencha um Valor Total da Parcela v√°lido (maior que zero).', 'danger');
            if (!s || s < 0) return showToast('Preencha um Saldo Devedor Aprox. Total v√°lido (pode ser zero).', 'danger'); // Saldo pode ser 0
            if (!comissaoEsc || comissaoEsc < 0) return showToast('Preencha uma Comiss√£o Escrit√≥rio v√°lida (pode ser zero).', 'danger'); // Comiss√£o pode ser 0
            if (!coef || coef <= 0) return showToast('Preencha um Coeficiente v√°lido (maior que zero).', 'danger');
            if (comissaoG < 0 || comissaoG > 100) return showToast('Comiss√£o Gerente deve ser entre 0 e 100.', 'danger');
            if (novoPrazo <= 0) return showToast('Prazo do Novo Contrato deve ser positivo.', 'danger');


            const novoS = p / coef;
            // Pega nome/cpf dos campos de entrada manual se estiverem preenchidos, sen√£o usa os do PDF
            const nomeFinal = document.getElementById('clienteNome').value.trim() || clienteNomePDF;
            const cpfFinal = document.getElementById('clienteCpf').value.trim() || clienteCpfPDF;

            calculoDetalhado = { ...calculoDetalhado, nome: nomeFinal, cpf: cpfFinal, p, s, d, novoS, comissaoG, comissaoEsc, coef, novoBanco, novoPrazo, novaParcelaValor: p };

            let resultadoHtml = '', valorOfertaFinal = 0;

            if (operacao.includes('compra')) {
                const tipoCompra = document.getElementById("tipoCompra").value;
                const investidorR = (tipoCompra === 'bradesco') ? 0.10 : 0.08;
                const sub = novoS - s - d;
                const investidor = s * investidorR; // Comiss√£o investidor √© sobre o saldo devedor quitado
                const gerente = sub * (comissaoG / 100); // Comiss√£o gerente sobre o valor bruto liberado
                const valorGeral = sub - investidor - gerente;
                valorOfertaFinal = valorGeral - comissaoEsc;

                // A verifica√ß√£o de viabilidade deve considerar todas as dedu√ß√µes
                if (novoS < (s + d + investidor + gerente + comissaoEsc)) {
                    showToast('Opera√ß√£o N√£o Vi√°vel: O novo saldo gerado √© insuficiente para cobrir todas as despesas (saldo devedor, produto, comiss√µes).', 'danger');
                    // Limpa resultado anterior se houver
                    document.getElementById("resultadoFinal").innerHTML = '';
                    document.getElementById("resultadoFinal").style.display = 'none';
                    return;
                }


                calculoDetalhado = { ...calculoDetalhado, sub, investidorR, investidor, gerente, valorGeral, valorOfertaFinal };
                resultadoHtml = `
                    <li class="list-group-item d-flex justify-content-between"><span>Novo Saldo (Gerado pela Parcela):</span> <strong>${formatarMoeda(novoS)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Saldo Devedor a Quitar:</span> <span class="text-danger">- ${formatarMoeda(s)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Produto (Opcional):</span> <span class="text-danger">- ${formatarMoeda(d)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Bruto Dispon√≠vel:</span> <strong>${formatarMoeda(sub)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comiss√£o Investidor (${(investidorR * 100).toFixed(0)}% sobre Saldo):</span> <span class="text-danger">- ${formatarMoeda(investidor)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comiss√£o Gerente (${comissaoG}% sobre Bruto):</span> <span class="text-danger">- ${formatarMoeda(gerente)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Geral L√≠quido (antes Escrit√≥rio):</span> <strong>${formatarMoeda(valorGeral)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comiss√£o Escrit√≥rio:</span> <span class="text-danger">- ${formatarMoeda(comissaoEsc)}</span></li>`;

            } else { // Portabilidade ou Refin
                const valorBrutoLiberado = novoS - s - d; // Troco inicial
                let sub = valorBrutoLiberado;
                let valorQuitado = 0;
                let comissaoQuitado = 0;

                if (document.getElementById('quitacaoSim').checked) {
                    valorQuitado = moedaParaFloat(document.getElementById('valorQuitado').value);
                    if (valorQuitado < 0) return showToast('Valor a ser quitado n√£o pode ser negativo.', 'danger');
                    if (valorQuitado > 0) {
                        comissaoQuitado = valorQuitado * 0.10; // 10% sobre o valor quitado
                        sub -= (valorQuitado + comissaoQuitado); // Deduz do troco
                    }
                }

                const gerente = sub * (comissaoG / 100); // Comiss√£o gerente sobre o troco l√≠quido (ap√≥s quita√ß√£o se houver)
                const valorGeral = sub - gerente;
                valorOfertaFinal = valorGeral - comissaoEsc;

                // A verifica√ß√£o de viabilidade deve considerar todas as dedu√ß√µes
                if (novoS < (s + d + valorQuitado + comissaoQuitado + gerente + comissaoEsc)) {
                    showToast('Opera√ß√£o N√£o Vi√°vel: O novo saldo gerado √© insuficiente para cobrir todas as despesas (saldo devedor, produto, quita√ß√£o, comiss√µes).', 'danger');
                    document.getElementById("resultadoFinal").innerHTML = '';
                    document.getElementById("resultadoFinal").style.display = 'none';
                    return;
                }

                calculoDetalhado = { ...calculoDetalhado, valorBrutoLiberado, gerente, valorQuitado, comissaoQuitado, valorGeral, valorOfertaFinal };
                resultadoHtml = `
                    <li class="list-group-item d-flex justify-content-between"><span>Novo Saldo (Gerado pela Parcela):</span> <strong>${formatarMoeda(novoS)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Saldo Devedor a Quitar:</span> <span class="text-danger">- ${formatarMoeda(s)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Produto (Opcional):</span> <span class="text-danger">- ${formatarMoeda(d)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Bruto Liberado (Troco Inicial):</span> <strong>${formatarMoeda(valorBrutoLiberado)}</strong></li>
                    ${valorQuitado > 0 ? `<li class="list-group-item d-flex justify-content-between"><span>(-) Valor Quitado Adicional:</span> <span class="text-danger">- ${formatarMoeda(valorQuitado)}</span></li><li class="list-group-item d-flex justify-content-between"><span>(-) Comiss√£o Quita√ß√£o Adicional (10%):</span> <span class="text-danger">- ${formatarMoeda(comissaoQuitado)}</span></li>` : ''}
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comiss√£o Gerente (${comissaoG}% sobre L√≠quido):</span> <span class="text-danger">- ${formatarMoeda(gerente)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Geral L√≠quido (antes Escrit√≥rio):</span> <strong>${formatarMoeda(valorGeral)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comiss√£o Escrit√≥rio:</span> <span class="text-danger">- ${formatarMoeda(comissaoEsc)}</span></li>`;
            }

            // ########## IN√çCIO DA L√ìGICA DO COEFICIENTE REAL ##########
            let coeficienteReal = 0;
            // Evita divis√£o por zero. O saldo (s) pode ser 0 (ex: refin de margem)
            if ((valorOfertaFinal + s) > 0) {
                coeficienteReal = p / (valorOfertaFinal + s);
            }
            calculoDetalhado.coeficienteReal = coeficienteReal; // Salva no objeto de detalhes

            // Adiciona o Coeficiente Real ao HTML
            resultadoHtml += `<li class="list-group-item d-flex justify-content-between bg-light-subtle">
                                <strong>Coeficiente Real (Calculado):</strong> 
                                <strong class="text-primary">${coeficienteReal.toFixed(8)}</strong>
                             </li>`;
            // ########## FIM DA L√ìGICA DO COEFICIENTE REAL ##########


            const resultadoDiv = document.getElementById("resultadoFinal");
            resultadoDiv.innerHTML = `
                <div class="card">
                    <div class="card-header bg-primary text-white"><h3 class="h5 mb-0">Resultado da Simula√ß√£o</h3></div>
                    <div class="card-body">
                        <div class="text-center mb-4 border-bottom pb-3">
                            <h4 class="text-muted">Valor L√≠quido para o Cliente</h4>
                            <p class="resultado-final-valor text-success">${formatarMoeda(valorOfertaFinal)}</p>
                        </div>
                        <h5>Detalhamento:</h5>
                        <ul class="list-group list-group-flush">${resultadoHtml}</ul>
                    </div>
                    <div class="card-footer d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button id="baixarPdfClienteBtn" class="btn btn-success" type="button">Baixar PDF (Cliente)</button>
                        <button id="baixarPdfEscritorioBtn" class="btn btn-secondary" type="button">Baixar PDF (Escrit√≥rio)</button>
                    </div>
                </div>`;
            resultadoDiv.style.display = 'block';
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
            document.getElementById("baixarPdfClienteBtn").addEventListener("click", gerarPDFCliente);
            document.getElementById("baixarPdfEscritorioBtn").addEventListener("click", gerarPDFEscritorio);
        }


        function gerarPDFBase(doc, tipo) {
            const getBase64Image = (img) => { if (!img) return null; try { const c = document.createElement("canvas"); c.width = img.naturalWidth; c.height = img.naturalHeight; c.getContext("2d").drawImage(img, 0, 0); return c.toDataURL("image/png"); } catch (e) { console.error("Erro ao converter imagem para Base64:", e); return null; } };

            const selectedEmpresa = document.getElementById('empresaSelect').value;
            const logoId = (selectedEmpresa === 'polo') ? 'logo-polo' : (selectedEmpresa === 'estilo' ? 'logo-estilo' : 'logo-alianca');
            const logoPrincipalImg = document.getElementById(logoId);

            const convenio = document.getElementById('convenioSelect').value;
            const convenioLogoId = (convenio === 'exercito') ? 'convenio-logo-exercito' : 'convenio-logo-siape';
            const convenioImgElem = document.getElementById(convenioLogoId);

            const logoPrincipalBase64 = getBase64Image(logoPrincipalImg);
            const convenioBase64 = getBase64Image(convenioImgElem);
            let y = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const logoPrincipalWidth = 40, logoConvenioWidth = 30;
            // C√°lculo seguro da altura, evitando divis√£o por zero se a imagem n√£o carregar
            const logoPrincipalHeight = (logoPrincipalImg && logoPrincipalImg.naturalWidth > 0) ? logoPrincipalImg.naturalHeight * (logoPrincipalWidth / logoPrincipalImg.naturalWidth) : 0;
            const logoConvenioHeight = (convenioImgElem && convenioImgElem.naturalWidth > 0) ? convenioImgElem.naturalHeight * (logoConvenioWidth / convenioImgElem.naturalWidth) : 0;
            const maxHeight = Math.max(logoPrincipalHeight, logoConvenioHeight);

            if (logoPrincipalBase64) doc.addImage(logoPrincipalBase64, 'PNG', 15, y + (maxHeight - logoPrincipalHeight) / 2, logoPrincipalWidth, logoPrincipalHeight);
            if (convenioBase64) doc.addImage(convenioBase64, 'PNG', pageWidth - logoConvenioWidth - 15, y + (maxHeight - logoConvenioHeight) / 2, logoConvenioWidth, logoConvenioHeight);

            y += maxHeight > 0 ? maxHeight + 10 : 25; // Garante espa√ßo mesmo sem logos

            // Obt√©m o texto da opera√ß√£o selecionada de forma segura
            const operacaoSelectElement = document.getElementById('operacaoSelect');
            const operacaoText = operacaoSelectElement.options[operacaoSelectElement.selectedIndex]?.text || 'Opera√ß√£o Desconhecida';

            doc.setFontSize(18); doc.text(`Simula√ß√£o de ${operacaoText} (${tipo})`, pageWidth / 2, y, { align: 'center' }); y += 20; // Centralizado

            // ##### L√ìGICA DE DADOS DO CLIENTE ATUALIZADA #####
            // Pega o nome/cpf do objeto de c√°lculo, que foi preenchido pela fun√ß√£o de c√°lculo correta
            const nomeFinal = calculoDetalhado?.nome || 'N√£o informado';
            const cpfFinal = calculoDetalhado?.cpf || 'N√£o informado';

            doc.setFontSize(12); doc.text("Dados do Cliente", 15, y); y += 8;
            doc.setFontSize(10); doc.text(`Nome: ${nomeFinal}`, 15, y); y += 6; doc.text(`CPF: ${cpfFinal}`, 15, y);


            // ##### L√ìGICA DE CONTRATOS ATUALIZADA #####
            // S√≥ mostra a lista de contratos se N√ÉO for Margem Nova
            if (calculoDetalhado && !calculoDetalhado.tipo.includes('margem_nova')) {
                const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');
                const listaDeParcelas = isManualTabActive ? parcelasManuais.map(p => {
                    const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0);
                    const saldoManual = (parcelasRestantes > 0) ? p.parcela * parcelasRestantes * 0.70 : 0;
                    return { banco: p.banco, parcela: formatarMoeda(p.parcela), saldo: formatarMoeda(saldoManual), status: `${p.parcelasPagas || 0} de ${p.totalParcelas || 0}` };
                }) : parcelasSelecionadasPDF;

                if (listaDeParcelas && listaDeParcelas.length > 0) {
                    y += 16;
                    doc.setFontSize(12); doc.text("Contratos Unificados (Originais)", 15, y); y += 8;
                    doc.setFontSize(9);
                    listaDeParcelas.forEach(p => {
                        const linhaContrato = `- Banco: ${p.banco} | Parcela: ${p.parcela} | Saldo Aprox.: ${p.saldo} | Status: ${p.status}`;
                        const linhas = doc.splitTextToSize(linhaContrato, pageWidth - 30);
                        doc.text(linhas, 15, y);
                        y += (linhas.length * 4);
                    });
                } else {
                    y += 10;
                }
            } else {
                y += 10; // Adiciona um espa√ßo se for Margem Nova
            }


            y += 10;
            doc.setFontSize(12); doc.text("Dados do Novo Contrato", 15, y); y += 8;
            doc.setFontSize(10);

            // ##### L√ìGICA DO BANCO ATUALIZADA #####
            // Agora todas as opera√ß√µes (incluindo margem nova) preenchem 'novoBanco'
            let bancoNovoTexto = `Banco: ${calculoDetalhado?.novoBanco || '(N√£o especificado)'}`;
            doc.text(bancoNovoTexto, 15, y); y += 6;

            doc.text(`Prazo: ${calculoDetalhado?.novoPrazo || 'N√£o inf.'}x`, 15, y); y += 6;
            doc.text(`Valor da Parcela: ${formatarMoeda(calculoDetalhado?.novaParcelaValor)}`, 15, y); y += 6;

            return y; // Retorna a posi√ß√£o Y final para as fun√ß√µes seguintes
        }


        function gerarNomeArquivo(tipoPdf) {
            const dataFormatada = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            // Pega o nome do cliente direto do objeto de c√°lculo
            let nomeCliente = (calculoDetalhado?.nome || 'cliente').trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

            if (!nomeCliente) nomeCliente = 'cliente_desconhecido';
            const operacao = document.getElementById('operacaoSelect').value || 'calculo';
            return `${operacao}_${nomeCliente}_${tipoPdf}_${dataFormatada}.pdf`;
        }

        function gerarPDFCliente() {
            if (!calculoDetalhado || Object.keys(calculoDetalhado).length === 0) {
                showToast("Nenhum c√°lculo foi realizado ainda.", "warning");
                return;
            }
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let y = gerarPDFBase(doc, "Cliente");

            if (dadosNegativado) {
                y += 10; doc.setFontSize(12); doc.text("Resumo do C√°lculo Negativado", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Parcelas Originais: ${formatarMoeda(dadosNegativado.totalParcelas)}`, 15, y); y += 6;
                doc.text(`Valor Negativo Informado: ${formatarMoeda(dadosNegativado.negativo)}`, 15, y); y += 6;
                doc.text(`Nova Parcela Calculada: ${formatarMoeda(dadosNegativado.novaParcela)}`, 15, y);
                y += 6;
            }

            y += 10;
            doc.setFontSize(12);

            // ##### L√ìGICA DE RESULTADO ATUALIZADA #####
            if (calculoDetalhado.tipo.includes('margem_nova')) {
                doc.text("Resumo da Simula√ß√£o de Margem Nova", 15, y); y += 8;
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor Liberado (Estimado): ${formatarMoeda(calculoDetalhado.valorLiberado)}`, 15, y); y += 10;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Valor Total do Contrato: ${formatarMoeda(calculoDetalhado.valorTotalContrato)}`, 15, y);

            } else { // L√≥gica antiga para Port/Refin/Compra
                doc.text("Resumo da Opera√ß√£o Simulada", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Saldo Devedor Total a Quitar (Aprox.): ${formatarMoeda(calculoDetalhado.s)}`, 15, y); y += 10;
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor L√≠quido Estimado para o Cliente: ${formatarMoeda(calculoDetalhado.valorOfertaFinal)}`, 15, y);
                y += 10;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Coeficiente Real (para confer√™ncia): ${calculoDetalhado.coeficienteReal ? calculoDetalhado.coeficienteReal.toFixed(8) : 'N/A'}`, 15, y);
            }

            y += 15;
            doc.setFontSize(8); doc.setFont('helvetica', 'italic');
            doc.text("Valores aproximados. A proposta final pode variar.", 15, y);

            doc.save(gerarNomeArquivo('cliente'));
        }


        function gerarPDFEscritorio() {
            if (!calculoDetalhado || Object.keys(calculoDetalhado).length === 0) {
                showToast("Nenhum c√°lculo foi realizado ainda.", "warning");
                return;
            }
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let y = gerarPDFBase(doc, "Escrit√≥rio");

            if (dadosNegativado) {
                y += 10; doc.setFontSize(12); doc.text("Resumo do C√°lculo Negativado", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Parcelas Originais: ${formatarMoeda(dadosNegativado.totalParcelas)}`, 15, y); y += 6;
                doc.text(`Valor Negativo Informado: ${formatarMoeda(dadosNegativado.negativo)}`, 15, y); y += 6;
                doc.text(`Nova Parcela Calculada: ${formatarMoeda(dadosNegativado.novaParcela)}`, 15, y);
                y += 6;
            }

            y += 10;
            doc.setFontSize(12);

            // ##### L√ìGICA DE RESULTADO ATUALIZADA #####
            if (calculoDetalhado.tipo.includes('margem_nova')) {
                doc.text("Detalhes da Opera√ß√£o (Uso Interno)", 15, y); y += 8; doc.setFontSize(10);
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor Liberado (Estimado): ${formatarMoeda(calculoDetalhado.valorLiberado)}`, 15, y); y += 10;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Valor Total do Contrato: ${formatarMoeda(calculoDetalhado.valorTotalContrato)}`, 15, y); y += 6;
                doc.text(`Coeficiente Informado: ${calculoDetalhado.coef ? calculoDetalhado.coef.toFixed(8) : 'N/A'}`, 15, y);

            } else { // L√≥gica antiga para Port/Refin/Compra
                doc.text("Detalhes da Opera√ß√£o (Uso Interno)", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Novo Saldo (Gerado pela Parcela): ${formatarMoeda(calculoDetalhado.novoS)}`, 15, y); y += 6;
                doc.text(`Saldo Devedor a Quitar: ${formatarMoeda(calculoDetalhado.s)}`, 15, y); y += 6;
                doc.text(`Produto (Opcional): ${formatarMoeda(calculoDetalhado.d)}`, 15, y); y += 6;
                doc.text("--------------------------------------------------", 15, y); y += 6;

                if (calculoDetalhado.tipo.includes('compra')) {
                    doc.text(`Valor Bruto Dispon√≠vel: ${formatarMoeda(calculoDetalhado.sub)}`, 15, y); y += 6;
                    doc.text(`Comiss√£o Investidor (${(calculoDetalhado.investidorR * 100).toFixed(0)}% sobre Saldo): - ${formatarMoeda(calculoDetalhado.investidor)}`, 15, y); y += 6;
                    doc.text(`Comiss√£o Gerente (${calculoDetalhado.comissaoG}% sobre Bruto): - ${formatarMoeda(calculoDetalhado.gerente)}`, 15, y); y += 6;
                } else {
                    doc.text(`Valor Bruto Liberado (Troco Inicial): ${formatarMoeda(calculoDetalhado.valorBrutoLiberado)}`, 15, y); y += 6;
                    if (calculoDetalhado.valorQuitado > 0) {
                        doc.text(`Valor Quitado Adicional: - ${formatarMoeda(calculoDetalhado.valorQuitado)}`, 15, y); y += 6;
                        doc.text(`Comiss√£o Quita√ß√£o Adicional (10%): - ${formatarMoeda(calculoDetalhado.comissaoQuitado)}`, 15, y); y += 6;
                    }
                    doc.text(`Comiss√£o Gerente (${calculoDetalhado.comissaoG}% sobre L√≠quido): - ${formatarMoeda(calculoDetalhado.gerente)}`, 15, y); y += 6;
                }

                doc.setFont('helvetica', 'bold');
                doc.text(`Valor Geral L√≠quido (antes Escrit√≥rio): ${formatarMoeda(calculoDetalhado.valorGeral)}`, 15, y); y += 6;
                doc.setFont('helvetica', 'normal');
                doc.text(`Comiss√£o Escrit√≥rio: - ${formatarMoeda(calculoDetalhado.comissaoEsc)}`, 15, y); y += 8;
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor L√≠quido Cliente (Estimado): ${formatarMoeda(calculoDetalhado.valorOfertaFinal)}`, 15, y);
                y += 10;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Coeficiente Input (Simula√ß√£o): ${calculoDetalhado.coef ? calculoDetalhado.coef.toFixed(8) : 'N/A'}`, 15, y); y += 6;
                doc.text(`Coeficiente Real (Calculado): ${calculoDetalhado.coeficienteReal ? calculoDetalhado.coeficienteReal.toFixed(8) : 'N/A'}`, 15, y);
            }

            y += 15;
            doc.setFontSize(8); doc.setFont('helvetica', 'italic');
            doc.text("Valores aproximados para an√°lise interna.", 15, y);


            doc.save(gerarNomeArquivo('escritorio'));
        }


        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('upload-label');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('hover');
                if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].type === "application/pdf") {
                    document.getElementById('pdf-upload').files = e.dataTransfer.files;
                    document.getElementById('pdf-upload').dispatchEvent(new Event('change'));
                } else if (e.dataTransfer.files.length > 0) {
                    showToast("Por favor, arraste apenas arquivos PDF.", "warning");
                }
            });

            document.getElementById("pdf-upload").addEventListener("change", parsearPdf);
            document.getElementById("unificarBtnPdf").addEventListener("click", () => unificarContratos(false));
            document.getElementById('addManualBtn').addEventListener('click', adicionarContratoManual);
            document.getElementById('convenioSelect').addEventListener('change', atualizarOperacoes);
            document.getElementById('operacaoSelect').addEventListener('change', atualizarVisibilidadeUI);

            document.getElementById("calcForm").addEventListener("submit", function (e) {
                e.preventDefault();

                const operacao = document.getElementById('operacaoSelect').value;
                if (!operacao) {
                    showToast("Selecione um Tipo de Opera√ß√£o.", "warning");
                    return;
                }

                // ##### ROTEAMENTO DA L√ìGICA DE C√ÅLCULO #####
                if (operacao.includes('margem_nova')) {
                    calcularMargemNova();

                } else if (operacao.includes('negativado')) {
                    if (!document.getElementById("negativo").value) {
                        showToast("Preencha o Valor Negativo do Cliente.", "warning");
                        document.getElementById("negativo").focus();
                        return;
                    }
                    const isManual = document.getElementById('manual-tab').classList.contains('active');
                    const hasContracts = isManual ? parcelasManuais.length > 0 : document.querySelectorAll('.loan-checkbox:checked').length > 0;
                    if (!hasContracts) {
                        showToast("Selecione ou adicione contratos antes de calcular o negativado.", "warning");
                        return;
                    }
                    calcularNegativado();

                } else { // Port/Refin/Compra
                    if (!document.getElementById("parcela").value || !document.getElementById("saldodevedor").value || !document.getElementById("coeficiente").value || !document.getElementById("comissaoGerente").value || !document.getElementById("comissaoesc").value) {
                        showToast("Preencha todos os campos obrigat√≥rios da simula√ß√£o (Parcela, Saldo, Coeficiente, Comiss√µes).", "warning");
                        return;
                    }
                    calcularSimulacaoCompleta();
                }
            });

            document.getElementById('goToPortabilidadeBtn').addEventListener('click', () => {
                if (!calculoDetalhado || calculoDetalhado.novaParcela === undefined) {
                    showToast("Realize o c√°lculo de negativado primeiro.", "warning");
                    return;
                }
                sessionStorage.setItem('calculoNegativadoData', JSON.stringify(calculoDetalhado));
                const convenio = document.getElementById('convenioSelect').value;
                const opValue = (convenio === 'exercito') ? 'portabilidade_exercito' : 'portabilidade_siape';

                document.getElementById('convenioSelect').value = convenio;
                atualizarOperacoes();
                document.getElementById('operacaoSelect').value = opValue;

                verificarDadosNegativado();
                atualizarVisibilidadeUI();
                document.getElementById('simulacaoCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });


            document.getElementById('goToCompraBtn').addEventListener('click', () => {
                if (!calculoDetalhado || calculoDetalhado.novaParcela === undefined) {
                    showToast("Realize o c√°lculo de negativado primeiro.", "warning");
                    return;
                }
                sessionStorage.setItem('calculoNegativadoData', JSON.stringify(calculoDetalhado));
                const convenio = document.getElementById('convenioSelect').value;
                const opValue = (convenio === 'exercito') ? 'compra_exercito' : 'compra_siape';

                document.getElementById('convenioSelect').value = convenio;
                atualizarOperacoes();
                document.getElementById('operacaoSelect').value = opValue;

                verificarDadosNegativado();
                atualizarVisibilidadeUI();
                document.getElementById('simulacaoCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });


            document.querySelectorAll('input[name="quitacao"]').forEach(r => r.addEventListener('change', function () {
                const quitadoContainer = document.getElementById('quitadoContainer');
                quitadoContainer.style.display = this.value === 'sim' ? 'block' : 'none';
                if (this.value === 'nao') {
                    document.getElementById('valorQuitado').value = '';
                }
            }));

            // Aplica m√°scara de moeda aos campos relevantes
            ['#manualParcela', '#negativo', '#parcela', '#saldodevedor', '#desconto', '#valorQuitado', '#comissaoesc', '#mn-parcela'].forEach(selector => {
                const el = document.querySelector(selector);
                if (el) {
                    el.addEventListener('blur', function () {
                        if (this.value.trim() !== "") {
                            const valorNum = moedaParaFloat(this.value);
                            this.value = formatarInputMoeda(valorNum);
                        }
                    });
                    el.addEventListener('focus', function () {
                        if (this.value.trim() !== "") {
                            const valorNum = moedaParaFloat(this.value);
                            this.value = (valorNum === 0) ? '' : valorNum.toString().replace('.', ',');
                        }
                    });
                }
            });


            // Inicializa a UI
            verificarDadosNegativado();
            atualizarOperacoes();
        });

    </script>
</body>

</html>