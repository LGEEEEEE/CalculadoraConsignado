<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Calculadora Unificada - Consignado Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../icone.ico" type="image/x-icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
        }

        .btn-voltar {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1030;
        }

        /* NOVO: Bot√£o Tutorial Fixo */
        .btn-tutorial {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1030;
            background-color: #fff;
            color: #0d6efd;
            border: 1px solid #0d6efd;
        }

        .btn-tutorial:hover {
            background-color: #0d6efd;
            color: #fff;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding-bottom: 100px;
            margin-top: 60px;
            /* Espa√ßo para os bot√µes fixos */
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #333;
            padding: 1rem;
        }

        /* Estilo da √Årea de Upload */
        .upload-area {
            border: 2px dashed #0d6efd;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: background-color 0.2s, border-color 0.2s;
            border-radius: 8px;
        }

        .upload-area.hover {
            background-color: #e9ecef;
            border-color: #0b5ed7;
        }

        #pdf-upload {
            display: none;
        }

        #loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Toast de Notifica√ß√£o */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }

        .toast {
            width: 350px;
            max-width: 100%;
        }

        .resultado-final-valor {
            font-size: 2.5rem;
            font-weight: 800;
            color: #198754;
            /* Verde Sucesso */
        }

        .logos {
            display: none;
        }

        /* Ajuste do bot√£o de busca */
        .btn-search-group {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* Script Box */
        .script-box {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            font-family: monospace;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .script-box:hover {
            background-color: #c8e6c9;
        }

        /* Resultado Card Style (Igual foto) */
        .card-resultado-header {
            background-color: #0d6efd;
            /* Azul Bradesco/Padr√£o */
            color: white;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
    </style>
</head>

<body>
    <a href="/index.html" class="btn btn-secondary btn-voltar"><i class="bi bi-arrow-left"></i> Voltar</a>

    <button class="btn btn-sm btn-tutorial rounded-pill" onclick="abrirModalInstrucoes()">
        <i class="bi bi-question-circle-fill"></i> Tutorial / Integra√ß√£o
    </button>

    <div class="toast-container" id="toast-container"></div>

    <div class="logos">
        <img src="../images/logoheader.png" id="logo-alianca">
        <img src="../images/polo-promotora.png" id="logo-polo">
        <img src="../images/estilo-promotora.png" id="logo-estilo">
        <img src="../images/exercito.png" id="convenio-logo-exercito">
        <img src="../images/siape.png" id="convenio-logo-siape">
    </div>

    <div class="container" id="page-container">
        <h1 class="text-center h3 mb-4" id="pageTitle"><i class="bi bi-calculator"></i> Calculadora Consignado</h1>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="bi bi-sliders"></i> Sele√ß√£o da Opera√ß√£o</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="convenioSelect" class="form-label">1. Conv√™nio</label>
                        <select id="convenioSelect" class="form-select">
                            <option value="siape" selected>SIAPE</option>
                            <option value="exercito">Ex√©rcito (eConsig)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="operacaoSelect" class="form-label">2. Tipo de Opera√ß√£o</label>
                        <select id="operacaoSelect" class="form-select"></select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="bi bi-building"></i> Empresa Respons√°vel</h2>
            </div>
            <div class="card-body">
                <div class="mb-0">
                    <label for="empresaSelect" class="form-label">Empresa Respons√°vel pela Simula√ß√£o</label>
                    <select id="empresaSelect" class="form-select" onchange="atualizarScript()">
                        <option value="polo" selected>Polo Promotora</option>
                        <option value="alianca">Alian√ßa Consig</option>
                        <option value="estilo">Estilo Promotora</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="infoNegativado" class="alert alert-warning" style="display:none;"></div>

        <form id="calcForm">
            <div class="card mb-4" id="clienteCard">
                <div class="card-header">
                    <h2 class="h5 mb-0"><i class="bi bi-person-vcard"></i> 1. Dados do Cliente e Contratos</h2>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="entryTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pdf-tab" data-bs-toggle="tab"
                                data-bs-target="#pdf-tab-pane" type="button" role="tab"><i
                                    class="bi bi-file-earmark-pdf"></i> Carregar Extrato</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-tab" data-bs-toggle="tab"
                                data-bs-target="#manual-tab-pane" type="button" role="tab"><i
                                    class="bi bi-keyboard"></i> Inserir / Integra√ß√£o</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="entryTabContent">
                        <div class="tab-pane fade show active p-3" id="pdf-tab-pane" role="tabpanel">
                            <input type="file" id="pdf-upload" accept=".pdf">
                            <label for="pdf-upload" class="upload-area" id="upload-label">
                                <span id="upload-text"><i class="bi bi-cloud-upload fs-4"></i><br>Clique ou arraste o
                                    extrato PDF</span>
                                <div id="loading" class="d-none align-items-center justify-content-center mt-2">
                                    <div class="spinner-border text-primary" id="loading-spinner" role="status"></div>
                                    <strong class="ms-2" id="loading-text">Analisando...</strong>
                                </div>
                            </label>

                            <div id="listaEmprestimos" class="mt-3" style="display:none;"></div>
                            <button type="button" id="unificarBtnPdf" class="btn btn-info w-100 mt-3 text-white"
                                style="display:none;"><i class="bi bi-check-circle"></i> Usar Contratos
                                Selecionados</button>
                        </div>

                        <div class="tab-pane fade p-3" id="manual-tab-pane" role="tabpanel">

                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <h4 class="h6 mb-0 text-primary">Entrada de Dados</h4>
                                <button type="button" class="btn btn-sm btn-info text-white"
                                    onclick="abrirModalInstrucoes()">
                                    <i class="bi bi-gear-fill"></i> Configurar Integra√ß√£o
                                </button>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-2">
                                    <label for="clienteNome" class="form-label">Nome do Cliente</label>
                                    <input type="text" id="clienteNome" class="form-control" onblur="atualizarScript()">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="clienteCpf" class="form-label">CPF do Cliente</label>
                                    <div class="input-group">
                                        <input type="text" id="clienteCpf" class="form-control"
                                            placeholder="000.000.000-00">

                                        <button class="btn btn-primary dropdown-toggle btn-search-group" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-search"></i> Buscar no Sistema
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="buscarClientePolo()">üî¥ Abrir
                                                    GConsig / Polo</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="buscarClienteCorban()">üîµ
                                                    Abrir Corban</a></li>
                                        </ul>
                                    </div>
                                    <small class="text-muted" style="font-size: 0.75rem;">Selecione o sistema para abrir
                                        a ficha do cliente.</small>
                                </div>
                            </div>

                            <div class="p-3 mb-3 border rounded bg-light">
                                <h3 class="fs-5 text-center mb-3"><i class="bi bi-plus-circle"></i> Adicionar Contratos
                                </h3>
                                <div class="row g-2">
                                    <div class="col-md-7 mb-2">
                                        <label for="manualBanco" class="form-label">Banco</label>
                                        <input type="text" id="manualBanco" class="form-control">
                                    </div>
                                    <div class="col-md-5 mb-2">
                                        <label for="manualParcela" class="form-label">Valor Parcela</label>
                                        <input type="text" id="manualParcela" class="form-control">
                                    </div>
                                    <div class="col-6 col-md-4 mb-2">
                                        <label for="manualTotalParcelas" class="form-label">Total</label>
                                        <input type="number" id="manualTotalParcelas" class="form-control" value="96">
                                    </div>
                                    <div class="col-6 col-md-4 mb-2">
                                        <label for="manualParcelasPagas" class="form-label">Pagas</label>
                                        <input type="number" id="manualParcelasPagas" class="form-control">
                                    </div>
                                    <div class="col-12 col-md-4 d-flex align-items-end mb-2">
                                        <button type="button" id="addManualBtn"
                                            class="btn btn-secondary w-100">Adicionar</button>
                                    </div>
                                </div>
                                <div id="manual-loans-list" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="simulacaoCard">
                <div class="card-header">
                    <h2 class="h5 mb-0" id="simulacaoTitle"><i class="bi bi-calculator-fill"></i> 2. Dados da Simula√ß√£o
                    </h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div id="negativado-fields" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Soma das parcelas:</label>
                                <h4 id="totalParcelasDisplay" class="fw-bold text-primary">R$ 0,00</h4>
                            </div>
                            <div class="mb-3">
                                <label for="negativo" class="form-label">Valor Negativo do Cliente</label>
                                <input type="text" id="negativo" class="form-control" placeholder="Ex: 1000,00"
                                    required>
                            </div>
                        </div>

                        <div id="simulacao-fields" style="display:block;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="parcela" class="form-label">Valor Total da Parcela</label>
                                    <input type="text" id="parcela" class="form-control" required
                                        placeholder="Unificado do passo anterior">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="saldodevedor" class="form-label">Saldo Devedor Aprox. Total</label>
                                    <input type="text" id="saldodevedor" class="form-control" required
                                        placeholder="Unificado do passo anterior">
                                </div>
                            </div>

                            <div class="p-3 mb-3 border rounded">
                                <h5 class="fs-6 text-primary mb-3">Dados do Novo Contrato</h5>
                                <div class="row">
                                    <div class="col-md-8 mb-2">
                                        <label for="novoBanco" class="form-label">Banco Destino</label>
                                        <input type="text" id="novoBanco" class="form-control" value="Bradesco">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label for="novoPrazo" class="form-label">Prazo (meses)</label>
                                        <input type="number" id="novoPrazo" class="form-control" value="96">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="desconto" class="form-label">Produto (Opcional)</label>
                                    <input type="text" id="desconto" class="form-control" placeholder="Ex: 1.000,00">
                                </div>
                            </div>

                            <div id="port-refin-fields" style="display:none;">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Houve quita√ß√£o de algum valor?</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="quitacao"
                                                id="quitacaoNao" value="nao" checked>
                                            <label class="form-check-label" for="quitacaoNao">N√£o</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="quitacao"
                                                id="quitacaoSim" value="sim">
                                            <label class="form-check-label" for="quitacaoSim">Sim</label>
                                        </div>
                                    </div>
                                </div>
                                <div id="quitadoContainer" style="display:none;" class="col-md-12 mb-3">
                                    <label for="valorQuitado" class="form-label">Valor a ser quitado</label>
                                    <input type="text" id="valorQuitado" class="form-control"
                                        placeholder="Ex: 5.000,00">
                                </div>
                            </div>

                            <div id="compra-fields" style="display:block;">
                                <div class="col-md-12 mb-3">
                                    <label for="tipoCompra" class="form-label">Tipo de Compra</label>
                                    <select id="tipoCompra" class="form-select">
                                        <option value="bradesco" selected>Bradesco (Inv. 10%)</option>
                                        <option value="cef">Caixa (CEF) (Inv. 8%)</option>
                                    </select>
                                </div>
                            </div>

                            <hr class="my-3">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="coeficiente" class="form-label">Coeficiente</label>
                                    <input type="text" id="coeficiente" class="form-control" value="0.02" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="comissaoGerente" class="form-label">Comiss√£o Gerente (%)</label>
                                    <input type="text" id="comissaoGerente" class="form-control" value="15" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="comissaoesc" class="form-label">Comiss√£o Escrit√≥rio</label>
                                    <input type="text" id="comissaoesc" class="form-control" value="100">
                                </div>
                            </div>
                        </div>

                        <div id="margem-nova-fields" style="display:none;">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-2">
                                    <label for="mn-clienteNome" class="form-label">Nome do Cliente</label>
                                    <input type="text" id="mn-clienteNome" class="form-control" required
                                        onblur="atualizarScript()">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="mn-clienteCpf" class="form-label">CPF do Cliente</label>
                                    <input type="text" id="mn-clienteCpf" class="form-control"
                                        placeholder="000.000.000-00" required>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="mn-banco" class="form-label">Banco Destino</label>
                                    <input type="text" id="mn-banco" class="form-control" value="Bradesco" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="mn-parcela" class="form-label">Valor da Parcela (Margem)</label>
                                    <input type="text" id="mn-parcela" class="form-control" required
                                        placeholder="Ex: 350,00">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="mn-coeficiente" class="form-label">Coeficiente</label>
                                    <input type="text" id="mn-coeficiente" class="form-control" required value="0.023">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="mn-prazo" class="form-label">Prazo (meses)</label>
                                    <input type="number" id="mn-prazo" class="form-control" required value="96">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary w-100 btn-lg" type="submit" id="submitBtn"><i
                            class="bi bi-calculator"></i> Calcular</button>
                </div>
            </div>
        </form>

        <div class="card mt-4 border-success mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-whatsapp"></i> 3. Script de Abordagem</span>
                <span class="badge bg-white text-success">Autom√°tico</span>
            </div>
            <div class="card-body">
                <div class="row mb-3 g-3">
                    <div class="col-md-6">
                        <label class="form-label small">Seu Nome (Correspondente)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                            <input type="text" class="form-control" id="nomeCorrespondente"
                                placeholder="Ex: Luiz Gustavo" onblur="atualizarScript()">
                        </div>
                        <div class="form-text">Salvo automaticamente no navegador.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small">Telefone do Cliente (Opcional)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                            <input type="text" class="form-control" id="telefoneCliente" placeholder="5511999999999">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small">Tratamento:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="generoCliente" id="generoM" value="M" checked
                            onchange="atualizarScript()">
                        <label class="btn btn-outline-success" for="generoM">O Senhor</label>

                        <input type="radio" class="btn-check" name="generoCliente" id="generoF" value="F"
                            onchange="atualizarScript()">
                        <label class="btn btn-outline-success" for="generoF">A Senhora</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small">Mensagem Gerada (Clique para copiar):</label>
                    <textarea id="scriptOutput" class="form-control script-box" rows="11" readonly
                        onclick="copiarScript()"></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-success fw-bold" type="button" onclick="abrirWhatsApp()">
                        <i class="bi bi-whatsapp"></i> Iniciar Conversa no WhatsApp Web
                    </button>
                </div>
            </div>
        </div>

        <div id="resultadoFinal" class="mt-4" style="display:none;"></div>
        <div id="resultadoNegativadoContainer" class="mt-4" style="display:none;">
            <div class="card bg-light">
                <div class="card-header">
                    <h3 class="h5 mb-0">3. Resultado da An√°lise</h3>
                </div>
                <div class="card-body" id="resultadoNegativadoBody"></div>
                <div class="card-footer text-center">
                    <p class="mb-2">Avan√ßar para a simula√ß√£o de:</p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button class="btn btn-primary" id="goToPortabilidadeBtn" type="button">Portabilidade</button>
                        <button class="btn btn-secondary" id="goToCompraBtn" type="button">Compra de D√≠vida</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalInstrucoes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-question-circle-fill"></i> Central de Ajuda</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-0">
                    <ul class="nav nav-tabs nav-fill" id="helpTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="tutorial-tab" data-bs-toggle="tab"
                                data-bs-target="#tutorial-pane" type="button">
                                <i class="bi bi-book"></i> Como Usar a Calculadora
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="integracao-tab" data-bs-toggle="tab"
                                data-bs-target="#integracao-pane" type="button">
                                <i class="bi bi-lightning-charge-fill"></i> Instalar Integra√ß√£o (Rob√¥)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-4" id="helpTabContent">

                        <div class="tab-pane fade show active" id="tutorial-pane" role="tabpanel">
                            <h5 class="text-primary mb-3">Guia R√°pido de Uso</h5>

                            <div class="accordion" id="accordionTutorial">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#passo1">
                                            <strong>1. Configura√ß√£o Inicial</strong>
                                        </button>
                                    </h2>
                                    <div id="passo1" class="accordion-collapse collapse show"
                                        data-bs-parent="#accordionTutorial">
                                        <div class="accordion-body small">
                                            No topo da p√°gina, selecione o <strong>Conv√™nio</strong> (SIAPE ou Ex√©rcito)
                                            e o <strong>Tipo de Opera√ß√£o</strong> (Compra, Portabilidade, etc.).
                                            Isso ajusta automaticamente os coeficientes e as regras de c√°lculo.
                                            Selecione tamb√©m a <strong>Empresa Respons√°vel</strong> para que o logotipo
                                            correto saia no PDF.
                                        </div>
                                    </div>
                                </div>

                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#passo2">
                                            <strong>2. Inser√ß√£o de Dados (Cliente e Contratos)</strong>
                                        </button>
                                    </h2>
                                    <div id="passo2" class="accordion-collapse collapse"
                                        data-bs-parent="#accordionTutorial">
                                        <div class="accordion-body small">
                                            Voc√™ tem tr√™s formas de inserir os dados:
                                            <ul>
                                                <li><strong>PDF:</strong> Arraste o extrato do cliente para a √°rea
                                                    pontilhada. O sistema ler√° os contratos automaticamente.</li>
                                                <li><strong>Integra√ß√£o (Recomendado):</strong> Use o bot√£o "Configurar
                                                    Integra√ß√£o" (veja a pr√≥xima aba) para puxar dados direto do CRM
                                                    (Polo/Corban).</li>
                                                <li><strong>Manual:</strong> V√° na aba "Inserir Manualmente" e digite os
                                                    dados contrato por contrato.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#passo3">
                                            <strong>3. Simula√ß√£o e Resultados</strong>
                                        </button>
                                    </h2>
                                    <div id="passo3" class="accordion-collapse collapse"
                                        data-bs-parent="#accordionTutorial">
                                        <div class="accordion-body small">
                                            Ap√≥s carregar os contratos, clique em <strong>"Usar Selecionados"</strong>
                                            ou v√° para o card de Simula√ß√£o.
                                            <br>Verifique os valores de Parcela Total e Saldo Devedor. Ajuste o
                                            <strong>Coeficiente</strong> e as <strong>Comiss√µes</strong> se necess√°rio.
                                            <br>Clique em <strong>CALCULAR AGORA</strong> para ver o valor l√≠quido
                                            estimado e gerar os PDFs.
                                        </div>
                                    </div>
                                </div>

                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#passo4">
                                            <strong>4. Script de Vendas (WhatsApp)</strong>
                                        </button>
                                    </h2>
                                    <div id="passo4" class="accordion-collapse collapse"
                                        data-bs-parent="#accordionTutorial">
                                        <div class="accordion-body small">
                                            No final da p√°gina, o sistema gera uma mensagem pronta.
                                            <ul>
                                                <li>O sistema detecta o hor√°rio (Bom dia/Boa tarde).</li>
                                                <li>Tenta identificar o g√™nero do cliente pelo nome (O Senhor/A
                                                    Senhora).</li>
                                                <li>Seu nome fica salvo para as pr√≥ximas vezes.</li>
                                            </ul>
                                            Clique em <strong>Iniciar Conversa</strong> para abrir o WhatsApp Web
                                            diretamente.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="integracao-pane" role="tabpanel">
                            <div class="alert alert-success small">
                                <i class="bi bi-robot"></i> <strong>Automa√ß√£o:</strong> Este c√≥digo cria um bot√£o nos
                                seus favoritos que "l√™" a tela do CRM (Polo/Corban) e preenche a calculadora sozinho.
                            </div>

                            <p class="small fw-bold">Como instalar:</p>
                            <ol class="small">
                                <li>Copie o c√≥digo da caixa abaixo.</li>
                                <li>No seu navegador, crie um novo favorito na barra de favoritos.</li>
                                <li>No campo <strong>Nome</strong>, digite: <code>>>> ENVIAR DADOS</code>.</li>
                                <li>No campo <strong>URL</strong>, cole o c√≥digo copiado.</li>
                                <li>Pronto! Quando estiver na tela do cliente no CRM, clique nesse favorito.</li>
                            </ol>

                            <label class="form-label small text-muted">C√≥digo Javascript:</label>
                            <textarea class="form-control mb-3 bg-light" rows="6" readonly id="codeUniversal"
                                style="font-family: monospace; font-size: 0.7rem;">javascript:(function(){const moeda=(v)=>parseFloat(String(v).replace("R$","").replace(/\./g,"").replace(",","."))||0;let telefone="";try{if(document.querySelector('a[href^="tel:"]'))telefone=document.querySelector('a[href^="tel:"]').innerText.replace(/\D/g,'');else if(document.querySelector('a[href^="callto:"]'))telefone=document.querySelector('a[href^="callto:"]').getAttribute('href').replace('callto:','').replace(/\D/g,'');else{const hot=document.getElementById('telefonesHot');if(hot)telefone=hot.innerText.match(/\d{10,11}/)?.[0]||""}}catch(e){console.log("Tel err")}if(document.getElementById("tbodyContratos")){try{console.log("POLO");const nome=document.querySelector('span[data-info="Nome"]')?.innerText?.trim()||"Cliente";const cpf=document.querySelector('span[data-info="CPF"]')?.innerText?.replace(/\D/g,"")||"";const margem=moeda(document.getElementById("margem_consignavel_livre")?.value||"0");const rows=document.querySelectorAll("#tbodyContratos tr");let contratos=[];rows.forEach(row=>{try{const inputs=row.querySelectorAll("input");let parcela=0,saldo=0,prazo=0;inputs.forEach(i=>{if(i.id.includes("vl_parcela_"))parcela=moeda(i.value);if(i.id.includes("vl_quitacao_"))saldo=moeda(i.value);if(i.id.includes("valida_prazo_"))prazo=parseInt(i.value)||0});let banco="Desconhecido";const copyIcon=row.querySelector(".copy");if(copyIcon)banco=copyIcon.getAttribute("val-banco")||"Banco";if(parcela>0&&prazo>0){contratos.push({banco:banco,parcela:parcela,saldoDevedorExato:saldo,prazoRestante:prazo,origem:"POLO"})}}catch(err){console.error(err)}});enviar(nome,cpf,contratos,"POLO (GConsig)",margem,telefone);return}catch(e){console.error("Erro Polo:",e)}}if(document.getElementById("cliNome2")||document.getElementById("cliCpf2")){try{console.log("CORBAN");let nome=document.getElementById('cliNome')?.value||document.querySelector('#cliNome2')?.innerText||"Cliente";let cpf=document.getElementById('cliCpf')?.value||document.querySelector('#cliCpf2')?.innerText||"";cpf=cpf.replace(/\D/g,'');const margem=moeda(document.getElementById("parcela_9")?.value||"0");const inputs=document.querySelectorAll('input[name*="[anterior_parcela]"]');let contratos=[];inputs.forEach(input=>{try{let match=input.name.match(/contratos\[(\d+)\]/);if(match){let id=match[1];let getVal=(n)=>(document.querySelector(`input[name="contratos[${id}][${n}]"]`)?.value||"0");let banco=document.querySelector(`input[name="contratos[${id}][nome_banco_anterior]"]`)?.value||document.querySelector(`#banco_${id} option:checked`)?.text||"Banco";let valP=parseFloat(input.value);let pagas=parseInt(getVal('anterior_pagas'))||0;let total=parseInt(getVal('anterior_prazo'))||0;let saldo=moeda(getVal('saldo_devedor'))||0;if(valP>0&&total>0){contratos.push({banco:banco,parcela:valP,pagas:pagas,total:total,saldoDevedorExato:saldo,origem:"CORBAN"})}}}catch(e){console.error(e)}});if(contratos.length>0||margem>0)return enviar(nome,cpf,contratos,"CORBAN",margem,telefone)}catch(e){console.error("Erro Corban:",e)}}alert("‚ö†Ô∏è Sistema n√£o detectado. Abra o CRM do cliente primeiro.");function enviar(nome,cpf,contratos,sistema,margem=0,tel=""){if(window.opener){window.opener.postMessage({tipo:'DADOS_CONSIG_COMPLETO',nome:nome,cpf:cpf,contratos:contratos,sistema:sistema,margem:margem,telefone:tel},'*');alert(`‚úÖ Enviado!\nTel: ${tel}\nContratos: ${contratos.length}`);}else{alert('‚ö†Ô∏è Calculadora n√£o encontrada! \nVoc√™ precisa abrir a p√°gina do CRM *atrav√©s* do link na Calculadora.');}}})();</textarea>

                            <button class="btn btn-dark w-100 shadow-sm"
                                onclick="navigator.clipboard.writeText(document.getElementById('codeUniversal').value); alert('C√≥digo copiado para a √°rea de transfer√™ncia!')">
                                <i class="bi bi-clipboard"></i> COPIAR C√ìDIGO
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@latest/dist/tesseract.min.js'></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        let clienteNomePDF = '', clienteCpfPDF = '', parcelasSelecionadasPDF = [], calculoDetalhado = {};
        let parcelasManuais = [], dadosNegativado = null;

        // DADOS DAS EMPRESAS PARA O RODAP√â
        const dadosEmpresas = {
            polo: {
                razao: "Pollo Promotora LTDA",
                cnpj: "44.906.703/0001-59",
                endereco: "CSE 06, Lote 30, Edif√≠cio Mineir√£o, Sala 203 2¬∞ Andar, Bras√≠lia-DF CEP: 72.025-065"
            },
            alianca: {
                razao: "Alianca Solucoes em Negocios Ltda",
                cnpj: "50.113.116/0001-05",
                endereco: "CSE 06, Lote 30, Edif√≠cio Mineir√£o, Sala 203 2¬∞ Andar, Bras√≠lia-DF CEP: 72.025-065"
            },
            estilo: {
                razao: "Estilo Solucoes em Negocios Ltda",
                cnpj: "24.332.679/0001-84",
                endereco: "CSE 06, Lote 30, Edif√≠cio Mineir√£o, Sala 203 2¬∞ Andar, Bras√≠lia-DF CEP: 72.025-065"
            }
        };

        // NOVO: Nomes para o Script de WhatsApp (Male√°vel)
        const nomesEmpresasScript = {
            'polo': 'Pollo Promotora',
            'alianca': 'Alian√ßa Consig',
            'estilo': 'Estilo Promotora'
        };

        // Configura√ß√µes das Opera√ß√µes
        const operacoes = {
            exercito: [
                { value: 'compra_exercito', text: 'Compra de D√≠vida', coef: '0.02' },
                { value: 'portabilidade_exercito', text: 'Portabilidade', coef: '0.01930' },
                { value: 'margem_refin_exercito', text: 'Margem + Refin Bradesco', coef: '0.02' },
                { value: 'margem_nova_exercito', text: 'Margem Nova', coef: '0.023' },
                { value: 'negativado_exercito', text: 'An√°lise de Negativado', coef: '' }
            ],
            siape: [
                { value: 'compra_siape', text: 'Compra de D√≠vida', coef: '0.02' },
                { value: 'portabilidade_siape', text: 'Portabilidade', coef: '0.01930' },
                { value: 'margem_nova_siape', text: 'Margem Nova', coef: '0.023' },
                { value: 'negativado_siape', text: 'An√°lise de Negativado', coef: '' }
            ]
        };

        // Fun√ß√µes Utilit√°rias
        const moedaParaFloat = (v) => parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        const formatarMoeda = (v) => (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const formatarInputMoeda = (v) => (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\s/g, '');

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'danger' ? 'bg-danger' : (type === 'warning' ? 'bg-warning text-dark' : 'bg-success');
            const toastHtml = `<div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 4000 });
            toast.show();
            const toastEl = document.getElementById(toastId);
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        };

        // --- FUN√á√ïES DE INTEGRA√á√ÉO ---

        function abrirModalInstrucoes() {
            const modal = new bootstrap.Modal(document.getElementById('modalInstrucoes'));
            modal.show();
        }

        function getCpfLimpo() {
            const cpf = document.getElementById('clienteCpf').value.replace(/\D/g, '');
            if (cpf.length !== 11) {
                alert("Por favor, digite um CPF v√°lido com 11 d√≠gitos.");
                return null;
            }
            if (!sessionStorage.getItem('tutorialVisto')) {
                abrirModalInstrucoes();
                sessionStorage.setItem('tutorialVisto', 'true');
                return null;
            }
            return cpf;
        }

        function buscarClienteCorban() {
            const cpf = getCpfLimpo();
            if (!cpf) return;
            const form = document.createElement("form");
            form.target = "JanelaIntegracao";
            form.method = "POST";
            form.action = `https://gestao.sistemacorban.com.br/index.php/andamento/consultar?cpf=${cpf}`;
            form.style.display = "none";
            const input = document.createElement("input");
            input.type = "hidden"; input.name = "cpf"; input.value = cpf;
            form.appendChild(input); document.body.appendChild(form);
            const popup = window.open("", "JanelaIntegracao");
            if (popup) form.submit();
            else alert("Pop-up bloqueado. Permita para este site.");
            setTimeout(() => document.body.removeChild(form), 2000);
            showToast("Aguardando... Use o Favorito 'ENVIAR' na aba do Corban!", "info");
        }

        function buscarClientePolo() {
            const cpf = getCpfLimpo();
            if (!cpf) return;
            const url = `https://sistema.gconsig.com/admin/consultor/${cpf}/procurarcliente.html?tipo=cpf`;
            const popup = window.open(url, "JanelaIntegracao");
            if (!popup) alert("Pop-up bloqueado. Permita para este site.");
            showToast("Aguardando... Use o Favorito 'ENVIAR' na aba do GConsig!", "info");
        }

        // NOVO: --- L√ìGICA SCRIPT MALE√ÅVEL E INTELIGENTE ---
        function detectingGenero(nome) {
            if (!nome) return 'M';
            const n = nome.trim().split(" ")[0].toLowerCase();
            if (n.endsWith('a') && !['luca', 'jeova', 'elias', 'jonas', 'lucas', 'messias'].includes(n)) return 'F';
            return 'M';
        }

        function saudacaoHorario() {
            const h = new Date().getHours();
            const m = new Date().getMinutes();
            if (h < 12 || (h === 12 && m < 30)) return "bom dia";
            return "boa tarde";
        }

        function atualizarScript() {
            const nomeCliente = document.getElementById('clienteNome').value || document.getElementById('mn-clienteNome').value || "";
            const nomeCorrespondente = document.getElementById('nomeCorrespondente').value || "[SEU NOME]";
            // Salva no storage
            localStorage.setItem('nomeCorrespondente', nomeCorrespondente);

            // Sele√ß√£o da Empresa Male√°vel
            const empresaKey = document.getElementById('empresaSelect').value;
            const nomeEmpresa = nomesEmpresasScript[empresaKey] || "Alian√ßa Consig";

            const genero = document.querySelector('input[name="generoCliente"]:checked').value;
            const saudacao = saudacaoHorario();
            const tratamento = genero === 'M' ? "Seu" : "Dona";
            const pronomeObliquo = genero === 'M' ? "o senhor" : "a senhora";

            const partes = nomeCliente.split(" ");
            const nomeFormatado = (partes.length > 1 && partes[1].length <= 3) ? partes[0] + " " + partes[1] : partes[0];

            const script = `Ol√°, ${saudacao}! Tudo bem? 
Nesse n√∫mero eu falo com ${genero === 'M' ? 'o' : 'a'} ${tratamento} ${nomeFormatado}? 

Meu nome √© ${nomeCorrespondente}, sou correspondente autorizado do Banco Bradesco pela ${nomeEmpresa}.

O motivo do meu contato √© uma oportunidade que abriu hoje para ${pronomeObliquo}. N√≥s sabemos que, devido a algumas regras banc√°rias atuais, est√° mais dif√≠cil conseguir cr√©dito novo. Por√©m, o Bradesco liberou uma campanha especial de *Compra de D√≠vida*.

Como funciona? A ${nomeEmpresa} quita seus contratos antigos (aqueles com juros altos) e traz para o Bradesco com uma taxa menor. Isso gera um √≥timo valor de troco para ${pronomeObliquo}, *sem mexer no seu sal√°rio e sem aumentar o valor que ${pronomeObliquo} j√° paga hoje*.

Eu consigo fazer uma simula√ß√£o r√°pida aqui, sem compromisso, s√≥ para ${pronomeObliquo} ver quanto libera de valor. Podemos verificar?`;

            document.getElementById('scriptOutput').value = script;
        }

        function copiarScript() {
            const t = document.getElementById('scriptOutput'); t.select(); navigator.clipboard.writeText(t.value); showToast("Script Copiado!", "success");
        }

        function abrirWhatsApp() {
            const tel = document.getElementById('telefoneCliente').value.replace(/\D/g, '');
            const text = encodeURIComponent(document.getElementById('scriptOutput').value);
            
            if (tel.length < 10) return showToast("Preencha um telefone v√°lido.", "warning");
            
            // A MUDAN√áA EST√Å AQUI: Trocamos '_blank' por 'janelaWhatsapp'
            // Isso for√ßa o navegador a usar sempre a mesma aba
            window.open(`https://wa.me/55${tel}?text=${text}`, 'janelaWhatsapp');
        }

        // NOVO: --- INTEGRA√á√ÉO E MENSAGENS (COM TELEFONE) ---
        window.addEventListener("message", (event) => {
            const dados = event.data;
            console.log("Payload recebido:", dados); // Debug para console

            if (dados && dados.tipo === 'DADOS_CONSIG_COMPLETO') {

                // Preenche dados
                if (dados.nome) {
                    const n = dados.nome;
                    document.getElementById('clienteNome').value = n;
                    document.getElementById('mn-clienteNome').value = n;
                    // Auto G√™nero
                    if (detectingGenero(n) === 'F') document.getElementById('generoF').click();
                    else document.getElementById('generoM').click();
                }
                if (dados.cpf) {
                    document.getElementById('clienteCpf').value = dados.cpf;
                    document.getElementById('mn-clienteCpf').value = dados.cpf;
                }
                // Recebe telefone
                if (dados.telefone) {
                    document.getElementById('telefoneCliente').value = dados.telefone;
                }

                // L√≥gica de Margem Nova
                if (dados.margem && dados.margem > 0) {
                    const margemFormatada = formatarInputMoeda(dados.margem);
                    document.getElementById('mn-parcela').value = margemFormatada;

                    // Se s√≥ tem margem e nenhum contrato, muda a tela
                    if ((!dados.contratos || dados.contratos.length === 0)) {
                        document.getElementById('operacaoSelect').value = (document.getElementById('convenioSelect').value === 'exercito') ? 'margem_nova_exercito' : 'margem_nova_siape';
                        atualizarVisibilidadeUI();
                        showToast(`Apenas Margem de R$ ${margemFormatada} detectada. Mudando para Margem Nova.`, "info");
                    }
                }

                // L√≥gica de Contratos
                if (dados.contratos && dados.contratos.length > 0) {
                    parcelasManuais = [];
                    dados.contratos.forEach(c => {
                        let saldoReal = 0;
                        let pagas = c.pagas || 0;
                        let total = c.total || 0;

                        // Prioriza saldo exato vindo da integra√ß√£o
                        if (c.saldoDevedorExato && c.saldoDevedorExato > 0) {
                            saldoReal = c.saldoDevedorExato;
                        } else {
                            // Estimativa padr√£o
                            let prazoRestante = c.prazoRestante || ((total > 0) ? total - pagas : 0);
                            if (prazoRestante > 0) {
                                saldoReal = c.parcela * prazoRestante * 0.70;
                            }
                        }

                        // Ajuste de prazos espec√≠ficos do Pollo
                        if (dados.sistema && dados.sistema.includes('POLO') && c.prazoRestante > 0) {
                            total = 96;
                            pagas = 96 - c.prazoRestante;
                            if (pagas < 0) { total = c.prazoRestante; pagas = 0; }
                        } else if (!total && c.prazoRestante > 0) {
                            total = c.prazoRestante; pagas = 0;
                        }

                        let nomeBancoLimpo = c.banco ? c.banco.replace(/^\d+\s*-\s*/, '').replace('BANCO', '').trim() : 'Banco';

                        parcelasManuais.push({
                            banco: nomeBancoLimpo,
                            parcela: c.parcela,
                            totalParcelas: total,
                            parcelasPagas: pagas,
                            saldoDevedorExato: saldoReal,
                            origem: dados.sistema
                        });
                    });
                    renderizarListaManual();

                    const btnManual = document.getElementById('manual-tab');
                    if (btnManual && window.bootstrap) {
                        const tab = new bootstrap.Tab(btnManual);
                        tab.show();
                    }
                    showToast(`‚úÖ ${dados.contratos.length} contratos importados do ${dados.sistema}!`, "success");
                }
                atualizarScript(); // Atualiza o script com os novos dados
            }
        });

        function atualizarOperacoes() {
            const convenio = document.getElementById('convenioSelect').value;
            const operacaoSelect = document.getElementById('operacaoSelect');
            operacaoSelect.innerHTML = '';

            let opcaoPadrao = null;

            operacoes[convenio].forEach((op) => {
                const option = new Option(op.text, op.value);
                operacaoSelect.add(option);

                // L√ìGICA PADR√ÉO: Prioriza 'compra'
                if (op.value.includes('compra')) {
                    opcaoPadrao = op.value;
                }
            });

            if (opcaoPadrao) {
                operacaoSelect.value = opcaoPadrao;
            }

            atualizarVisibilidadeUI();
        }

        function atualizarVisibilidadeUI() {
            const convenio = document.getElementById('convenioSelect').value;
            const operacaoValue = document.getElementById('operacaoSelect').value;
            const operacao = (operacoes[convenio] || []).find(op => op.value === operacaoValue) || {};

            document.getElementById('resultadoFinal').style.display = 'none';
            document.getElementById('resultadoNegativadoContainer').style.display = 'none';

            const clienteCard = document.getElementById('clienteCard');
            const simulacaoCard = document.getElementById('simulacaoCard');
            const negativadoFields = document.getElementById('negativado-fields');
            const simulacaoFields = document.getElementById('simulacao-fields');
            const margemNovaFields = document.getElementById('margem-nova-fields');
            const portRefinFields = document.getElementById('port-refin-fields');
            const compraFields = document.getElementById('compra-fields');
            const submitBtn = document.getElementById('submitBtn');

            const negativoInput = document.getElementById('negativo');
            const parcelaInput = document.getElementById('parcela');
            const saldoInput = document.getElementById('saldodevedor');
            const coefInput = document.getElementById('coeficiente');
            const comGerenteInput = document.getElementById('comissaoGerente');
            const comEscInput = document.getElementById('comissaoesc');

            const mnNome = document.getElementById('mn-clienteNome');
            const mnCpf = document.getElementById('mn-clienteCpf');
            const mnBanco = document.getElementById('mn-banco');
            const mnParcela = document.getElementById('mn-parcela');
            const mnCoef = document.getElementById('mn-coeficiente');
            const mnPrazo = document.getElementById('mn-prazo');

            document.getElementById('pageTitle').textContent = operacao.text ? `Calculadora ${operacao.text} (${convenio.toUpperCase()})` : 'Calculadora Consignado';

            // Reseta required de todos
            [negativoInput, parcelaInput, saldoInput, coefInput, comGerenteInput, comEscInput, mnNome, mnCpf, mnBanco, mnParcela, mnCoef, mnPrazo].forEach(el => el.required = false);

            if (operacaoValue.includes('margem_nova')) {
                clienteCard.style.display = 'none';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'none';
                simulacaoFields.style.display = 'none';
                margemNovaFields.style.display = 'block';

                document.getElementById('simulacaoTitle').textContent = "2. Dados da Margem Nova";
                submitBtn.textContent = 'Calcular Margem Nova';
                if (operacao.coef) document.getElementById('mn-coeficiente').value = operacao.coef;

                mnNome.required = true;
                mnCpf.required = true;
                mnBanco.required = true;
                mnParcela.required = true;
                mnCoef.required = true;
                mnPrazo.required = true;

            } else if (operacaoValue.includes('negativado')) {
                clienteCard.style.display = 'block';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'block';
                simulacaoFields.style.display = 'none';
                margemNovaFields.style.display = 'none';
                document.getElementById('simulacaoTitle').textContent = "2. C√°lculo";
                submitBtn.textContent = 'Calcular Nova Parcela';

                negativoInput.required = true;

            } else { // Portabilidade, Compra, Refin
                clienteCard.style.display = 'block';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'none';
                simulacaoFields.style.display = 'block';
                margemNovaFields.style.display = 'none';
                document.getElementById('simulacaoTitle').textContent = "2. Dados da Simula√ß√£o";
                submitBtn.textContent = 'Calcular Simula√ß√£o Completa';

                if (operacao.coef) document.getElementById('coeficiente').value = operacao.coef;

                if (operacaoValue.includes('compra')) {
                    portRefinFields.style.display = 'none';
                    compraFields.style.display = 'block';
                } else if (operacaoValue.includes('portabilidade') || operacaoValue.includes('refin')) {
                    portRefinFields.style.display = 'block';
                    compraFields.style.display = 'none';
                } else {
                    portRefinFields.style.display = 'none';
                    compraFields.style.display = 'none';
                }

                parcelaInput.required = true;
                saldoInput.required = true;
                coefInput.required = true;
                comGerenteInput.required = true;

                comEscInput.required = false;
            }
        }

        function verificarDadosNegativado() {
            const data = sessionStorage.getItem('calculoNegativadoData');
            if (data) {
                try {
                    dadosNegativado = JSON.parse(data);
                    clienteNomePDF = dadosNegativado.nome || '';
                    clienteCpfPDF = dadosNegativado.cpf || '';
                    document.getElementById('parcela').value = formatarInputMoeda(dadosNegativado.novaParcela);
                    if (dadosNegativado.saldoDevedor > 0) document.getElementById('saldodevedor').value = formatarInputMoeda(dadosNegativado.saldoDevedor);

                    const infoDiv = document.getElementById('infoNegativado');
                    infoDiv.innerHTML = `<h5 class="alert-heading">Dados da An√°lise de Negativado</h5><p class="mb-1">Os campos de parcela e saldo foram preenchidos com base no c√°lculo anterior.</p><hr><p class="mb-0"><strong>Nova Parcela para c√°lculo:</strong> ${formatarMoeda(dadosNegativado.novaParcela)}</p>`;
                    infoDiv.style.display = 'block';
                } catch (e) {
                    console.error("Erro ao processar dados de negativado:", e);
                    dadosNegativado = null;
                } finally {
                    sessionStorage.removeItem('calculoNegativadoData');
                }
            } else {
                document.getElementById('infoNegativado').style.display = 'none';
                dadosNegativado = null;
            }
        }

        async function processarPdfExercicio(text) {
            console.log("PDF Ex√©rcito iniciado..."); // DEPURA√á√ÉO
            let cleanText = text.replace(/--- FIM DA P√ÅGINA \d+ ---/g, '').replace(/Consignat√°ria\n\s*‚ñ¥\s*‚ñæ[\s\S]+?Situa√ß√£o\n\s*‚ñ¥\s*‚ñæ/g, '').replace(/Consignat√°ria N¬∫ Servi√ßo Inclus√£o Vir.prest. Virfolha N¬∫ Pagas Situa√ß√£o/g, '');
            const listaDiv = document.getElementById("listaEmprestimos"); listaDiv.innerHTML = ''; let loansFound = 0;
            const isOcrText = cleanText.includes('O74-SABEMI-') || cleanText.includes('R$834/12');

            if (isOcrText) {
                const cpfMatch = text.match(/(\d{3}\.\d{3}\.\d{3}-\d{2})/);
                const nomeMatch = text.match(/(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-Z√Ä-√ö ]+)(?:\n([A-Z√Ä-√ö ]+))?/);
                if (cpfMatch) clienteCpfPDF = cpfMatch[0]; else if (nomeMatch) clienteCpfPDF = nomeMatch[2].trim();
                if (nomeMatch) clienteNomePDF = nomeMatch[3].trim() + (nomeMatch[4] ? ' ' + nomeMatch[4].trim() : '');

                listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF || 'N√£o lido (OCR)'}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF || 'N√£o lido (OCR)'}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;
                const blocos = cleanText.split(/Andamento/gi);
                blocos.forEach((bloco, index) => {
                    if (!bloco.toUpperCase().includes('EMPR√âSTIMO') && !bloco.toUpperCase().includes('DEDUT')) return;
                    let nomeBanco = 'Banco (N√£o lido)'; if (bloco.includes('SABEMI')) nomeBanco = 'SABEMI - PRIVADA';
                    const valorMatches = bloco.match(/R\$\s*([\d.,\/]+)/g); if (!valorMatches) return;
                    let valorStr = valorMatches[valorMatches.length - 1].replace('/', ',').replace(/[\[|]/g, '');
                    if (!valorStr.includes(',')) { let digits = valorStr.replace(/R\$\s*/, '').trim(); if (digits.length > 2) valorStr = "R$ " + digits.slice(0, -2) + ',' + digits.slice(-2); }
                    const valorParcelaNum = moedaParaFloat(valorStr); if (valorParcelaNum === 0) return;
                    const parcelasMatch = bloco.match(/\s*([\w\.|]+)\s+([\w\d]+)\s+Em/s); if (!parcelasMatch) return;
                    let total = parcelasMatch[1].replace(/[\[|TP]/g, '').trim(); let pagas = parcelasMatch[2].replace(/[x|xi|nm]/g, '0');
                    if (total.toUpperCase() === 'INDET.') {
                        loansFound++;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'form-check border-bottom py-2';
                        // ORDEM ALTERADA AQUI: Parcela - Prazo (Pagas de Total) - Saldo
                        itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="0" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Parcela: ${formatarMoeda(valorParcelaNum)} | Prazo: ${pagas} de ${total} | Saldo Aprox.: ${formatarMoeda(0)}</small></label>`;
                        listaDiv.appendChild(itemDiv); return;
                    }
                    const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10); if (parcelasRestantes < 0) return;
                    loansFound++; const saldoAproximado = valorParcelaNum * parcelasRestantes * 0.70;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'form-check border-bottom py-2';
                    // ORDEM ALTERADA AQUI: Parcela - Prazo (Pagas de Total) - Saldo
                    itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Parcela: ${formatarMoeda(valorParcelaNum)} | Prazo: ${pagas} de ${total} | Saldo Aprox.: ${formatarMoeda(saldoAproximado)}</small></label>`;
                    listaDiv.appendChild(itemDiv);
                });
            } else {
                const infoMatch = text.match(/(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-Z√Ä-√ö ]+)(?:\n([A-Z√Ä-√ö ]+))?/);
                if (infoMatch) { clienteCpfPDF = infoMatch[2].trim(); clienteNomePDF = infoMatch[3].trim(); if (infoMatch[4]) clienteNomePDF += ` ${infoMatch[4].trim()}`; }
                listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;
                const blocos = cleanText.split(/\n(?=\d{3}\s*-\s*)/);
                blocos.forEach((bloco, index) => {
                    if (bloco.toUpperCase().includes('EMPR√âSTIMO') && /Em\s+Andamento/.test(bloco)) {
                        const bancoMatch = bloco.match(/^([\s\S]+?)\n(\d{7})\n/); const valorMatch = bloco.match(/R\$\s*[\d.,]+/); const parcelasResult = bloco.match(/([\w\.]+)\s*\n\s*(\d+)\s+Em\s+Andamento/);
                        if (bancoMatch && valorMatch && parcelasResult) {
                            const nomeBanco = bancoMatch[1].replace(/\n/g, ' ').trim(); const valor = valorMatch[0]; const total = parcelasResult[1]; const pagas = parcelasResult[2];
                            if (total.toUpperCase() === 'INDET.') return;
                            loansFound++; const valorParcelaNum = moedaParaFloat(valor); const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10); if (parcelasRestantes < 0) return;
                            const saldoAproximado = valorParcelaNum * parcelasRestantes * 0.70;
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'form-check border-bottom py-2';
                            // ORDEM ALTERADA AQUI: Parcela - Prazo (Pagas de Total) - Saldo
                            itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Parcela: ${formatarMoeda(valorParcelaNum)} | Prazo: ${pagas} de ${total} | Saldo Aprox.: ${formatarMoeda(saldoAproximado)}</small></label>`;
                            listaDiv.appendChild(itemDiv);
                        }
                    }
                });
            }
            if (loansFound === 0) showToast("AVISO: Nenhum contrato 'Em Andamento' foi encontrado no formato esperado.", 'warning');
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
            listaDiv.style.display = "block"; document.getElementById("unificarBtnPdf").style.display = "block";
        }

        async function processarPdfSiape(text) {
            console.log("PDF SIAPE Iniciado..."); // DEPURA√á√ÉO
            const infoRegexNovo = /CPF\nMatr√≠cula\nNome\n([^\n]+)\n(?:[^\n]*\n)?([^\n]+)/;
            const headerRegexAntigo = /√ìrg√£o\nCPF\nMatr√≠cula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
            let infoMatchNovo = text.match(infoRegexNovo); let headerMatchAntigo = text.match(headerRegexAntigo);
            let cpfExtraido = 'N√£o lido', nomeExtraido = 'N√£o lido';
            if (infoMatchNovo && (/\d{3}\.\d{3}\.\d{3}-\d{2}/.test(infoMatchNovo[1].trim()) || /\d{11}/.test(infoMatchNovo[1].replace(/[.-]/g, '')))) { cpfExtraido = infoMatchNovo[1].trim(); nomeExtraido = infoMatchNovo[2].trim(); }
            else if (headerMatchAntigo) { cpfExtraido = headerMatchAntigo[1].trim(); nomeExtraido = headerMatchAntigo[2].trim(); }
            else { const cpfSimples = text.match(/\d{3}\.\d{3}\.\d{3}-\d{2}/); if (cpfSimples) cpfExtraido = cpfSimples[0]; }
            clienteCpfPDF = cpfExtraido; clienteNomePDF = nomeExtraido;

            const blocoValoresRegex = /Total\s+Cart√£o([\s\S]+?)(?:Extrato\s+de\s+Consigna√ß√µes|Demonstrativo\s+de\s+uso)/i;
            const matchBloco = text.match(blocoValoresRegex);
            let valBrutaFacultativa = 0, valTotalFacultativas = 0, margemDisponivel = 0, calculoRealizado = false;
            if (matchBloco) {
                const valoresEncontrados = matchBloco[1].match(/R\$\s*([\d.,]+)/g);
                if (valoresEncontrados && valoresEncontrados.length >= 7) {
                    valBrutaFacultativa = moedaParaFloat(valoresEncontrados[2]); valTotalFacultativas = moedaParaFloat(valoresEncontrados[6]);
                    margemDisponivel = valBrutaFacultativa - valTotalFacultativas; calculoRealizado = true;
                }
            }
            const infoDiv = document.getElementById("infoNegativado"); const negativoInput = document.getElementById("negativo"); const operacaoSelect = document.getElementById("operacaoSelect");
            if (calculoRealizado) {
                const cpfParaLink = clienteCpfPDF || ''; const cpfLimpo = cpfParaLink.replace(/\D/g, ''); const urlPolloDireta = `https://sistema.gconsig.com/admin/consultor/${cpfParaLink}/procurarcliente.html?tipo=cpf`;
                let htmlAnalise = `<h5 class="alert-heading">An√°lise de Margem (SIAPE)</h5><div class="row"><div class="col-6"><strong>Bruta Facultativa:</strong><br>${formatarMoeda(valBrutaFacultativa)}</div><div class="col-6"><strong>Total Utilizado:</strong><br>${formatarMoeda(valTotalFacultativas)}</div></div><hr class="my-2">`;
                const botaoLinkPollo = (classeCor) => `<div class="mt-3"><a href="${urlPolloDireta}" target="_blank" class="btn btn-sm ${classeCor} w-100" onclick="navigator.clipboard.writeText('${cpfLimpo}'); showToast('Abrindo sistema... CPF copiado por seguran√ßa!', 'info');"><strong>üîó Abrir Cliente no Pollo</strong></a><small class="text-muted d-block mt-1" style="font-size: 0.75rem;">(Vai direto para o cadastro. Se falhar, o CPF j√° foi copiado)</small></div>`;
                if (margemDisponivel < -0.01) {
                    const valorNegativo = Math.abs(margemDisponivel);
                    htmlAnalise += `<div class="alert alert-danger mb-0 text-center"><strong>‚ö†Ô∏è CLIENTE NEGATIVO</strong><br>Valor Excedente: <strong>${formatarMoeda(valorNegativo)}</strong>${botaoLinkPollo('btn-outline-dark')}<p class="mt-2 mb-0"><small>Ou consulte no <a href="https://c6.c6consig.com.br/WebAutorizador/Login" target="_blank">Banco C6</a></small></p></div>`;
                    negativoInput.value = formatarInputMoeda(valorNegativo);
                    if (operacaoSelect.value !== 'negativado_siape') { operacaoSelect.value = 'negativado_siape'; atualizarVisibilidadeUI(); showToast(`Modo 'An√°lise de Negativado' ativado automaticamente!`, "warning"); }
                } else {
                    htmlAnalise += `<div class="alert alert-success mb-0 text-center"><strong>‚úÖ MARGEM DISPON√çVEL</strong><br>Livre: <strong>${formatarMoeda(margemDisponivel)}</strong>${botaoLinkPollo('btn-outline-success')}<p class="mt-2 mb-0"><small>Ou consulte no <a href="https://c6.c6consig.com.br/WebAutorizador/Login" target="_blank">Banco C6</a></small></p></div>`;
                    negativoInput.value = '';
                }
                infoDiv.innerHTML = htmlAnalise; infoDiv.style.display = 'block';
            } else { infoDiv.style.display = 'none'; }

            const listaDiv = document.getElementById("listaEmprestimos");
            listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;
            const rgxEmprestimos = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g; let matches = [...text.matchAll(rgxEmprestimos)]; let contratosEncontrados = [];
            matches.forEach((match, index) => {
                const [_, nomeBanco, valor, parcelasStr] = match;
                let cleanNomeBanco = nomeBanco.replace(/^\d+\s*-\s*/, '').trim().replace('EMPREST BCO PRIVADOS - ', '').replace('EMPREST BCO OFICIAL - ', '');
                const [pagas, total] = parcelasStr.split('/'); const valorParcelaNum = moedaParaFloat(valor);
                if (parseInt(total, 10) > 900) return;
                const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10); const saldoAproximado = (parcelasRestantes >= 0) ? valorParcelaNum * parcelasRestantes * 0.70 : 0;
                contratosEncontrados.push({ id: index, banco: cleanNomeBanco, valorParcela: valorParcelaNum, saldo: saldoAproximado, pagas: pagas, total: total });
            });
            contratosEncontrados.sort((a, b) => b.valorParcela - a.valorParcela);
            if (contratosEncontrados.length === 0) { showToast("AVISO: Nenhum contrato de empr√©stimo v√°lido foi encontrado.", 'warning'); }
            else {
                contratosEncontrados.forEach((c, i) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'form-check border-bottom py-2';
                    // ORDEM ALTERADA AQUI: Parcela - Prazo (Pagas de Total) - Saldo
                    itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${c.saldo}" data-parcela="${c.valorParcela}" data-banco="${c.banco}" data-status="${c.pagas} de ${c.total}" id="loan-sorted-${i}"><label class="form-check-label" for="loan-sorted-${i}"><strong>${c.banco}</strong><br><small>Parcela: ${formatarMoeda(c.valorParcela)} | Prazo: ${c.pagas} de ${c.total} | Saldo Aprox.: ${formatarMoeda(c.saldo)}</small></label>`;
                    listaDiv.appendChild(itemDiv);
                });
            }
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
            listaDiv.style.display = "block"; document.getElementById("unificarBtnPdf").style.display = "block";
        }

        function parsearPdf(event) {
            const file = event.target.files[0]; if (!file) return;
            clienteNomePDF = ''; clienteCpfPDF = '';
            const loadingDiv = document.getElementById("loading"); const loadingText = document.getElementById("loading-text");
            loadingText.textContent = 'Analisando...'; loadingDiv.classList.remove('d-none'); loadingDiv.classList.add('d-flex');
            document.getElementById('upload-text').style.display = 'none'; document.getElementById('listaEmprestimos').innerHTML = '';
            document.getElementById('listaEmprestimos').style.display = 'none'; document.getElementById('unificarBtnPdf').style.display = 'none';

            const fileReader = new FileReader();
            fileReader.onload = async function () {
                let extractedText = '';
                try {
                    const typedarray = new Uint8Array(this.result); const pdf = await pdfjsLib.getDocument(typedarray).promise; let textFound = false;
                    console.log("PDF loaded. Pages:", pdf.numPages);
                    for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); if (textContent.items.length > 0) textFound = true; extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n'; }
                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNAT√ÅRIA') || extractedText.toUpperCase().includes('EMPR√âSTIMO') || extractedText.toUpperCase().includes('CPF') || extractedText.toUpperCase().includes('RUBRICA');
                    if (extractedText.trim().length < 50 || !hasRealData) { textFound = false; console.log("Texto 'limpo' n√£o parece v√°lido. For√ßando OCR (Plano B)."); }

                    if (!textFound) {
                        console.warn("PDF parece ser uma imagem ou sem texto real. Iniciando OCR..."); extractedText = '';
                        if (typeof Tesseract === 'undefined') throw new Error("Tesseract.js n√£o foi carregado.");
                        const worker = await Tesseract.createWorker('por');
                        for (let i = 1; i <= pdf.numPages; i++) {
                            loadingText.textContent = `Lendo imagem: P√°gina ${i} de ${pdf.numPages}...`;
                            const page = await pdf.getPage(i); const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas'); const context = canvas.getContext('2d'); canvas.height = viewport.height; canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const { data: { text: ocrText } } = await worker.recognize(canvas); extractedText += ocrText + '\n\n';
                        }
                        await worker.terminate(); console.log("OCR Conclu√≠do.");
                    }

                    let convenioDetectado = 'exercito'; const convenioSelect = document.getElementById('convenioSelect');
                    if (extractedText.includes("Extrato de Consigna√ß√µes Vigentes") || extractedText.includes("Rubrica\nSequ√™ncia")) { convenioDetectado = 'siape'; console.log("Conv√™nio detectado: SIAPE"); }
                    else if (extractedText.includes("eConsig") || extractedText.includes("MARGEM CONSIGNACAO") || extractedText.includes("Consignat√°ria")) { convenioDetectado = 'exercito'; console.log("Conv√™nio detectado: Ex√©rcito (eConsig)"); }
                    else { console.warn("N√£o foi poss√≠vel detectar o conv√™nio automaticamente com alta confian√ßa, usando padr√£o."); showToast("N√£o foi poss√≠vel detectar o conv√™nio. Verifique a sele√ß√£o.", "warning"); }

                    convenioSelect.value = convenioDetectado; atualizarOperacoes();
                    if (convenioDetectado === 'exercito') await processarPdfExercicio(extractedText); else await processarPdfSiape(extractedText);
                    showToast("Extrato lido e conv√™nio detectado com sucesso!", "success");

                } catch (error) { console.error("Erro ao processar o PDF:", error); showToast(`Ocorreu um erro ao ler o PDF: ${error.message}`, "danger"); }
                finally { loadingDiv.classList.add('d-none'); loadingDiv.classList.remove('d-flex'); document.getElementById('upload-text').style.display = 'block'; loadingText.textContent = 'Analisando...'; }
            };
            fileReader.readAsArrayBuffer(file);
        }

        function unificarContratos(isManual) {
            let totalSaldo = 0, totalParcela = 0;
            parcelasSelecionadasPDF = [];

            if (isManual) {
                parcelasManuais.forEach(p => {
                    totalParcela += p.parcela;
                    if (p.saldoDevedorExato && p.saldoDevedorExato > 0) { totalSaldo += p.saldoDevedorExato; }
                    else { const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0); if (parcelasRestantes > 0) totalSaldo += p.parcela * parcelasRestantes * 0.70; }
                });
            } else {
                const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkedBoxes.length === 0) return showToast("Selecione ao menos um contrato.", "warning");
                checkedBoxes.forEach(cb => {
                    totalSaldo += parseFloat(cb.dataset.saldo); totalParcela += parseFloat(cb.dataset.parcela);
                    parcelasSelecionadasPDF.push({ banco: cb.dataset.banco, parcela: formatarMoeda(parseFloat(cb.dataset.parcela)), saldo: formatarMoeda(parseFloat(cb.dataset.saldo)), status: cb.dataset.status });
                });
            }

            const operacao = document.getElementById('operacaoSelect').value;
            if (operacao.includes('negativado')) { document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcela); }
            else { document.getElementById("parcela").value = formatarInputMoeda(totalParcela); document.getElementById("saldodevedor").value = formatarInputMoeda(totalSaldo); }
            if (!isManual) showToast("Valores unificados e preenchidos no formul√°rio.");
        }

        function renderizarListaManual() {
            const listaDiv = document.getElementById('manual-loans-list');
            listaDiv.innerHTML = '';

            if (parcelasManuais.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';

                parcelasManuais.forEach((p, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';

                    // C√°lculo visual do saldo (mantendo a l√≥gica original)
                    const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0);
                    const saldoManual = (p.saldoDevedorExato && p.saldoDevedorExato > 0)
                        ? p.saldoDevedorExato
                        : ((parcelasRestantes > 0) ? p.parcela * parcelasRestantes * 0.70 : 0);

                    li.innerHTML = `
                        <div>
                            <strong>${p.banco}</strong><br>
                            <small class="text-muted">
                                Parcela: ${formatarMoeda(p.parcela)} | 
                                Prazo: ${p.parcelasPagas} de ${p.totalParcelas} | 
                                Saldo Aprox.: ${formatarMoeda(saldoManual)}
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="editarParcelaManual(${index})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="removerParcelaManual(${index})" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </div>`;
                    ul.appendChild(li);
                });
                listaDiv.appendChild(ul);
            }
            unificarContratos(true);
        }
        window.editarParcelaManual = (index) => {
            const item = parcelasManuais[index];
            document.getElementById('manualBanco').value = item.banco;
            document.getElementById('manualParcela').value = formatarInputMoeda(item.parcela);
            document.getElementById('manualTotalParcelas').value = item.totalParcelas;
            document.getElementById('manualParcelasPagas').value = item.parcelasPagas;
            parcelasManuais.splice(index, 1);
            renderizarListaManual();
            document.getElementById('manualParcela').focus();
            showToast("Item carregado para edi√ß√£o. Ajuste e clique em 'Adicionar'.", "info");
        }

        window.removerParcelaManual = (index) => { parcelasManuais.splice(index, 1); renderizarListaManual(); }

        function adicionarContratoManual() {
            const banco = document.getElementById('manualBanco').value || 'N√£o informado';
            const parcelaValor = moedaParaFloat(document.getElementById('manualParcela').value);
            const totalParcelas = parseInt(document.getElementById('manualTotalParcelas').value, 10);
            const parcelasPagas = parseInt(document.getElementById('manualParcelasPagas').value, 10);
            if (!parcelaValor || !totalParcelas || isNaN(parcelasPagas)) return showToast("Preencha valor e parcelas corretamente.", 'danger');
            parcelasManuais.push({ banco, parcela: parcelaValor, totalParcelas, parcelasPagas });
            ['manualBanco', 'manualParcela', 'manualParcelasPagas'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('manualTotalParcelas').value = '96'; renderizarListaManual(); showToast("Contrato adicionado.");
        }

        function calcularNegativado() {
            let totalParcelas = 0, saldoFinal = 0; const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');
            if (isManualTabActive) {
                let saldoManual = 0;
                parcelasManuais.forEach(p => { totalParcelas += p.parcela; const restantes = p.totalParcelas - p.parcelasPagas; if (restantes > 0) saldoManual += p.parcela * restantes * 0.70; });
                saldoFinal = saldoManual;
            } else {
                const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkedBoxes.length === 0) return showToast("Selecione ao menos um contrato do extrato PDF.", 'danger');
                checkedBoxes.forEach(cb => { totalParcelas += parseFloat(cb.dataset.parcela); saldoFinal += parseFloat(cb.dataset.saldo); });
            }
            if (totalParcelas === 0) return showToast("Nenhum contrato selecionado ou adicionado para calcular.", 'danger');
            const negativo = moedaParaFloat(document.getElementById("negativo").value);
            if (negativo <= 0) return showToast("Insira um valor negativo v√°lido (maior que zero).", 'danger');
            const novaParcela = totalParcelas - negativo;
            const nomeFinal = document.getElementById('clienteNome').value.trim() || clienteNomePDF;
            const cpfFinal = document.getElementById('clienteCpf').value.trim() || clienteCpfPDF;
            const operacao = document.getElementById('operacaoSelect').value;
            calculoDetalhado = { tipo: operacao, totalParcelas, negativo, novaParcela, saldoDevedor: saldoFinal, nome: nomeFinal, cpf: cpfFinal };

            document.getElementById("resultadoNegativadoContainer").style.display = "block";
            document.getElementById("resultadoNegativadoBody").innerHTML = `<ul class="list-group list-group-flush"><li class="list-group-item d-flex justify-content-between"><span>Total Parcelas Originais:</span> <strong>${formatarMoeda(totalParcelas)}</strong></li><li class="list-group-item d-flex justify-content-between"><span>Valor Negativo:</span> <strong class="text-danger">- ${formatarMoeda(negativo)}</strong></li><li class="list-group-item d-flex justify-content-between"><span>Saldo Devedor Aprox.:</span> <strong>${formatarMoeda(saldoFinal)}</strong></li><li class="list-group-item d-flex justify-content-between ${novaParcela < 0 ? 'bg-danger-subtle' : 'bg-success-subtle'}"><h4>Nova Parcela p/ C√°lculo:</h4> <h4 class="fw-bold">${formatarMoeda(novaParcela)}</h4></li></ul>`;
            document.getElementById("resultadoNegativadoContainer").scrollIntoView({ behavior: 'smooth' });
        }

        function calcularMargemNova() {
            const operacao = document.getElementById('operacaoSelect').value;
            const nome = document.getElementById('mn-clienteNome').value; const cpf = document.getElementById('mn-clienteCpf').value;
            const banco = document.getElementById('mn-banco').value; const parcela = moedaParaFloat(document.getElementById('mn-parcela').value);
            const coeficiente = parseFloat(document.getElementById('mn-coeficiente').value.replace(",", ".")) || 0;
            const prazo = parseInt(document.getElementById('mn-prazo').value, 10) || 0;

            if (!nome || !cpf || !banco || !parcela || parcela <= 0 || !coeficiente || coeficiente <= 0 || !prazo) return showToast('Preencha todos os campos obrigat√≥rios da Margem Nova.', 'danger');

            const valorLiberado = parcela / coeficiente; const valorTotalContrato = parcela * prazo;
            calculoDetalhado = { tipo: operacao, nome: nome, cpf: cpf, novoBanco: banco, novaParcelaValor: parcela, coef: coeficiente, novoPrazo: prazo, valorLiberado: valorLiberado, valorTotalContrato: valorTotalContrato };

            const resultadoDiv = document.getElementById("resultadoFinal");
            resultadoDiv.innerHTML = `
                <div class="card border-primary">
                    <div class="card-header card-resultado-header bg-primary text-white">
                        Resultado da Simula√ß√£o (Margem Nova)
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-4">
                            <small class="text-muted text-uppercase fw-bold">Valor Liberado (Estimado)</small>
                            <h2 class="resultado-final-valor text-success mb-0">${formatarMoeda(valorLiberado)}</h2>
                        </div>
                        <hr>
                        <div class="row text-start">
                            <div class="col-6 mb-2">
                                <span class="text-muted">Valor da Parcela:</span><br>
                                <strong>${formatarMoeda(parcela)}</strong>
                            </div>
                            <div class="col-6 mb-2">
                                <span class="text-muted">Prazo:</span><br>
                                <strong>${prazo} meses</strong>
                            </div>
                            <div class="col-6 mb-2">
                                <span class="text-muted">Coeficiente:</span><br>
                                <strong>${coeficiente.toFixed(6)}</strong>
                            </div>
                            <div class="col-6 mb-2">
                                <span class="text-muted">Total Contrato:</span><br>
                                <strong>${formatarMoeda(valorTotalContrato)}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-grid gap-2 d-md-flex justify-content-md-center">
                        <button id="baixarPdfClienteBtn" class="btn btn-success"><i class="bi bi-file-earmark-pdf"></i> PDF Cliente</button>
                        <button id="baixarPdfEscritorioBtn" class="btn btn-secondary"><i class="bi bi-file-earmark-text"></i> PDF Escrit√≥rio</button>
                    </div>
                </div>`;

            resultadoDiv.style.display = 'block'; resultadoDiv.scrollIntoView({ behavior: 'smooth' });
            document.getElementById("baixarPdfClienteBtn").addEventListener("click", gerarPDFCliente);
            document.getElementById("baixarPdfEscritorioBtn").addEventListener("click", gerarPDFEscritorio);
        }

        function calcularSimulacaoCompleta() {
            const op = document.getElementById('operacaoSelect').value;

            // Tratamento de valores para evitar NaN
            const p = moedaParaFloat(document.getElementById("parcela").value);
            const s = moedaParaFloat(document.getElementById("saldodevedor").value);
            const d = moedaParaFloat(document.getElementById("desconto").value); 
            const coef = parseFloat(document.getElementById("coeficiente").value.replace(',', '.')) || 0.02;
            const comG_pct = parseFloat(document.getElementById('comissaoGerente').value.replace(',', '.')) || 0;
            const comEsc = moedaParaFloat(document.getElementById('comissaoesc').value);

            const novoBanco = document.getElementById("novoBanco").value || 'Bradesco';
            const novoPrazo = parseInt(document.getElementById("novoPrazo").value, 10) || 96;

            // Valida√ß√£o b√°sica
            if (p <= 0 || coef <= 0) return showToast("Dados inv√°lidos (Parcela ou Coeficiente zerados)", 'danger');

            const novoContrato = p / coef;

            // Vari√°veis de c√°lculo
            let brutoDisponivel = 0;
            let comissaoInv = 0;
            let comissaoG_valor = 0;
            let liquidoFinal = 0;
            let pctInv = 0; 
            
            // Textos para exibi√ß√£o na tela (HTML)
            let txtPctInvestidor = "0%";
            let txtPctGerente = `${comG_pct}%`;
            let htmlDet = '';

            if (op.includes('compra')) {
                const tipoC = document.getElementById('tipoCompra').value;
                pctInv = (tipoC === 'bradesco') ? 0.10 : 0.08; // Define a taxa (10% ou 8%)
                txtPctInvestidor = (pctInv * 100).toFixed(0) + "%";

                brutoDisponivel = novoContrato - s - d;
                comissaoInv = s * pctInv; 
                comissaoG_valor = brutoDisponivel * (comG_pct / 100); 

                liquidoFinal = brutoDisponivel - comissaoInv - comissaoG_valor - comEsc;

                // HTML Detalhado para a TELA
                htmlDet = `
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>Novo Saldo (Gerado):</span> <strong>${formatarMoeda(novoContrato)}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Saldo Devedor:</span> <span class="text-danger">- ${formatarMoeda(s)}</span>
                    </li>
                    ${d > 0 ? `<li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Produto:</span> <span class="text-danger">- ${formatarMoeda(d)}</span>
                    </li>` : ''}
                    <li class="list-group-item d-flex justify-content-between bg-light rounded px-2 py-2 my-2">
                        <span class="fw-bold">(=) Valor Bruto Dispon√≠vel:</span> <strong class="text-dark">${formatarMoeda(brutoDisponivel)}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Com. Investidor <span class="badge bg-secondary text-white" style="font-size:0.7em">${txtPctInvestidor}</span>:</span> 
                        <span class="text-danger">- ${formatarMoeda(comissaoInv)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Com. Gerente <span class="badge bg-secondary text-white" style="font-size:0.7em">${txtPctGerente}</span>:</span> 
                        <span class="text-danger">- ${formatarMoeda(comissaoG_valor)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Com. Escrit√≥rio:</span> <span class="text-danger">- ${formatarMoeda(comEsc)}</span>
                    </li>`;

            } else {
                // L√≥gica Portabilidade / Refin
                let quitadoExtra = 0;
                if (document.getElementById('quitacaoSim').checked) quitadoExtra = moedaParaFloat(document.getElementById('valorQuitado').value);

                let baseComissao = novoContrato - s - d - quitadoExtra;
                comissaoG_valor = baseComissao * (comG_pct / 100);
                liquidoFinal = baseComissao - comissaoG_valor - comEsc;
                
                brutoDisponivel = baseComissao; 

                htmlDet = `
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>Novo Saldo (Gerado):</span> <strong>${formatarMoeda(novoContrato)}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Saldo Devedor:</span> <span class="text-danger">- ${formatarMoeda(s)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between bg-light rounded px-2 py-2 my-2">
                        <span class="fw-bold">(=) Valor Bruto Liberado:</span> <strong class="text-dark">${formatarMoeda(baseComissao)}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Com. Gerente <span class="badge bg-secondary text-white" style="font-size:0.7em">${txtPctGerente}</span>:</span> 
                        <span class="text-danger">- ${formatarMoeda(comissaoG_valor)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between border-0 px-0 py-1">
                        <span>(-) Com. Escrit√≥rio:</span> <span class="text-danger">- ${formatarMoeda(comEsc)}</span>
                    </li>`;
            }

            // Coeficiente Real
            let coeficienteReal = 0;
            if ((liquidoFinal + s) > 0) { coeficienteReal = p / (liquidoFinal + s); }

            // Captura robusta de Nome e CPF (Input > Vari√°vel Global > Padr√£o)
            const nomeFinal = document.getElementById('clienteNome').value || clienteNomePDF || 'Nome N√£o Informado';
            const cpfFinal = document.getElementById('clienteCpf').value || clienteCpfPDF || 'CPF N√£o Informado';
            
            // C√°lculo do Valor Geral (L√≠quido Cliente + Escrit√≥rio)
            const valorGeralCalculado = liquidoFinal + comEsc;

            // Preencher o Objeto COMPLETAMENTE para o PDF
            calculoDetalhado = {
                tipo: op,
                novoS: novoContrato,
                s: s,
                d: d,
                valorOfertaFinal: liquidoFinal,
                nome: nomeFinal,
                cpf: cpfFinal,
                novoBanco,
                novoPrazo,
                novaParcelaValor: p,
                sub: brutoDisponivel,
                investidor: comissaoInv,
                investidorR: pctInv, // Salva a taxa para n√£o dar erro no PDF
                gerente: comissaoG_valor,
                comissaoG: comG_pct, // Salva a taxa para n√£o dar erro no PDF
                comissaoEsc: comEsc,
                valorGeral: valorGeralCalculado,
                coef: coef,
                coeficienteReal: coeficienteReal,
                valorQuitado: (typeof quitadoExtra !== 'undefined') ? quitadoExtra : 0
            };

            // Renderizar na Tela
            const div = document.getElementById('resultadoFinal');
            div.style.display = 'block';
            div.innerHTML = `
                <div class="card border-primary shadow-sm">
                    <div class="card-header card-resultado-header bg-primary text-white text-center">
                        <h5 class="mb-0 fw-bold">Resultado da Simula√ß√£o</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <small class="text-muted text-uppercase fw-bold" style="letter-spacing: 1px;">VALOR L√çQUIDO (ESTIMADO)</small>
                            <h1 class="resultado-final-valor text-success mb-0 mt-1">${formatarMoeda(liquidoFinal)}</h1>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <div class="p-3 border rounded bg-light text-center h-100">
                                    <small class="d-block text-muted mb-1">Novo Contrato</small>
                                    <strong class="fs-5 text-dark">${formatarMoeda(novoContrato)}</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 border rounded bg-light text-center h-100">
                                    <small class="d-block text-muted mb-1">Saldo Quitado</small>
                                    <strong class="fs-5 text-dark">${formatarMoeda(s)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-white border-light shadow-sm">
                            <div class="card-header bg-light border-bottom-0 fw-bold text-primary">
                                <i class="bi bi-list-ul me-2"></i> Detalhamento Completo
                            </div>
                            <div class="card-body pt-0">
                                <ul class="list-group list-group-flush small">
                                    ${htmlDet}
                                </ul>
                            </div>
                            <div class="card-footer bg-white border-top pt-2 pb-2">
                                <div class="d-flex justify-content-between align-items-center small text-muted">
                                    <span>Coeficiente Real:</span>
                                    <span class="text-primary fw-bold font-monospace">${coeficienteReal.toFixed(8)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light d-flex justify-content-center gap-2 py-3">
                         <button id="baixarPdfClienteBtn" class="btn btn-success"><i class="bi bi-file-earmark-pdf"></i> PDF Cliente</button>
                         <button id="baixarPdfEscritorioBtn" class="btn btn-secondary"><i class="bi bi-file-earmark-text"></i> PDF Escrit√≥rio</button>
                    </div>
                </div>
            `;

            div.scrollIntoView({ behavior: 'smooth' });
            
            // Reatribui os eventos aos bot√µes
            document.getElementById("baixarPdfClienteBtn").addEventListener("click", gerarPDFCliente);
            document.getElementById("baixarPdfEscritorioBtn").addEventListener("click", gerarPDFEscritorio);
        }

        function gerarPDFBase(doc, tipo) {
            const getBase64Image = (img) => { if (!img) return null; try { const c = document.createElement("canvas"); c.width = img.naturalWidth; c.height = img.naturalHeight; c.getContext("2d").drawImage(img, 0, 0); return c.toDataURL("image/png"); } catch (e) { return null; } };

            const selectedEmpresa = document.getElementById('empresaSelect').value;
            const logoId = (selectedEmpresa === 'polo') ? 'logo-polo' : (selectedEmpresa === 'estilo' ? 'logo-estilo' : 'logo-alianca');
            const logoPrincipalImg = document.getElementById(logoId);
            const convenio = document.getElementById('convenioSelect').value;
            const convenioLogoId = (convenio === 'exercito') ? 'convenio-logo-exercito' : 'convenio-logo-siape';
            const convenioImgElem = document.getElementById(convenioLogoId);

            const logoPrincipalBase64 = getBase64Image(logoPrincipalImg);
            const convenioBase64 = getBase64Image(convenioImgElem);
            let y = 15; const pageWidth = doc.internal.pageSize.getWidth(); const pageHeight = doc.internal.pageSize.getHeight();
            const logoPrincipalWidth = 40, logoConvenioWidth = 30;
            const logoPrincipalHeight = (logoPrincipalImg && logoPrincipalImg.naturalWidth > 0) ? logoPrincipalImg.naturalHeight * (logoPrincipalWidth / logoPrincipalImg.naturalWidth) : 0;
            const logoConvenioHeight = (convenioImgElem && convenioImgElem.naturalWidth > 0) ? convenioImgElem.naturalHeight * (logoConvenioWidth / convenioImgElem.naturalWidth) : 0;
            const maxHeight = Math.max(logoPrincipalHeight, logoConvenioHeight);

            if (logoPrincipalBase64) doc.addImage(logoPrincipalBase64, 'PNG', 15, y + (maxHeight - logoPrincipalHeight) / 2, logoPrincipalWidth, logoPrincipalHeight);
            if (convenioBase64) doc.addImage(convenioBase64, 'PNG', pageWidth - logoConvenioWidth - 15, y + (maxHeight - logoConvenioHeight) / 2, logoConvenioWidth, logoConvenioHeight);

            y += maxHeight > 0 ? maxHeight + 10 : 25;
            const operacaoSelectElement = document.getElementById('operacaoSelect');
            const operacaoText = operacaoSelectElement.options[operacaoSelectElement.selectedIndex]?.text || 'Opera√ß√£o Desconhecida';
            doc.setFontSize(18); doc.text(`Simula√ß√£o de ${operacaoText} (${tipo})`, pageWidth / 2, y, { align: 'center' }); y += 20;

            const nomeFinal = calculoDetalhado?.nome || 'N√£o informado'; const cpfFinal = calculoDetalhado?.cpf || 'N√£o informado';
            doc.setFontSize(12); doc.text("Dados do Cliente", 15, y); y += 8;
            doc.setFontSize(10); doc.text(`Nome: ${nomeFinal}`, 15, y); y += 6; doc.text(`CPF: ${cpfFinal}`, 15, y);

            if (calculoDetalhado && !calculoDetalhado.tipo.includes('margem_nova')) {
                const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');
                const listaDeParcelas = isManualTabActive ? parcelasManuais.map(p => {
                    const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0);
                    const saldoManual = (parcelasRestantes > 0) ? p.parcela * parcelasRestantes * 0.70 : 0;
                    return { banco: p.banco, parcela: formatarMoeda(p.parcela), saldo: formatarMoeda(saldoManual), status: `${p.parcelasPagas || 0} de ${p.totalParcelas || 0}` };
                }) : parcelasSelecionadasPDF;

                if (listaDeParcelas && listaDeParcelas.length > 0) {
                    y += 16; doc.setFontSize(12); doc.text("Contratos Unificados (Originais)", 15, y); y += 8; doc.setFontSize(9);
                    listaDeParcelas.forEach(p => {
                        // ORDEM ALTERADA AQUI: Parcela - Prazo (Status) - Saldo
                        const linhaContrato = `- Banco: ${p.banco} | Parcela: ${p.parcela} | Prazo: ${p.status} | Saldo Aprox.: ${p.saldo}`;
                        const linhas = doc.splitTextToSize(linhaContrato, pageWidth - 30);
                        doc.text(linhas, 15, y); y += (linhas.length * 4);
                    });
                } else { y += 10; }
            } else { y += 10; }

            y += 10; doc.setFontSize(12); doc.text("Dados do Novo Contrato", 15, y); y += 8; doc.setFontSize(10);
            doc.text(`Banco: ${calculoDetalhado?.novoBanco || '(N√£o especificado)'}`, 15, y); y += 6;
            doc.text(`Prazo: ${calculoDetalhado?.novoPrazo || '96'}x`, 15, y); y += 6;
            doc.text(`Valor da Parcela: ${formatarMoeda(calculoDetalhado?.novaParcelaValor)}`, 15, y); y += 6;

            // --- RODAP√â COM DADOS DA EMPRESA (NEGRITO) ---
            const empresaInfo = dadosEmpresas[selectedEmpresa] || {};
            if (empresaInfo.razao) {
                let footerY = pageHeight - 25;
                doc.setFontSize(8);
                doc.setTextColor(0); // Preto
                doc.setDrawColor(200);
                doc.line(15, footerY - 5, pageWidth - 15, footerY - 5);

                doc.setFont('helvetica', 'bold'); // TUDO NEGRITO AQUI
                doc.text(empresaInfo.razao, 15, footerY);
                doc.text(`CNPJ: ${empresaInfo.cnpj}`, 15, footerY + 4);
                doc.text(empresaInfo.endereco, 15, footerY + 8);

                doc.setFont('helvetica', 'normal'); // Reseta
            }

            return y;
        }

        function gerarNomeArquivo(tipoPdf) {
            const dataFormatada = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            let nomeCliente = (calculoDetalhado?.nome || 'cliente').trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            if (!nomeCliente) nomeCliente = 'cliente_desconhecido';
            const operacao = document.getElementById('operacaoSelect').value || 'calculo';
            return `${operacao}_${nomeCliente}_${tipoPdf}_${dataFormatada}.pdf`;
        }

        function gerarPDFCliente() {
            if (!calculoDetalhado || Object.keys(calculoDetalhado).length === 0) { showToast("Nenhum c√°lculo foi realizado ainda.", "warning"); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = gerarPDFBase(doc, "Cliente");

            if (dadosNegativado) {
                y += 10; doc.setFontSize(12); doc.text("Resumo do C√°lculo Negativado", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Parcelas Originais: ${formatarMoeda(dadosNegativado.totalParcelas)}`, 15, y); y += 6;
                doc.text(`Valor Negativo Informado: ${formatarMoeda(dadosNegativado.negativo)}`, 15, y); y += 6;
                doc.text(`Nova Parcela Calculada: ${formatarMoeda(dadosNegativado.novaParcela)}`, 15, y); y += 6;
            }

            y += 10; doc.setFontSize(12);
            if (calculoDetalhado.tipo.includes('margem_nova')) {
                doc.text("Resumo da Simula√ß√£o de Margem Nova", 15, y); y += 8;
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor Liberado (Estimado): ${formatarMoeda(calculoDetalhado.valorLiberado)}`, 15, y); y += 10;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Valor Total do Contrato: ${formatarMoeda(calculoDetalhado.valorTotalContrato)}`, 15, y);
            } else {
                doc.text("Resumo da Opera√ß√£o Simulada", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Saldo Devedor Total a Quitar (Aprox.): ${formatarMoeda(calculoDetalhado.s)}`, 15, y); y += 10;
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor L√≠quido Estimado para o Cliente: ${formatarMoeda(calculoDetalhado.valorOfertaFinal)}`, 15, y);
                y += 10; doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Coeficiente Real (para confer√™ncia): ${calculoDetalhado.coeficienteReal ? calculoDetalhado.coeficienteReal.toFixed(8) : 'N/A'}`, 15, y);
            }
            y += 15; doc.setFontSize(8); doc.setFont('helvetica', 'italic'); doc.text("Valores aproximados. A proposta final pode variar.", 15, y);
            doc.save(gerarNomeArquivo('cliente'));
        }

        function gerarPDFEscritorio() {
            if (!calculoDetalhado || Object.keys(calculoDetalhado).length === 0) { showToast("Nenhum c√°lculo foi realizado ainda.", "warning"); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); 
            
            // Reutiliza a base (que j√° ajustamos o nome/cpf na l√≥gica anterior)
            let y = gerarPDFBase(doc, "Escrit√≥rio");

            // Espa√ßamento um pouco maior (7 em vez de 6)
            const gap = 7; 

            // Se for Negativado
            if (dadosNegativado) {
                y += 10; doc.setFontSize(12); doc.text("Resumo do C√°lculo Negativado", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Parcelas Originais: ${formatarMoeda(dadosNegativado.totalParcelas)}`, 15, y); y += gap;
                doc.text(`Valor Negativo Informado: ${formatarMoeda(dadosNegativado.negativo)}`, 15, y); y += gap;
                doc.text(`Nova Parcela Calculada: ${formatarMoeda(dadosNegativado.novaParcela)}`, 15, y); y += gap;
            }

            y += 10; doc.setFontSize(12);
            if (calculoDetalhado.tipo.includes('margem_nova')) {
                doc.text("Detalhes da Opera√ß√£o (Uso Interno)", 15, y); y += 8; doc.setFontSize(10);
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor Liberado (Estimado): ${formatarMoeda(calculoDetalhado.valorLiberado)}`, 15, y); y += 10;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Valor Total do Contrato: ${formatarMoeda(calculoDetalhado.valorTotalContrato)}`, 15, y); y += gap;
                doc.text(`Coeficiente Informado: ${calculoDetalhado.coef ? calculoDetalhado.coef.toFixed(8) : 'N/A'}`, 15, y);
            } else {
                doc.text("Detalhes da Opera√ß√£o (Uso Interno)", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Novo Saldo (Gerado pela Parcela): ${formatarMoeda(calculoDetalhado.novoS)}`, 15, y); y += gap;
                doc.text(`Saldo Devedor a Quitar: ${formatarMoeda(calculoDetalhado.s)}`, 15, y); y += gap;
                if(calculoDetalhado.d > 0) {
                    doc.text(`Produto (Opcional): ${formatarMoeda(calculoDetalhado.d)}`, 15, y); y += gap;
                }
                
                doc.text("--------------------------------------------------", 15, y); y += gap;

                if (calculoDetalhado.tipo.includes('compra')) {
                    doc.text(`Valor Bruto Dispon√≠vel: ${formatarMoeda(calculoDetalhado.sub)}`, 15, y); y += gap;
                    
                    // CORRE√á√ÉO DOS NAN%
                    const txInv = calculoDetalhado.investidorR ? (calculoDetalhado.investidorR * 100).toFixed(0) : '0';
                    doc.text(`Comiss√£o Investidor (${txInv}% sobre Saldo): - ${formatarMoeda(calculoDetalhado.investidor)}`, 15, y); y += gap;
                    
                    const txGer = calculoDetalhado.comissaoG || 0;
                    doc.text(`Comiss√£o Gerente (${txGer}% sobre Bruto): - ${formatarMoeda(calculoDetalhado.gerente)}`, 15, y); y += gap;
                } else {
                    doc.text(`Valor Bruto Liberado (Troco Inicial): ${formatarMoeda(calculoDetalhado.sub)}`, 15, y); y += gap;
                    if (calculoDetalhado.valorQuitado > 0) {
                        doc.text(`Valor Quitado Adicional: - ${formatarMoeda(calculoDetalhado.valorQuitado)}`, 15, y); y += gap;
                    }
                    const txGer = calculoDetalhado.comissaoG || 0;
                    doc.text(`Comiss√£o Gerente (${txGer}% sobre L√≠quido): - ${formatarMoeda(calculoDetalhado.gerente)}`, 15, y); y += gap;
                }

                doc.setFont('helvetica', 'bold');
                // CORRE√á√ÉO DO VALOR GERAL ZERADO
                const vGeral = calculoDetalhado.valorGeral || 0;
                doc.text(`Valor Geral L√≠quido (antes Escrit√≥rio): ${formatarMoeda(vGeral)}`, 15, y); y += gap;
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Comiss√£o Escrit√≥rio: - ${formatarMoeda(calculoDetalhado.comissaoEsc)}`, 15, y); y += 10; // Espa√ßo extra antes do final
                
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.text(`Valor L√≠quido Cliente (Estimado): ${formatarMoeda(calculoDetalhado.valorOfertaFinal)}`, 15, y);
                y += 10; doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                
                doc.text(`Coeficiente Input (Simula√ß√£o): ${calculoDetalhado.coef ? calculoDetalhado.coef.toFixed(8) : 'N/A'}`, 15, y); y += gap;
                doc.text(`Coeficiente Real (Calculado): ${calculoDetalhado.coeficienteReal ? calculoDetalhado.coeficienteReal.toFixed(8) : 'N/A'}`, 15, y);
            }
            
            y += 15; doc.setFontSize(8); doc.setFont('helvetica', 'italic'); 
            doc.text("Valores aproximados para an√°lise interna.", 15, y);
            
            doc.save(gerarNomeArquivo('escritorio'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('upload-label');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault(); uploadArea.classList.remove('hover');
                if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].type === "application/pdf") { document.getElementById('pdf-upload').files = e.dataTransfer.files; document.getElementById('pdf-upload').dispatchEvent(new Event('change')); }
                else if (e.dataTransfer.files.length > 0) { showToast("Por favor, arraste apenas arquivos PDF.", "warning"); }
            });

            document.getElementById("pdf-upload").addEventListener("change", parsearPdf);
            document.getElementById("unificarBtnPdf").addEventListener("click", () => unificarContratos(false));
            document.getElementById('addManualBtn').addEventListener('click', adicionarContratoManual);
            document.getElementById('convenioSelect').addEventListener('change', atualizarOperacoes);
            document.getElementById('operacaoSelect').addEventListener('change', atualizarVisibilidadeUI);

            document.getElementById("calcForm").addEventListener("submit", function (e) {
                e.preventDefault();
                const operacao = document.getElementById('operacaoSelect').value;
                if (!operacao) { showToast("Selecione um Tipo de Opera√ß√£o.", "warning"); return; }
                if (operacao.includes('margem_nova')) { calcularMargemNova(); }
                else if (operacao.includes('negativado')) {
                    if (!document.getElementById("negativo").value) { showToast("Preencha o Valor Negativo do Cliente.", "warning"); document.getElementById("negativo").focus(); return; }
                    const isManual = document.getElementById('manual-tab').classList.contains('active');
                    const hasContracts = isManual ? parcelasManuais.length > 0 : document.querySelectorAll('.loan-checkbox:checked').length > 0;
                    if (!hasContracts) { showToast("Selecione ou adicione contratos antes de calcular o negativado.", "warning"); return; }
                    calcularNegativado();
                } else {
                    if (!document.getElementById("parcela").value || !document.getElementById("saldodevedor").value || !document.getElementById("coeficiente").value || !document.getElementById("comissaoGerente").value) {
                        showToast("Preencha todos os campos obrigat√≥rios da simula√ß√£o (Parcela, Saldo, Coeficiente, Comiss√µes).", "warning"); return;
                    }
                    calcularSimulacaoCompleta();
                }
            });

            document.getElementById('goToPortabilidadeBtn').addEventListener('click', () => {
                if (!calculoDetalhado || calculoDetalhado.novaParcela === undefined) { showToast("Realize o c√°lculo de negativado primeiro.", "warning"); return; }
                sessionStorage.setItem('calculoNegativadoData', JSON.stringify(calculoDetalhado));
                const convenio = document.getElementById('convenioSelect').value; const opValue = (convenio === 'exercito') ? 'portabilidade_exercito' : 'portabilidade_siape';
                document.getElementById('convenioSelect').value = convenio; atualizarOperacoes(); document.getElementById('operacaoSelect').value = opValue;
                verificarDadosNegativado(); atualizarVisibilidadeUI(); document.getElementById('simulacaoCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });

            document.getElementById('goToCompraBtn').addEventListener('click', () => {
                if (!calculoDetalhado || calculoDetalhado.novaParcela === undefined) { showToast("Realize o c√°lculo de negativado primeiro.", "warning"); return; }
                sessionStorage.setItem('calculoNegativadoData', JSON.stringify(calculoDetalhado));
                const convenio = document.getElementById('convenioSelect').value; const opValue = (convenio === 'exercito') ? 'compra_exercito' : 'compra_siape';
                document.getElementById('convenioSelect').value = convenio; atualizarOperacoes(); document.getElementById('operacaoSelect').value = opValue;
                verificarDadosNegativado(); atualizarVisibilidadeUI(); document.getElementById('simulacaoCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });

            document.querySelectorAll('input[name="quitacao"]').forEach(r => r.addEventListener('change', function () {
                const quitadoContainer = document.getElementById('quitadoContainer'); quitadoContainer.style.display = this.value === 'sim' ? 'block' : 'none';
                if (this.value === 'nao') { document.getElementById('valorQuitado').value = ''; }
            }));

            ['#manualParcela', '#negativo', '#parcela', '#saldodevedor', '#desconto', '#valorQuitado', '#comissaoesc', '#mn-parcela'].forEach(selector => {
                const el = document.querySelector(selector);
                if (el) {
                    el.addEventListener('blur', function () { if (this.value.trim() !== "") { const valorNum = moedaParaFloat(this.value); this.value = formatarInputMoeda(valorNum); } });
                    el.addEventListener('focus', function () { if (this.value.trim() !== "") { const valorNum = moedaParaFloat(this.value); this.value = (valorNum === 0) ? '' : valorNum.toString().replace('.', ','); } });
                }
            });

            verificarDadosNegativado();
            // CHAMA ATUALIZAR OPERA√á√ïES AO INICIAR PARA GARANTIR SIAPE + COMPRA PADR√ÉO
            atualizarOperacoes();

            // CARREGA NOME CORRESPONDENTE SE EXISTIR
            const savedName = localStorage.getItem('nomeCorrespondente');
            if (savedName) {
                document.getElementById('nomeCorrespondente').value = savedName;
                atualizarScript();
            }
        });
    </script>
</body>

</html>