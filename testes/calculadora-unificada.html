<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Calculadora Unificada - Consignado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../icone.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        .btn-voltar { position: fixed; top: 15px; left: 15px; z-index: 1030; }
        .container { max-width: 800px; margin: 20px auto; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #0d6efd; padding: 30px; text-align: center; cursor: pointer; background-color: #f8f9fa; transition: background-color 0.2s, border-color 0.2s; }
        .upload-area.hover { background-color: #e9ecef; border-color: #0b5ed7; }
        #pdf-upload { display: none; }
        #loading-spinner { width: 1.5rem; height: 1.5rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1090; }
        .toast { width: 350px; max-width: 100%; }
        .resultado-final-valor { font-size: 1.75rem; font-weight: bold; }
        .logos { display: none; } 
    </style>
</head>

<body>
    <a href="/testes/testes.html" class="btn btn-secondary btn-voltar">← Voltar</a>
    <div class="toast-container" id="toast-container"></div>

    <div class="logos">
        <img src="../images/logoheader.png" id="logo-alianca">
        <img src="../images/polo-promotora.png" id="logo-polo">
        <img src="../images/estilo-promotora.png" id="logo-estilo">
        <img src="../images/exercito.png" id="convenio-logo-exercito">
        <img src="../images/siape.png" id="convenio-logo-siape">
    </div>

    <div class="container" id="page-container">
        <h1 class="text-center h3 mb-4" id="pageTitle">Calculadora Consignado</h1>

        <div class="card mb-4">
            <div class="card-header"><h2 class="h5 mb-0">Seleção da Operação</h2></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="convenioSelect" class="form-label">1. Convênio</label>
                        <select id="convenioSelect" class="form-select">
                            <option value="exercito" selected>Exército (eConsig)</option>
                            <option value="siape">SIAPE</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="operacaoSelect" class="form-label">2. Tipo de Operação</label>
                        <select id="operacaoSelect" class="form-select"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="infoNegativado" class="alert alert-warning" style="display:none;"></div>

        <form id="calcForm">
            <div class="card mb-4" id="clienteCard">
                <div class="card-header"><h2 class="h5 mb-0">1. Dados do Cliente e Contratos</h2></div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="empresaSelect" class="form-label">Empresa Responsável</label>
                        <select id="empresaSelect" class="form-select">
                            <option value="alianca" selected>Aliança Consig</option>
                            <option value="polo">Polo Promotora</option>
                            <option value="estilo">Estilo Promotora</option>
                        </select>
                    </div>
                    <ul class="nav nav-tabs" id="entryTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf-tab-pane" type="button" role="tab">Carregar Extrato</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-tab-pane" type="button" role="tab">Inserir Manualmente</button></li>
                    </ul>
                    <div class="tab-content" id="entryTabContent">
                        <div class="tab-pane fade show active p-3" id="pdf-tab-pane" role="tabpanel">
                            <input type="file" id="pdf-upload" accept=".pdf"><label for="pdf-upload" class="upload-area" id="upload-label"><span id="upload-text">Clique ou arraste o extrato PDF</span><div id="loading" class="d-none align-items-center justify-content-center mt-2"><div class="spinner-border text-primary" id="loading-spinner" role="status"></div><strong class="ms-2">Analisando...</strong></div></label>
                            <div id="listaEmprestimos" class="mt-3" style="display:none;"></div>
                            <button type="button" id="unificarBtnPdf" class="btn btn-info w-100 mt-3" style="display:none;">Usar Contratos Selecionados</button>
                        </div>
                        <div class="tab-pane fade p-3" id="manual-tab-pane" role="tabpanel">
                             <div class="row mb-3"><div class="col-md-6 mb-2"><label for="clienteNome" class="form-label">Nome do Cliente</label><input type="text" id="clienteNome" class="form-control"></div><div class="col-md-6 mb-2"><label for="clienteCpf" class="form-label">CPF do Cliente</label><input type="text" id="clienteCpf" class="form-control" placeholder="000.000.000-00"></div></div>
                             <div class="p-3 mb-3 border rounded"><h3 class="fs-5 text-center mb-3">Adicionar Contratos</h3><div class="row g-2"><div class="col-md-7 mb-2"><label for="manualBanco" class="form-label">Banco</label><input type="text" id="manualBanco" class="form-control"></div><div class="col-md-5 mb-2"><label for="manualParcela" class="form-label">Valor Parcela</label><input type="text" id="manualParcela" class="form-control"></div><div class="col-6 col-md-4 mb-2"><label for="manualTotalParcelas" class="form-label">Total</label><input type="number" id="manualTotalParcelas" class="form-control" value="96"></div><div class="col-6 col-md-4 mb-2"><label for="manualParcelasPagas" class="form-label">Pagas</label><input type="number" id="manualParcelasPagas" class="form-control"></div><div class="col-12 col-md-4 d-flex align-items-end mb-2"><button type="button" id="addManualBtn" class="btn btn-secondary w-100">Adicionar</button></div></div><div id="manual-loans-list" class="mt-3"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="simulacaoCard">
                <div class="card-header"><h2 class="h5 mb-0" id="simulacaoTitle">2. Dados da Simulação</h2></div>
                <div class="card-body">
                    <div class="row">
                        <div id="negativado-fields" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Soma das parcelas:</label>
                                <h4 id="totalParcelasDisplay" class="fw-bold text-primary">R$ 0,00</h4>
                            </div>
                            <div class="mb-3">
                                <label for="negativo" class="form-label">Valor Negativo do Cliente</label>
                                <input type="text" id="negativo" class="form-control" placeholder="Ex: 1000,00" required>
                            </div>
                        </div>

                        <div id="simulacao-fields" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="parcela" class="form-label">Valor Total da Parcela</label><input type="text" id="parcela" class="form-control" required placeholder="Unificado do passo anterior"></div>
                                <div class="col-md-6 mb-3"><label for="saldodevedor" class="form-label">Saldo Devedor Aprox. Total</label><input type="text" id="saldodevedor" class="form-control" required placeholder="Unificado do passo anterior"></div>
                            </div>
                            
                            <div class="p-3 mb-3 border rounded">
                                <h5 class="fs-6 text-primary mb-3">Dados do Novo Contrato</h5>
                                <div class="row">
                                    <div class="col-md-8 mb-2">
                                        <label for="novoBanco" class="form-label">Banco Destino</label>
                                        <input type="text" id="novoBanco" class="form-control" value="Bradesco">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label for="novoPrazo" class="form-label">Prazo (meses)</label>
                                        <input type="number" id="novoPrazo" class="form-control" value="96">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3"><label for="desconto" class="form-label">Produto (Opcional)</label><input type="text" id="desconto" class="form-control" placeholder="Ex: 1.000,00"></div>
                            </div>
                            
                            <div id="port-refin-fields" style="display:none;">
                                <div class="col-md-12 mb-3"><label class="form-label">Houve quitação de algum valor?</label><div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="quitacao" id="quitacaoNao" value="nao" checked><label class="form-check-label" for="quitacaoNao">Não</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="quitacao" id="quitacaoSim" value="sim"><label class="form-check-label" for="quitacaoSim">Sim</label></div></div></div>
                                <div id="quitadoContainer" style="display:none;" class="col-md-12 mb-3"><label for="valorQuitado" class="form-label">Valor a ser quitado</label><input type="text" id="valorQuitado" class="form-control" placeholder="Ex: 5.000,00"></div>
                            </div>

                            <div id="compra-fields" style="display:none;">
                                 <div class="col-md-12 mb-3"><label for="tipoCompra" class="form-label">Tipo de Compra</label><select id="tipoCompra" class="form-select"><option value="bradesco" selected>Bradesco (Inv. 10%)</option><option value="cef">Caixa (CEF) (Inv. 8%)</option></select></div>
                            </div>
                            
                            <hr class="my-3">
                            <div class="row">
                                <div class="col-md-4 mb-3"><label for="coeficiente" class="form-label">Coeficiente</label><input type="text" id="coeficiente" class="form-control" value="0.02" required></div>
                                <div class="col-md-4 mb-3"><label for="comissaoGerente" class="form-label">Comissão Gerente (%)</label><input type="text" id="comissaoGerente" class="form-control" value="15" required></div>
                                <div class="col-md-4 mb-3"><label for="comissaoesc" class="form-label">Comissão Escritório</label><input type="text" id="comissaoesc" class="form-control" required value="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer"><button class="btn btn-primary w-100" type="submit" id="submitBtn">Calcular</button></div>
            </div>
        </form>

        <div id="resultadoFinal" class="mt-4" style="display:none;"></div>
        
        <div id="resultadoNegativadoContainer" class="mt-4" style="display:none;">
            <div class="card bg-light">
                <div class="card-header"><h3 class="h5 mb-0">3. Resultado da Análise</h3></div>
                <div class="card-body" id="resultadoNegativadoBody"></div>
                <div class="card-footer text-center">
                    <p class="mb-2">Avançar para a simulação de:</p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button class="btn btn-primary" id="goToPortabilidadeBtn" type="button">Portabilidade</button>
                        <button class="btn btn-secondary" id="goToCompraBtn" type="button">Compra de Dívida</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        let clienteNomePDF = '', clienteCpfPDF = '', parcelasSelecionadasPDF = [], calculoDetalhado = {};
        let parcelasManuais = [], dadosNegativado = null;

        const operacoes = {
            exercito: [
                { value: 'portabilidade_exercito', text: 'Portabilidade', coef: '0.019' },
                { value: 'compra_exercito', text: 'Compra de Dívida', coef: '0.02' },
                { value: 'margem_refin_exercito', text: 'Margem + Refin Bradesco', coef: '0.02' },
                { value: 'negativado_exercito', text: 'Análise de Negativado', coef: '' } 
            ],
            siape: [
                { value: 'portabilidade_siape', text: 'Portabilidade', coef: '0.0190' },
                { value: 'compra_siape', text: 'Compra de Dívida', coef: '0.02' },
                { value: 'negativado_siape', text: 'Análise de Negativado', coef: '' }
            ]
        };

        const moedaParaFloat = (v) => parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        const formatarMoeda = (v) => (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const formatarInputMoeda = (v) => (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\s/g, '');

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'danger' ? 'bg-danger' : (type === 'warning' ? 'bg-warning text-dark' : 'bg-success');
            const toastHtml = `<div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 4000 });
            toast.show();
            const toastEl = document.getElementById(toastId);
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        };

        function atualizarOperacoes() {
            const convenio = document.getElementById('convenioSelect').value;
            const operacaoSelect = document.getElementById('operacaoSelect');
            operacaoSelect.innerHTML = '';
            operacoes[convenio].forEach(op => {
                operacaoSelect.add(new Option(op.text, op.value));
            });
            atualizarVisibilidadeUI();
        }

        function atualizarVisibilidadeUI() {
            const convenio = document.getElementById('convenioSelect').value;
            const operacaoValue = document.getElementById('operacaoSelect').value;
            const operacao = (operacoes[convenio] || []).find(op => op.value === operacaoValue) || {};
            
            document.getElementById('resultadoFinal').style.display = 'none';
            document.getElementById('resultadoNegativadoContainer').style.display = 'none';

            const clienteCard = document.getElementById('clienteCard');
            const simulacaoCard = document.getElementById('simulacaoCard');
            const negativadoFields = document.getElementById('negativado-fields');
            const simulacaoFields = document.getElementById('simulacao-fields');
            const portRefinFields = document.getElementById('port-refin-fields');
            const compraFields = document.getElementById('compra-fields');
            const submitBtn = document.getElementById('submitBtn');
            
            // Referências aos inputs
            const negativoInput = document.getElementById('negativo');
            const parcelaInput = document.getElementById('parcela');
            const saldoInput = document.getElementById('saldodevedor');
            const coefInput = document.getElementById('coeficiente');
            const comGerenteInput = document.getElementById('comissaoGerente');
            const comEscInput = document.getElementById('comissaoesc');
            
            document.getElementById('pageTitle').textContent = operacao.text ? `Calculadora ${operacao.text} (${convenio.toUpperCase()})` : 'Calculadora Consignado';

            if (operacaoValue.includes('negativado')) {
                clienteCard.style.display = 'block';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'block';
                simulacaoFields.style.display = 'none';
                document.getElementById('simulacaoTitle').textContent = "2. Cálculo";
                submitBtn.textContent = 'Calcular Nova Parcela';
                
                // Gerencia o 'required'
                negativoInput.required = true;
                parcelaInput.required = false;
                saldoInput.required = false;
                coefInput.required = false;
                comGerenteInput.required = false;
                comEscInput.required = false;
                
            } else {
                clienteCard.style.display = 'block';
                simulacaoCard.style.display = 'block';
                negativadoFields.style.display = 'none';
                simulacaoFields.style.display = 'block';
                document.getElementById('simulacaoTitle').textContent = "2. Dados da Simulação";
                submitBtn.textContent = 'Calcular Simulação Completa';

                if(operacao.coef) document.getElementById('coeficiente').value = operacao.coef;

                if (operacaoValue.includes('compra')) {
                    portRefinFields.style.display = 'none';
                    compraFields.style.display = 'block';
                } else if (operacaoValue.includes('portabilidade') || operacaoValue.includes('refin')) {
                    portRefinFields.style.display = 'block';
                    compraFields.style.display = 'none';
                } else {
                    portRefinFields.style.display = 'none';
                    compraFields.style.display = 'none';
                }
                
                // Gerencia o 'required'
                negativoInput.required = false;
                parcelaInput.required = true;
                saldoInput.required = true;
                coefInput.required = true;
                comGerenteInput.required = true;
                comEscInput.required = true;
            }
        }

        function verificarDadosNegativado() {
            const data = sessionStorage.getItem('calculoNegativadoData');
            if (data) {
                try {
                    dadosNegativado = JSON.parse(data);
                    clienteNomePDF = dadosNegativado.nome || '';
                    clienteCpfPDF = dadosNegativado.cpf || '';
                    document.getElementById('parcela').value = formatarInputMoeda(dadosNegativado.novaParcela);
                    if (dadosNegativado.saldoDevedor > 0) document.getElementById('saldodevedor').value = formatarInputMoeda(dadosNegativado.saldoDevedor);
                    
                    const infoDiv = document.getElementById('infoNegativado');
                    infoDiv.innerHTML = `<h5 class="alert-heading">Dados da Análise de Negativado</h5><p class="mb-1">Os campos de parcela e saldo foram preenchidos com base no cálculo anterior.</p><hr><p class="mb-0"><strong>Nova Parcela para cálculo:</strong> ${formatarMoeda(dadosNegativado.novaParcela)}</p>`;
                    infoDiv.style.display = 'block';
                } catch (e) { 
                    console.error("Erro ao processar dados de negativado:", e); 
                    dadosNegativado = null;
                } finally { 
                    sessionStorage.removeItem('calculoNegativadoData'); 
                }
            } else {
                 document.getElementById('infoNegativado').style.display = 'none';
                 dadosNegativado = null;
            }
        }
        
        async function processarPdfExercicio(text) {
            let cleanText = text.replace(/--- FIM DA PÁGINA \d+ ---/g, '').replace(/Consignatária\n\s*▴\s*▾[\s\S]+?Situação\n\s*▴\s*▾/g, '');
            const cpfRegex = /(\d{3}\.\d{3}\.\d{3}-\d{2})/;
            const nomeRegex = /\d{9}\s*-\s*\d{3}\.\d{3}\.\d{3}-\d{2}\s*-\s*([A-ZÀ-Ú ]+)\n([A-ZÀ-Ú ]+)/;
            clienteCpfPDF = (text.match(cpfRegex) || [])[0] || '';
            const nomeMatch = text.match(nomeRegex);
            if (nomeMatch) { clienteNomePDF = `${nomeMatch[1].trim()} ${nomeMatch[2].trim()}`; }
            
            const listaDiv = document.getElementById("listaEmprestimos");
            listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;
            
            const blocos = cleanText.split(/\n(?=\d{3}\s*-\s*)/);
            let loansFound = 0;
            blocos.forEach((bloco, index) => {
                if (bloco.includes('EMPRÉSTIMO') && bloco.includes('Em\nAndamento')) {
                    const bancoMatch = bloco.match(/^(\d{3}\s*-\s*[\s\S]+?)(?=\n\d{7}\n)/);
                    const valorMatch = bloco.match(/R\$\s*[\d.,]+/);
                    const parcelasMatch = /(\d+)\s*\n\s*(\d+)\s*\n\s*Em\nAndamento/;
                    const parcelasResult = bloco.match(parcelasMatch);
                    if (bancoMatch && valorMatch && parcelasResult) {
                        const nomeBanco = bancoMatch[1].replace(/\n/g, ' ').trim();
                        const valor = valorMatch[0];
                        const total = parcelasResult[1];
                        const pagas = parcelasResult[2];
                        if (total === 'Indet.') return;
                        loansFound++;
                        const valorParcelaNum = moedaParaFloat(valor);
                        const parcelasRestantes = parseInt(total, 10) - parseInt(pagas, 10);
                        if (parcelasRestantes < 0) return;
                        const saldoAproximado = valorParcelaNum * parcelasRestantes * 0.70;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'form-check border-bottom py-2';
                        itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" data-banco="${nomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${nomeBanco}</strong><br><small>Saldo Aprox.: ${formatarMoeda(saldoAproximado)} | Parcela: ${formatarMoeda(valorParcelaNum)} | Status: ${pagas} de ${total}</small></label>`;
                        listaDiv.appendChild(itemDiv);
                    }
                }
            });
            
            if (loansFound === 0) showToast("AVISO: Nenhum contrato 'Em Andamento' foi encontrado no formato esperado.", 'warning');
            
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
            listaDiv.style.display = "block";
            document.getElementById("unificarBtnPdf").style.display = "block";
        }
        
        async function processarPdfSiape(text) {
            const headerRegex = /Órgão\nCPF\nMatrícula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
            const headerMatch = text.match(headerRegex);
            if (headerMatch) { clienteCpfPDF = headerMatch[1].trim(); clienteNomePDF = headerMatch[2].trim(); }
            
            const listaDiv = document.getElementById("listaEmprestimos");
            listaDiv.innerHTML = `<div id="infoCliente" class="mb-3 p-2 border rounded"><p class="mb-1"><strong>Nome:</strong> ${clienteNomePDF}</p><p class="mb-0"><strong>CPF:</strong> ${clienteCpfPDF}</p></div><div class="form-check mb-2 border-bottom pb-2"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"><label class="form-check-label fw-bold" for="selectAllCheckbox">Selecionar Todos</label></div>`;
            
            const rgxEmprestimos = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g;
            let matches = [...text.matchAll(rgxEmprestimos)];
            matches.forEach((match, index) => {
                const [_, nomeBanco, valor, parcelasStr] = match;
                const cleanNomeBanco = nomeBanco.replace(/^\d{5}\s*-\s*/, '').trim();
                const [pagas, total] = parcelasStr.split('/');
                const valorParcelaNum = moedaParaFloat(valor);
                const saldoAproximado = valorParcelaNum * (parseInt(total, 10) - parseInt(pagas, 10)) * 0.70;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-check border-bottom py-2';
                itemDiv.innerHTML = `<input class="form-check-input loan-checkbox" type="checkbox" data-saldo="${saldoAproximado}" data-parcela="${valorParcelaNum}" data-banco="${cleanNomeBanco}" data-status="${pagas} de ${total}" id="loan-${index}"><label class="form-check-label" for="loan-${index}"><strong>${cleanNomeBanco}</strong><br><small>Saldo Aprox.: ${formatarMoeda(saldoAproximado)} | Parcela: ${formatarMoeda(valorParcelaNum)} | Status: ${pagas} de ${total}</small></label>`;
                listaDiv.appendChild(itemDiv);
            });
            
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked));
            listaDiv.style.display = "block";
            document.getElementById("unificarBtnPdf").style.display = "block";
        }

        async function parsearPdf(event) {
            const file = event.target.files[0];
            if (!file) return;
            clienteNomePDF = ''; clienteCpfPDF = '';
            document.getElementById("loading").classList.remove('d-none'); document.getElementById("loading").classList.add('d-flex'); document.getElementById('upload-text').style.display = 'none';

            const fileReader = new FileReader();
            fileReader.onload = async function () {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        text += textContent.items.map(item => item.str).join('\n') + '\n\n';
                    }

                    const convenio = document.getElementById('convenioSelect').value;
                    if (convenio === 'exercito') {
                        await processarPdfExercicio(text);
                    } else if (convenio === 'siape') {
                        await processarPdfSiape(text);
                    }
                    
                    showToast("Extrato lido com sucesso!", "success");

                } catch (error) {
                    console.error("Erro ao processar o PDF:", error);
                    showToast("Ocorreu um erro ao ler o arquivo PDF.", "danger");
                } finally {
                    document.getElementById("loading").classList.add('d-none');
                    document.getElementById("loading").classList.remove('d-flex');
                    document.getElementById('upload-text').style.display = 'block';
                }
            };
            fileReader.readAsArrayBuffer(file);
        }

        function unificarContratos(isManual) {
            let totalSaldo = 0, totalParcela = 0;
            parcelasSelecionadasPDF = [];
            
            if (isManual) {
                parcelasManuais.forEach(p => {
                    totalParcela += p.parcela;
                    const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0);
                    if (parcelasRestantes > 0) totalSaldo += p.parcela * parcelasRestantes * 0.70;
                });
            } else {
                const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkedBoxes.length === 0) return showToast("Selecione ao menos um contrato.", "warning");
                
                checkedBoxes.forEach(cb => {
                    totalSaldo += parseFloat(cb.dataset.saldo);
                    totalParcela += parseFloat(cb.dataset.parcela);
                    parcelasSelecionadasPDF.push({ banco: cb.dataset.banco, parcela: formatarMoeda(parseFloat(cb.dataset.parcela)), saldo: formatarMoeda(parseFloat(cb.dataset.saldo)), status: cb.dataset.status });
                });
            }
            
            const operacao = document.getElementById('operacaoSelect').value;
            if (operacao.includes('negativado')) { 
                 document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcela);
            } else {
                document.getElementById("parcela").value = formatarInputMoeda(totalParcela);
                document.getElementById("saldodevedor").value = formatarInputMoeda(totalSaldo);
            }
            
            if (!isManual) showToast("Valores unificados e preenchidos no formulário.");
        }

        function renderizarListaManual() {
            const listaDiv = document.getElementById('manual-loans-list');
            listaDiv.innerHTML = '';
            if (parcelasManuais.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';
                parcelasManuais.forEach((p, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><strong>${p.banco}</strong> - ${formatarMoeda(p.parcela)}<br><small class="text-muted">${p.parcelasPagas} de ${p.totalParcelas}</small></div><button type="button" class="btn btn-outline-danger btn-sm" onclick="removerParcelaManual(${index})">X</button>`;
                    ul.appendChild(li);
                });
                listaDiv.appendChild(ul);
            }
            unificarContratos(true);
        }

        window.removerParcelaManual = (index) => { parcelasManuais.splice(index, 1); renderizarListaManual(); }
        
        function adicionarContratoManual() {
            const banco = document.getElementById('manualBanco').value || 'Não informado';
            const parcelaValor = moedaParaFloat(document.getElementById('manualParcela').value);
            const totalParcelas = parseInt(document.getElementById('manualTotalParcelas').value, 10);
            const parcelasPagas = parseInt(document.getElementById('manualParcelasPagas').value, 10);

            if (!parcelaValor || !totalParcelas || isNaN(parcelasPagas)) return showToast("Preencha valor e parcelas corretamente.", 'danger');
            if (parcelasPagas > totalParcelas) return showToast("Pagas não pode ser maior que o total.", 'danger');
            
            parcelasManuais.push({ banco, parcela: parcelaValor, totalParcelas, parcelasPagas });
            ['manualBanco', 'manualParcela', 'manualParcelasPagas'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('manualTotalParcelas').value = '96';
            renderizarListaManual();
            showToast("Contrato adicionado.");
        }

        function calcularNegativado() {
            let totalParcelas = 0, saldoFinal = 0;
            const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');

            if (isManualTabActive) {
                let saldoManual = 0;
                parcelasManuais.forEach(p => {
                    totalParcelas += p.parcela;
                    const restantes = p.totalParcelas - p.parcelasPagas;
                    if (restantes > 0) saldoManual += p.parcela * restantes * 0.70;
                });
                saldoFinal = saldoManual;
            } else {
                 const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
                 if (checkedBoxes.length === 0) return showToast("Selecione ao menos um contrato.", 'danger');
                 checkedBoxes.forEach(cb => {
                    totalParcelas += parseFloat(cb.dataset.parcela);
                    saldoFinal += parseFloat(cb.dataset.saldo);
                });
            }

            if (totalParcelas === 0) return showToast("Adicione pelo menos um contrato para calcular.", 'danger');
            
            const negativo = moedaParaFloat(document.getElementById("negativo").value);
            // A validação 'required' do HTML pega antes, mas mantemos por segurança.
            if(negativo <= 0) return showToast("Insira um valor negativo válido.", 'danger'); 

            const novaParcela = totalParcelas - negativo;
            const nomeFinal = document.getElementById('clienteNome').value.trim() || clienteNomePDF;
            const cpfFinal = document.getElementById('clienteCpf').value.trim() || clienteCpfPDF;

            const operacao = document.getElementById('operacaoSelect').value;
            calculoDetalhado = { tipo: operacao, totalParcelas, negativo, novaParcela, saldoDevedor: saldoFinal, nome: nomeFinal, cpf: cpfFinal };

            document.getElementById("resultadoNegativadoContainer").style.display = "block";
            document.getElementById("resultadoNegativadoBody").innerHTML = `
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>Total Parcelas Originais:</span> <strong>${formatarMoeda(totalParcelas)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Valor Negativo:</span> <strong class="text-danger">- ${formatarMoeda(negativo)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Saldo Devedor Aprox.:</span> <strong>${formatarMoeda(saldoFinal)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between bg-success-subtle"><h4>Nova Parcela p/ Cálculo:</h4> <h4 class="fw-bold">${formatarMoeda(novaParcela)}</h4></li>
                </ul>`;
            
            document.getElementById("resultadoNegativadoContainer").scrollIntoView({ behavior: 'smooth' });
        }

        function calcularSimulacaoCompleta() {
            const operacao = document.getElementById('operacaoSelect').value;
            calculoDetalhado = { tipo: operacao };

            const p = moedaParaFloat(document.getElementById("parcela").value), s = moedaParaFloat(document.getElementById("saldodevedor").value), d = moedaParaFloat(document.getElementById("desconto").value);
            const coef = parseFloat(document.getElementById("coeficiente").value.replace(",", ".")) || 0.02;
            const comissaoG = parseFloat(document.getElementById("comissaoGerente").value.replace(",", ".")) || 0;
            const comissaoEsc = moedaParaFloat(document.getElementById("comissaoesc").value);

            const novoBanco = document.getElementById("novoBanco").value || 'Bradesco';
            const novoPrazo = document.getElementById("novoPrazo").value || '96';

            // A validação 'required' do HTML pega antes, mas mantemos por segurança.
            if(!p || !s || !comissaoEsc) return showToast('Preencha Parcela, Saldo e Comissão do Escritório.', 'danger');

            const novoS = p / coef;
            calculoDetalhado = { ...calculoDetalhado, p, s, d, novoS, comissaoG, comissaoEsc, coef, novoBanco, novoPrazo, novaParcelaValor: p };

            let resultadoHtml = '', valorOfertaFinal = 0;

            if (operacao.includes('compra')) {
                const investidorR = (document.getElementById("tipoCompra").value === 'bradesco') ? 0.10 : 0.08;
                const sub = novoS - s - d, investidor = s * investidorR, gerente = sub * (comissaoG / 100);
                const valorGeral = sub - investidor - gerente;
                valorOfertaFinal = valorGeral - comissaoEsc;

                if (sub < 0 || valorGeral < 0) {
                    showToast('Operação Não Viável: O valor gerado é insuficiente.', 'danger');
                    return;
                }
                
                calculoDetalhado = { ...calculoDetalhado, sub, investidorR, investidor, gerente, valorGeral, valorOfertaFinal };
                resultadoHtml = `
                    <li class="list-group-item d-flex justify-content-between"><span>Novo Saldo (creditado na conta do cliente):</span> <strong>${formatarMoeda(novoS)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Saldo Devedor a Quitar:</span> <span class="text-danger">- ${formatarMoeda(s)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Produto:</span> <span class="text-danger">- ${formatarMoeda(d)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Bruto Liberado:</span> <strong>${formatarMoeda(sub)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comissão Investidor (${(investidorR * 100).toFixed(0)}%):</span> <span class="text-danger">- ${formatarMoeda(investidor)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comissão Gerente (${comissaoG}%):</span> <span class="text-danger">- ${formatarMoeda(gerente)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Geral Líquido:</span> <strong>${formatarMoeda(valorGeral)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comissão Escritório:</span> <span class="text-danger">- ${formatarMoeda(comissaoEsc)}</span></li>`;

            } else {
                const valorBrutoLiberado = novoS - s - d;
                let sub = valorBrutoLiberado, valorQuitado = 0, comissaoQuitado = 0;
                
                if (document.getElementById('quitacaoSim').checked) {
                    valorQuitado = moedaParaFloat(document.getElementById('valorQuitado').value);
                    if (valorQuitado > 0) {
                        comissaoQuitado = valorQuitado * 0.10;
                        sub -= (valorQuitado + comissaoQuitado);
                    }
                }
                const gerente = sub * (comissaoG / 100);
                const valorGeral = sub - gerente;
                valorOfertaFinal = valorGeral - comissaoEsc;

                calculoDetalhado = { ...calculoDetalhado, valorBrutoLiberado, gerente, valorQuitado, comissaoQuitado, valorGeral, valorOfertaFinal };
                resultadoHtml = `
                    <li class="list-group-item d-flex justify-content-between"><span>Novo Saldo (creditado na conta do cliente):</span> <strong>${formatarMoeda(novoS)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Saldo Devedor a Quitar:</span> <span class="text-danger">- ${formatarMoeda(s)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Produto:</span> <span class="text-danger">- ${formatarMoeda(d)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Bruto Liberado:</span> <strong>${formatarMoeda(valorBrutoLiberado)}</strong></li>
                    ${valorQuitado > 0 ? `<li class="list-group-item d-flex justify-content-between"><span>(-) Valor Quitado:</span> <span class="text-danger">- ${formatarMoeda(valorQuitado)}</span></li><li class="list-group-item d-flex justify-content-between"><span>(-) Comissão Quitação(10%):</span> <span class="text-danger">- ${formatarMoeda(comissaoQuitado)}</span></li>` : ''}
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comissão Gerente (${comissaoG}%):</span> <span class="text-danger">- ${formatarMoeda(gerente)}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(=) Valor Geral Líquido:</span> <strong>${formatarMoeda(valorGeral)}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>(-) Comissão Escritório:</span> <span class="text-danger">- ${formatarMoeda(comissaoEsc)}</span></li>`;
            }

            const resultadoDiv = document.getElementById("resultadoFinal");
            resultadoDiv.innerHTML = `
                <div class="card">
                    <div class="card-header bg-primary text-white"><h3 class="h5 mb-0">Resultado da Simulação</h3></div>
                    <div class="card-body">
                        <div class="text-center mb-4 border-bottom pb-3">
                            <h4 class="text-muted">Valor Líquido para o Cliente</h4>
                            <p class="resultado-final-valor text-success">${formatarMoeda(valorOfertaFinal)}</p>
                        </div>
                        <h5>Detalhamento:</h5>
                        <ul class="list-group list-group-flush">${resultadoHtml}</ul>
                    </div>
                    <div class="card-footer d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <button id="baixarPdfClienteBtn" class="btn btn-success" type="button">Baixar PDF (Cliente)</button>
                        <button id="baixarPdfEscritorioBtn" class="btn btn-secondary" type="button">Baixar PDF (Escritório)</button>
                    </div>
                </div>`;
            resultadoDiv.style.display = 'block';
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
            document.getElementById("baixarPdfClienteBtn").addEventListener("click", gerarPDFCliente);
            document.getElementById("baixarPdfEscritorioBtn").addEventListener("click", gerarPDFEscritorio);
        }

        function gerarPDFBase(doc, tipo) {
            const getBase64Image = (img) => { if (!img) return null; const c = document.createElement("canvas"); c.width = img.width; c.height = img.height; c.getContext("2d").drawImage(img, 0, 0); return c.toDataURL("image/png"); };
            
            const selectedEmpresa = document.getElementById('empresaSelect').value;
            const logoId = (selectedEmpresa === 'polo') ? 'logo-polo' : (selectedEmpresa === 'estilo' ? 'logo-estilo' : 'logo-alianca');
            const logoPrincipalImg = document.getElementById(logoId);
            
            const convenio = document.getElementById('convenioSelect').value;
            const convenioLogoId = (convenio === 'exercito') ? 'convenio-logo-exercito' : 'convenio-logo-siape';
            const convenioImgElem = document.getElementById(convenioLogoId);

            const logoPrincipalBase64 = getBase64Image(logoPrincipalImg);
            const convenioBase64 = getBase64Image(convenioImgElem);
            let y = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const logoPrincipalWidth = 40, logoConvenioWidth = 30;
            const logoPrincipalHeight = logoPrincipalImg ? logoPrincipalImg.naturalHeight * (logoPrincipalWidth / logoPrincipalImg.naturalWidth) : 0;
            const logoConvenioHeight = convenioImgElem ? convenioImgElem.naturalHeight * (logoConvenioWidth / convenioImgElem.naturalWidth) : 0;
            const maxHeight = Math.max(logoPrincipalHeight, logoConvenioHeight);
            
            if (logoPrincipalBase64) doc.addImage(logoPrincipalBase64, 'PNG', 15, y + (maxHeight - logoPrincipalHeight) / 2, logoPrincipalWidth, logoPrincipalHeight);
            if (convenioBase64) doc.addImage(convenioBase64, 'PNG', pageWidth - logoConvenioWidth - 15, y + (maxHeight - logoConvenioHeight) / 2, logoConvenioWidth, logoConvenioHeight);
            
            y += maxHeight > 0 ? maxHeight + 10 : 25;
            
            const operacaoText = document.getElementById('operacaoSelect').options[document.getElementById('operacaoSelect').selectedIndex].text;
            doc.setFontSize(18); doc.text(`Simulação de ${operacaoText} (${tipo})`, 105, y, { align: 'center' }); y += 20;
            
            const nomeFinal = document.getElementById('clienteNome').value.trim() || clienteNomePDF || 'Não informado';
            const cpfFinal = document.getElementById('clienteCpf').value.trim() || clienteCpfPDF || 'Não informado';
            const isManualTabActive = document.getElementById('manual-tab').classList.contains('active');
            
            const listaDeParcelas = isManualTabActive ? parcelasManuais.map(p => {
                const parcelasRestantes = (p.totalParcelas || 0) - (p.parcelasPagas || 0);
                const saldoManual = parcelasRestantes > 0 ? p.parcela * parcelasRestantes * 0.70 : 0;
                return { banco: p.banco, parcela: formatarMoeda(p.parcela), saldo: formatarMoeda(saldoManual), status: `${p.parcelasPagas || 0} de ${p.totalParcelas || 0}`};
            }) : parcelasSelecionadasPDF;

            doc.setFontSize(12); doc.text("Dados do Cliente", 15, y); y += 8;
            doc.setFontSize(10); doc.text(`Nome: ${nomeFinal}`, 15, y); y += 6; doc.text(`CPF: ${cpfFinal}`, 15, y);
            
            if (listaDeParcelas.length > 0) {
                y += 16; doc.setFontSize(12); doc.text("Parcelas para Unificação (Contratos Antigos)", 15, y); y += 8; doc.setFontSize(9);
                listaDeParcelas.forEach(p => { doc.text(`- Banco: ${p.banco} | Parcela: ${p.parcela} | Saldo Aprox.: ${p.saldo} | Status: ${p.status}`, 15, y); y += 6; });
            }

            y += 10; 
            doc.setFontSize(12); doc.text("Dados do Novo Contrato", 15, y); y += 8;
            doc.setFontSize(10);
            doc.text(`Banco: ${calculoDetalhado.novoBanco || 'Não inf.'}`, 15, y); y += 6;
            doc.text(`Prazo: ${calculoDetalhado.novoPrazo || 'Não inf.'}x`, 15, y); y += 6;
            doc.text(`Valor da Parcela: ${formatarMoeda(calculoDetalhado.novaParcelaValor)}`, 15, y); y += 6;

            return y;
        }

        function gerarNomeArquivo(tipoPdf) {
            const dataFormatada = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            const nomeManual = document.getElementById('clienteNome').value.trim();
            let nomeCliente = (nomeManual || clienteNomePDF || 'cliente').trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const operacao = document.getElementById('operacaoSelect').value;
            return `${operacao}_${nomeCliente}_${tipoPdf}_${dataFormatada}.pdf`;
        }

        function gerarPDFCliente() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let y = gerarPDFBase(doc, "Cliente");
            
            if (dadosNegativado) {
                y += 10; doc.setFontSize(12); doc.text("Resumo do Cálculo Negativado", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Parcelas Originais: ${formatarMoeda(dadosNegativado.totalParcelas)}`, 15, y); y += 6;
                doc.text(`Valor Negativo: ${formatarMoeda(dadosNegativado.negativo)}`, 15, y); y += 6;
                doc.text(`Nova Parcela: ${formatarMoeda(dadosNegativado.novaParcela)}`, 15, y);
            }

            y += 10; doc.setFontSize(12); doc.text("Resumo da Operação", 15, y); y += 8; doc.setFontSize(10);
            doc.text(`Saldo Devedor Total a Quitar (Aprox.): ${formatarMoeda(calculoDetalhado.s)}`, 15, y); y += 10;
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text(`Valor Líquido para o Cliente: ${formatarMoeda(calculoDetalhado.valorOfertaFinal)}`, 15, y);
            
            doc.save(gerarNomeArquivo('cliente'));
        }

        function gerarPDFEscritorio() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let y = gerarPDFBase(doc, "Escritório");

            if (dadosNegativado) {
                y += 10; doc.setFontSize(12); doc.text("Resumo do Cálculo Negativado", 15, y); y += 8; doc.setFontSize(10);
                doc.text(`Parcelas Originais: ${formatarMoeda(dadosNegativado.totalParcelas)}`, 15, y); y += 6;
                doc.text(`Valor Negativo: ${formatarMoeda(dadosNegativado.negativo)}`, 15, y); y += 6;
                doc.text(`Nova Parcela: ${formatarMoeda(dadosNegativado.novaParcela)}`, 15, y);
            }
            
            y += 10; doc.setFontSize(12); doc.text("Detalhes da Operação (Uso Interno)", 15, y); y += 8; doc.setFontSize(10);
            doc.text(`Novo Saldo (creditado na conta do cliente): ${formatarMoeda(calculoDetalhado.novoS)}`, 15, y); y += 6;
            doc.text(`Saldo Devedor a Quitar: ${formatarMoeda(calculoDetalhado.s)}`, 15, y); y += 6;
            doc.text(`Produto: ${formatarMoeda(calculoDetalhado.d)}`, 15, y); y += 6;
            doc.text("--------------------------------------------------", 15, y); y += 6;

            if (calculoDetalhado.tipo.includes('compra')) {
                doc.text(`Valor Bruto Liberado: ${formatarMoeda(calculoDetalhado.sub)}`, 15, y); y += 6;
                doc.text(`Comissão Investidor (${(calculoDetalhado.investidorR * 100).toFixed(0)}%): - ${formatarMoeda(calculoDetalhado.investidor)}`, 15, y); y += 6;
                doc.text(`Comissão Gerente (${calculoDetalhado.comissaoG}%): - ${formatarMoeda(calculoDetalhado.gerente)}`, 15, y); y += 6;
            } else {
                doc.text(`Valor Geral Bruto (Troco): ${formatarMoeda(calculoDetalhado.valorBrutoLiberado)}`, 15, y); y += 6;
                if (calculoDetalhado.valorQuitado > 0) {
                    doc.text(`Valor Quitado: - ${formatarMoeda(calculoDetalhado.valorQuitado)}`, 15, y); y += 6;
                    doc.text(`Comissão Quitação (10%): - ${formatarMoeda(calculoDetalhado.comissaoQuitado)}`, 15, y); y += 6;
                }
                doc.text(`Comissão Gerente (${calculoDetalhado.comissaoG}%): - ${formatarMoeda(calculoDetalhado.gerente)}`, 15, y); y += 6;
            }
            
            doc.setFont('helvetica', 'bold');
            doc.text(`Valor Geral Líquido: ${formatarMoeda(calculoDetalhado.valorGeral)}`, 15, y); y += 6;
            doc.setFont('helvetica', 'normal');
            doc.text(`Comissão Escritório: - ${formatarMoeda(calculoDetalhado.comissaoEsc)}`, 15, y); y += 8;
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text(`Valor Líquido Cliente: ${formatarMoeda(calculoDetalhado.valorOfertaFinal)}`, 15, y);
            
            doc.save(gerarNomeArquivo('escritorio'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('upload-label');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
            uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('hover'); if (e.dataTransfer.files.length > 0) { document.getElementById('pdf-upload').files = e.dataTransfer.files; document.getElementById('pdf-upload').dispatchEvent(new Event('change')); }});

            document.getElementById("pdf-upload").addEventListener("change", parsearPdf);
            document.getElementById("unificarBtnPdf").addEventListener("click", () => unificarContratos(false));
            document.getElementById('addManualBtn').addEventListener('click', adicionarContratoManual); // Corrigido de addManualLoanBtn para addManualBtn para corresponder ao HTML
            document.getElementById('convenioSelect').addEventListener('change', atualizarOperacoes);
            document.getElementById('operacaoSelect').addEventListener('change', atualizarVisibilidadeUI);
            
            document.getElementById("calcForm").addEventListener("submit", function (e) {
                e.preventDefault(); // Previne o envio real do formulário
                
                // Validação HTML nativa (required) será acionada primeiro.
                // Se o formulário for válido, o JS abaixo é executado.
                
                const operacao = document.getElementById('operacaoSelect').value;
                if (operacao.includes('negativado')) { 
                    calcularNegativado();
                } else {
                    calcularSimulacaoCompleta();
                }
            });
            
            document.getElementById('goToPortabilidadeBtn').addEventListener('click', () => {
                sessionStorage.setItem('calculoNegativadoData', JSON.stringify(calculoDetalhado));
                const convenio = document.getElementById('convenioSelect').value;
                const opValue = (convenio === 'exercito') ? 'portabilidade_exercito' : 'portabilidade_siape';
                document.getElementById('convenioSelect').value = convenio;
                document.getElementById('operacaoSelect').value = opValue;
                
                atualizarOperacoes(); // Atualiza o select
                document.getElementById('operacaoSelect').value = opValue; // Garante a seleção
                verificarDadosNegativado();
                atualizarVisibilidadeUI();
                document.getElementById('page-container').scrollIntoView({ behavior: 'smooth' });
            });
            
            document.getElementById('goToCompraBtn').addEventListener('click', () => {
                sessionStorage.setItem('calculoNegativadoData', JSON.stringify(calculoDetalhado));
                const convenio = document.getElementById('convenioSelect').value;
                const opValue = (convenio === 'exercito') ? 'compra_exercito' : 'compra_siape';
                document.getElementById('convenioSelect').value = convenio;
                
                atualizarOperacoes(); // Atualiza o select
                document.getElementById('operacaoSelect').value = opValue; // Garante a seleção
                verificarDadosNegativado();
                atualizarVisibilidadeUI();
                document.getElementById('page-container').scrollIntoView({ behavior: 'smooth' });
            });
            
            document.querySelectorAll('input[name="quitacao"]').forEach(r => r.addEventListener('change', function() { document.getElementById('quitadoContainer').style.display = this.value === 'sim' ? 'block' : 'none'; if(this.value === 'nao') document.getElementById('valorQuitado').value = ''; }));

            verificarDadosNegativado();
            atualizarOperacoes(); 
        });

    </script>
</body>

</html>