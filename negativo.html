<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Cliente Negativado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/images/icone.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: bisque; }
        .btn-voltar { position: fixed; top: 15px; left: 15px; background: #6c757d; color: white; padding: 6px 12px; border-radius: 8px; text-decoration: none; font-size: 0.9rem; z-index: 1000; }
        .container { max-width: 600px; margin: auto; }
        form { border: 1px solid #ddd; padding: 20px; border-radius: 10px; background-color: #fff; margin-bottom: 20px; }
        input, select { width: 100%; padding: 6px; margin-top: 4px; border-radius: 8px; font-size: 0.95rem; }
        .resultado { margin-top: 20px; padding: 15px; background: #f1f1f1; border-radius: 8px; }
        .upload-area { border: 2px dashed #0d6efd; padding: 25px; text-align: center; cursor: pointer; background-color: #f8f9fa; margin-bottom: 20px; }
        #pdf-upload { display: none; }
        .loan-list-item { display: flex; align-items: flex-start; padding: 10px; border-bottom: 1px solid #ddd; }
        .loan-details { margin-left: 10px; font-size: 0.9rem; }
        #infoCliente { padding-bottom: 10px; margin-bottom: 15px; border-bottom: 2px solid #ddd; }
        .section-divider { text-align: center; border-bottom: 1px solid #ccc; line-height: 0.1em; margin: 25px 0; }
        .section-divider span { background: bisque; padding: 0 10px; color: #6c757d; }
    </style>
</head>
<body>
    <a href="index.html" class="btn-voltar">← Voltar</a>
    <div class="container">
        <h1 class="text-center">Calculadora de Cliente Negativado</h1>
        <div class="text-center mb-4">
            <img src="/images/logoheader.png" class="mx-auto" style="max-width:200px;">
        </div>

        <div id="upload-container">
            <h2 class="text-center fs-4 my-3">1. Carregar Extrato (Opcional)</h2>
            <input type="file" id="pdf-upload" accept=".pdf">
            <label for="pdf-upload" class="upload-area" id="upload-label">Clique aqui para ler dados do PDF</label>
            <p id="loading" class="text-center" style="display:none;">Analisando...</p>
        </div>

        <div class="resultado" id="listaEmprestimos" style="display:none;"></div>
        <div id="selecionar-todos-container" class="form-check my-2" style="display:none;">
            <input class="form-check-input" type="checkbox" id="selecionarTodos">
            <label class="form-check-label" for="selecionarTodos">Selecionar Todas as Parcelas</label>
        </div>
        <div id="unificar-container-pdf" class="text-center" style="display:none; margin: 15px auto;">
            <button id="unificarBtnPdf" class="btn btn-info w-100">Usar Parcelas Selecionadas no Cálculo</button>
        </div>

        <div class="section-divider"><span>OU</span></div>

        <form id="Negativado">
            <h2 class="text-center fs-4 my-3">2. Preencher Dados</h2>
              <div class="row mb-3">
                  <div class="col-md-6 mb-2">
                      <label for="clienteNomeManual">Nome do Cliente</label>
                      <input type="text" id="clienteNomeManual" class="form-control">
                  </div>
                  <div class="col-md-6 mb-2">
                      <label for="clienteCpfManual">CPF do Cliente</label>
                      <input type="text" id="clienteCpfManual" class="form-control" placeholder="000.000.000-00">
                  </div>
              </div>
            
            <div id="manual-loan-entry" class="p-3 mb-3" style="border: 1px solid #ccc; border-radius: 8px;">
                <h3 class="fs-5 text-center mb-3">Adicionar Contratos Manualmente</h3>
                <div class="row g-2">
                    <div class="col-md-7 mb-2">
                        <label for="manualBanco">Banco</label>
                        <input type="text" id="manualBanco" class="form-control" placeholder="Nome do Banco">
                    </div>
                    <div class="col-md-5 mb-2">
                        <label for="manualParcela">Valor da Parcela</label>
                        <input type="text" id="manualParcela" class="form-control" placeholder="Ex: 291,54">
                    </div>
                    <div class="col-6 col-md-4 mb-2">
                        <label for="manualTotalParcelas">Total de Parcelas</label>
                        <input type="number" id="manualTotalParcelas" class="form-control" placeholder="Ex: 84" value="96">
                    </div>
                    <div class="col-6 col-md-4 mb-2">
                        <label for="manualParcelasPagas">Parcelas Pagas</label>
                        <input type="number" id="manualParcelasPagas" class="form-control" placeholder="Ex: 20">
                    </div>
                    <div class="col-12 col-md-4 d-flex align-items-end mb-2">
                        <button type="button" id="addManualLoanBtn" class="btn btn-secondary w-100">Adicionar Contrato</button>
                    </div>
                </div>
                <div id="manual-loans-list" class="mt-3"></div>
            </div>
            <p class="mt-3 mb-1"><strong>Soma das parcelas:</strong> <span id="totalParcelasDisplay">R$ 0,00</span></p>

            <label class="mt-3">Valor Negativo do Cliente</label>
            <input type="text" id="negativo" class="form-control" required placeholder="Ex: 1000,00">

            <button class="btn btn-success w-100 mt-3" type="submit">Calcular Nova Parcela</button>
        </form>

        <div class="resultado" id="resultado" style="display:none;"></div>
        
        <div id="redirect-buttons-container" class="mt-3 d-grid gap-2" style="display:none;">
            <button class="btn btn-primary" id="goToPortabilidadeBtn">Ir para a Portabilidade com este resultado</button>
            <button class="btn btn-secondary" id="goToCompraBtn">Ir para a Compra de Dívida com este resultado</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
        let totalSaldoDevedorPDF = 0;
        let totalParcelaPDF = 0;
        let resultadoCalculo = {};
        let clienteNomePDF = '', clienteCpfPDF = '';
        let parcelasManuais = []; // Array para guardar os contratos manuais

        function moedaParaFloat(v) { return parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0; }
        function formatarMoeda(v) { return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }

        document.getElementById("pdf-upload").addEventListener("change", async function(event) {
            // ... (código de leitura de PDF continua o mesmo)
        });

        if (document.getElementById("selecionarTodos")) {
            document.getElementById("selecionarTodos").addEventListener("change", function(e) {
                document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
        }

        if (document.getElementById("unificarBtnPdf")) {
            document.getElementById("unificarBtnPdf").addEventListener("click", function() {
                totalParcelaPDF = 0;
                totalSaldoDevedorPDF = 0;
                const checkboxes = document.querySelectorAll('.loan-checkbox:checked');
                if (checkboxes.length === 0) return alert("Selecione pelo menos uma parcela.");
                checkboxes.forEach(cb => {
                    totalParcelaPDF += parseFloat(cb.dataset.parcela);
                    totalSaldoDevedorPDF += parseFloat(cb.dataset.saldo);
                });
                document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcelaPDF);
                document.getElementById("Negativado").scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        // ======================= NOVAS FUNÇÕES PARA LÓGICA MANUAL =======================
        function renderizarListaManual() {
            const listaDiv = document.getElementById('manual-loans-list');
            let totalParcelasManuais = 0;
            listaDiv.innerHTML = '';
            if (parcelasManuais.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group';
                parcelasManuais.forEach((p, index) => {
                    totalParcelasManuais += p.parcela;
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<div><strong>${p.banco}</strong> - ${formatarMoeda(p.parcela)}<br><small class="text-muted">Status: ${p.parcelasPagas} de ${p.totalParcelas}</small></div><button type="button" class="btn btn-danger btn-sm" onclick="removerParcelaManual(${index})">Remover</button>`;
                    ul.appendChild(li);
                });
                listaDiv.appendChild(ul);
            }
            document.getElementById("totalParcelasDisplay").textContent = formatarMoeda(totalParcelasManuais);
        }

        function removerParcelaManual(index) {
            parcelasManuais.splice(index, 1);
            renderizarListaManual();
        }

        document.getElementById('addManualLoanBtn').addEventListener('click', () => {
            const banco = document.getElementById('manualBanco').value || 'Banco não informado';
            const parcelaValor = moedaParaFloat(document.getElementById('manualParcela').value);
            const totalParcelas = parseInt(document.getElementById('manualTotalParcelas').value, 10);
            const parcelasPagas = parseInt(document.getElementById('manualParcelasPagas').value, 10);

            if (parcelaValor > 0 && totalParcelas > 0 && parcelasPagas >= 0) {
                if (parcelasPagas > totalParcelas) {
                    alert("O número de parcelas pagas não pode ser maior que o total de parcelas.");
                    return;
                }
                parcelasManuais.push({ banco, parcela: parcelaValor, totalParcelas, parcelasPagas });
                document.getElementById('manualBanco').value = '';
                document.getElementById('manualParcela').value = '';
                document.getElementById('manualTotalParcelas').value = '';
                document.getElementById('manualParcelasPagas').value = '';
                renderizarListaManual();
            } else {
                alert("Por favor, preencha os campos de valor e parcelas corretamente.");
            }
        });
        // ======================= FIM DAS NOVAS FUNÇÕES =======================

        document.getElementById("Negativado").addEventListener("submit", function(e) {
            e.preventDefault();
            
            let totalParcelas = 0;
            let saldoFinal = 0;

            // Prioriza os dados do PDF se tiverem sido carregados
            if (totalSaldoDevedorPDF > 0) {
                totalParcelas = totalParcelaPDF;
                saldoFinal = totalSaldoDevedorPDF;
            } else { // Caso contrário, calcula com base nos dados manuais
                let saldoManual = 0;
                parcelasManuais.forEach(p => {
                    totalParcelas += p.parcela;
                    const parcelasRestantes = p.totalParcelas - p.parcelasPagas;
                    if (parcelasRestantes > 0) {
                        saldoManual += p.parcela * parcelasRestantes * 0.70;
                    }
                });
                saldoFinal = saldoManual;
            }

            if (totalParcelas === 0) {
                alert("Adicione pelo menos um contrato (via PDF ou manualmente) para calcular.");
                return;
            }

            let negativo = moedaParaFloat(document.getElementById("negativo").value);
            let novaParcela = totalParcelas - negativo;
            
            const nomeFinal = document.getElementById('clienteNomeManual').value.trim() || clienteNomePDF;
            const cpfFinal = document.getElementById('clienteCpfManual').value.trim() || clienteCpfPDF;

            resultadoCalculo = { totalParcelas, negativo, novaParcela, saldoDevedor: saldoFinal, nome: nomeFinal, cpf: cpfFinal };

            document.getElementById("resultado").style.display = "block";
            document.getElementById("resultado").innerHTML = `<h2>Resultado</h2>
                <p><strong>Total Parcelas Originais:</strong> ${formatarMoeda(totalParcelas)}</p>
                <p><strong>Valor Negativo:</strong> ${formatarMoeda(negativo)}</p>
                <p><strong>Saldo Devedor Aprox. para Cálculo:</strong> ${formatarMoeda(saldoFinal)}</p>
                <hr>
                <p><strong>Nova Parcela para Cálculo:</strong> ${formatarMoeda(novaParcela)}</p>`;
            document.getElementById("redirect-buttons-container").style.display = "grid";
        });

        document.getElementById("goToPortabilidadeBtn").addEventListener("click", function() {
            sessionStorage.setItem('calculoNegativadoData', JSON.stringify(resultadoCalculo));
            window.location.href = '/siape/port-auto.html';
        });

        document.getElementById("goToCompraBtn").addEventListener("click", function() {
            sessionStorage.setItem('calculoNegativadoData', JSON.stringify(resultadoCalculo));
            window.location.href = '/siape/compra.html';
        });
    </script>
</body>
</html>