<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Portabilidade</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="icone.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: bisque; }
        .btn-voltar { position: fixed; top: 15px; left: 15px; background: #6c757d; color: white; padding: 6px 12px; border-radius: 8px; text-decoration: none; font-size: 0.9rem; z-index: 1000; }
        .container { max-width: 600px; margin: auto; }
        form { border: 1px solid #ddd; padding: 20px; border-radius: 10px; background-color: #fff; margin-bottom: 20px; }
        input, select { width: 100%; padding: 6px; margin-top: 4px; border-radius: 8px; font-size: 0.95rem; }
        .resultado { margin-top: 20px; padding: 15px; background: #f1f1f1; border-radius: 8px; }
        .upload-area { border: 2px dashed #0d6efd; padding: 25px; text-align: center; cursor: pointer; background-color: #f8f9fa; margin-bottom: 20px; }
        #pdf-upload { display: none; }
        .loan-list-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <a href="index.html" class="btn-voltar">← Voltar</a>
    <div class="container">
        <h1 class="text-center">Calculadora de Portabilidade</h1>
        <div class="text-center"><img src="logoheader.png" class="mx-auto" style="max-width: 200px;"></div>

        <div id="upload-container">
            <h2 class="text-center fs-4 my-3">Carregar Extrato (Opcional)</h2>
            <input type="file" id="pdf-upload" accept=".pdf">
            <label for="pdf-upload" class="upload-area" id="upload-label">Clique aqui para ler dados do PDF</label>
            <p id="loading" class="text-center" style="display:none;">Analisando...</p>
        </div>

        <div class="resultado" id="listaEmprestimos" style="display:none;"></div>
        <div id="unificar-container-pdf" class="text-center" style="display:none; margin: 15px auto;">
            <button id="unificarBtnPdf" class="btn btn-success w-100">Unificar Parcelas Selecionadas</button>
        </div>

        <form id="calcForm1">
            <h2 class="text-center fs-4 mb-3">Dados da Simulação</h2>
            <label>Valor da Parcela (ou Soma)</label>
            <input type="text" id="parcela" required placeholder="Ex: 1.157,55">

            <label>Saldo Devedor (ou Soma)</label>
            <input type="text" id="saldodevedor" required placeholder="Ex: 20.000,00">

            <label>Valor a Descontar</label>
            <input type="text" id="desconto" placeholder="Ex: 1.000,00">

            <label>A agência do cliente é DF?</label>
            <select id="agencia" required>
                <option value="sim">Sim</option>
                <option value="nao">Não</option>
            </select>
            <button class="btn btn-primary w-100 mt-3" type="submit">Calcular Valor Geral</button>
        </form>

        <div class="resultado" id="resultadoParcial" style="display:none;"></div>

        <form id="calcForm2" style="display:none;">
            <label>Comissão Final do Escritório</label>
            <input type="text" id="comissaoesc" required placeholder="Ex: 500,00">
            <button class="btn btn-primary" type="submit">Calcular Oferta </button>
        </form>

        <div class="resultado" id="resultadoFinal" style="display:none;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        function moedaParaFloat(valor) {
            const valorString = String(valor || '');
            const valorLimpo = valorString.replace(/\./g, "").replace(",", ".");
            return parseFloat(valorLimpo) || 0;
        }

        function formatarMoeda(valor) {
            return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }
        
        const formatarInputMoeda = (v) => {
            return v.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        };
        
        let valorGeral = 0;

        document.getElementById("pdf-upload").addEventListener("change", async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById("loading").style.display = "block";
            
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');

                const tabelaInicioMarker = "Número do Contrato Rubrica Sequência";
                const tabelaInicioIndex = text.indexOf(tabelaInicioMarker);
                if (tabelaInicioIndex === -1) {
                    alert("Tabela de empréstimos não localizada.");
                    document.getElementById("loading").style.display = "none";
                    return;
                }
                const textoTabela = text.substring(tabelaInicioIndex);
                const rgxEmprestimos = /(\d{5}\s*-\s*[A-Z\s\-\/]+?)\s+\d+\s+\d+\s+.*?R\$\s*([\d\.,]+)\s+(\d{1,2}\/\d{2,3})/g;
                let matches = [...textoTabela.matchAll(rgxEmprestimos)];
                
                const listaDiv = document.getElementById("listaEmprestimos");
                listaDiv.innerHTML = `<h3 class="fs-5 text-center mb-3">Selecione os Contratos para Unificar</h3>`;
                
                matches.forEach((match, index) => {
                    const [_, rubrica, valor, parcelasStr] = match;
                    const [pagas, total] = parcelasStr.split('/');
                    const nomeBanco = rubrica.replace(/\d{5}\s*-\s*/, '').trim();
                    const valorParcelaNum = moedaParaFloat(valor);
                    const saldoAtualNum = valorParcelaNum * (parseInt(total) - parseInt(pagas));

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'loan-list-item';
                    itemDiv.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input loan-checkbox" type="checkbox" 
                                   data-saldo="${saldoAtualNum}" 
                                   data-parcela="${valorParcelaNum}"
                                   id="loan-${index}">
                            <label class="form-check-label" for="loan-${index}">
                                <strong>${nomeBanco}</strong><br>
                                <small>Saldo: ${formatarMoeda(saldoAtualNum)} | Parcela: ${formatarMoeda(valorParcelaNum)} | Status: ${pagas} de ${total}</small>
                            </label>
                        </div>
                    `;
                    listaDiv.appendChild(itemDiv);
                });
                document.getElementById("loading").style.display = "none";
                listaDiv.style.display = "block";
                document.getElementById("unificar-container-pdf").style.display = "block";
            };
            fileReader.readAsArrayBuffer(file);
        });

        document.getElementById("unificarBtnPdf").addEventListener("click", function() {
            const checkboxes = document.querySelectorAll('.loan-checkbox:checked');
            let totalSaldo = 0;
            let totalParcela = 0;
            if (checkboxes.length === 0) {
                alert("Por favor, selecione pelo menos uma parcela do PDF para unificar.");
                return;
            }
            checkboxes.forEach(cb => {
                totalSaldo += parseFloat(cb.dataset.saldo);
                totalParcela += parseFloat(cb.dataset.parcela);
            });
            
            preencherFormulario(totalParcela, totalSaldo);
        });

        function preencherFormulario(parcela, saldo) {
            document.getElementById("parcela").value = formatarInputMoeda(parseFloat(parcela));
            document.getElementById("saldodevedor").value = formatarInputMoeda(parseFloat(saldo));
            document.getElementById("calcForm1").scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById("calcForm1").addEventListener("submit", function (e) {
            e.preventDefault();
            let parcela = moedaParaFloat(document.getElementById("parcela").value);
            let saldoDevedor = moedaParaFloat(document.getElementById("saldodevedor").value);
            let desconto = moedaParaFloat(document.getElementById("desconto").value);
            let agencia = document.getElementById("agencia").value;

            // --- LÓGICA DE CÁLCULO ORIGINAL DA PORTABILIDADE ---
            const COEFICIENTE = 0.0190;
            let novoSaldo = parcela / COEFICIENTE;
            let saldoSubtracao = novoSaldo - saldoDevedor - desconto;
            let taxaGerente = (agencia === "sim") ? 0.15 : 0.30;
            let gerente = saldoSubtracao * taxaGerente;
            valorGeral = saldoSubtracao - gerente;

            document.getElementById("resultadoParcial").style.display = "block";
            document.getElementById("resultadoParcial").innerHTML = `
                <h2>Resultado Parcial</h2>
                <p><strong>Valor da Parcela (Total):</strong> ${formatarMoeda(parcela)}</p>
                <p><strong>Saldo Devedor (Total):</strong> ${formatarMoeda(saldoDevedor)}</p>
                <p><strong>Valor Geral Bruto:</strong> ${formatarMoeda(saldoSubtracao)}</p>
                <p><strong>Comissão do Gerente (${taxaGerente * 100}%):</strong> ${formatarMoeda(gerente)}</p>
                <p><strong>Valor Geral Líquido:</strong> ${formatarMoeda(valorGeral)}</p>
            `;
            document.getElementById("calcForm2").style.display = "block";
        });

        document.getElementById("calcForm2").addEventListener("submit", function (e) {
            e.preventDefault();
            let comissaoEsc = moedaParaFloat(document.getElementById("comissaoesc").value);
            let oferta = valorGeral - comissaoEsc;
            document.getElementById("resultadoFinal").style.display = "block";
            document.getElementById("resultadoFinal").innerHTML = `
                <h2>Resultado Final</h2>
                <p><strong>Comissão do Escritório:</strong> ${formatarMoeda(comissaoEsc)}</p>
                <p><strong>Valor para Oferecer ao Cliente:</strong> ${formatarMoeda(oferta)}</p>
            `;
        });
    </script>
</body>
</html>